<!DOCTYPE html>
<html lang="az">
  <head>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
      integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Material anbarƒ± (kq) ‚Ä¢ Maliyy…ô (G…ôlir/X…ôrc, AR/AP) ‚Äî AZN</title>
    <style>
      :root {
        --bg: #0b1020;
        --card: #0f172a;
        --text: #e5e7eb;
        --muted: #94a3b8;
        --border: #27324a;
        --pill: #0b1220;
        --accent: #38bdf8;
        --ok: #22c55e;
        --warn: #f59e0b;
        --bad: #ef4444;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      }
      .app {
        max-width: 1260px;
        margin: 0 auto;
        padding: 20px;
      }
      h1 {
        margin: 0 0 8px;
        font-size: 22px;
      }
      .sub {
        color: var(--muted);
        font-size: 12px;
      }
      .tabs {
        display: flex;
        gap: 25px;
        flex-wrap: wrap;
        margin: 12px 0 16px;
      }
      .tab-group {
        display: flex;
        flex-direction: column;
        flex: 1;
        row-gap: 10px;
      }
      .tab {
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #0b1220;
        color: #cbd5e1;
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
      }
      .tab.active {
        background: linear-gradient(135deg, #2563eb, #06b6d4);
        color: #fff;
        border: none;
      }

      .grid {
        display: grid;
        gap: 12px;
      }

      .payment-btn {
        cursor: pointer;
        transition: all;
        transition-duration: 0.3s;
      }
      .payment-btn:hover {
        transform: scale(1.5);
      }
      .cols-2 {
        grid-template-columns: repeat(2, 1fr);
      }
      .cols-3 {
        grid-template-columns: repeat(3, 1fr);
      }
      .cols-4 {
        grid-template-columns: repeat(4, 1fr);
      }
      @media (max-width: 1024px) {
        .cols-3 {
          grid-template-columns: repeat(2, 1fr);
        }
        .cols-2 {
          grid-template-columns: repeat(1, 1fr);
        }
        .cols-2 > .card {
          overflow-x: auto;
        }
      }
      @media (max-width: 720px) {
        .app {
          padding: 12px;
        }
        h1 {
          font-size: 18px;
        }
        .sub {
          font-size: 11px;
        }

        .card.kpi {
          padding: 8px;
        }

        .card.kpi .val {
          font-weight: normal;
        }

        .cols-4 {
          grid-template-columns: repeat(2, 1fr);
        }

        .cols-3 {
          grid-template-columns: 1fr;
        }
        .tab {
          padding: 8px 12px;
          font-size: 13px;
        }
        .card {
          padding: 12px;
        }
        .kpi .val {
          font-size: 18px;
        }
        table {
          font-size: 12px;
          display: block;
          overflow-x: auto;
          white-space: nowrap;
        }
        th,
        td {
          padding: 8px 6px;
          font-size: 12px;
        }
        .row.wrap {
          flex-direction: column;
        }
        .row.wrap > div {
          flex: 1 1 100% !important;
          width: 100%;
        }
        input,
        select,
        textarea,
        button {
          font-size: 16px;
        }
        .tabs {
          gap: 15px;
        }
      }
      @media (max-width: 480px) {
        .app {
          padding: 8px;
        }
        h1 {
          font-size: 16px;
        }
        .kpi .val {
          font-size: 16px;
        }
        .badge {
          font-size: 10px;
        }
        .tabs {
          gap: 10px;
        }
        .row > div {
          flex: 1;
          min-width: 150px;
        }
      }
      @media (max-width: 400px) {
        .tab {
          padding: 8px 6px;
        }

        .row > div {
          min-width: auto;
        }
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 14px;
      }
      .kpi {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .kpi .val {
        font-size: 22px;
        font-weight: 800;
      }
      .muted {
        color: var(--muted);
      }
      .tiny {
        font-size: 11px;
        color: var(--muted);
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .row.wrap {
        flex-wrap: wrap;
      }
      label {
        font-size: 12px;
        color: var(--muted);
        display: block;
        margin-bottom: 6px;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #0b1220;
        color: var(--text);
      }
      textarea {
        min-height: 72px;
        resize: none;
      }
      button {
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #0b1220;
        color: var(--text);
        cursor: pointer;
      }
      button.primary {
        background: linear-gradient(135deg, #2563eb, #06b6d4);
        border: none;
        color: #fff;
      }
      button.ghost {
        background: transparent;
      }
      .danger {
        color: #fecaca;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        text-align: left;
        padding: 10px;
        border-bottom: 1px dashed var(--border);
        font-size: 14px;
      }
      th {
        color: var(--muted);
        font-weight: 700;
        white-space: nowrap;
      }
      .right {
        text-align: right;
      }
      .badge {
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--pill);
        font-size: 12px;
      }
      .badge.ok {
        color: var(--ok);
        border-color: #22c55e30;
        background: #22c55e10;
      }
      .badge.warn {
        color: var(--warn);
        border-color: #f59e0b30;
        background: #f59e0b10;
      }
      .badge.bad {
        color: var(--bad);
        border-color: #ef444430;
        background: #ef444410;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .pill {
        border: 1px solid var(--border);
        background: var(--pill);
        border-radius: 999px;
        padding: 6px 10px;
        display: inline-flex;
        gap: 8px;
        align-items: center;
      }
      .divider {
        height: 1px;
        background: var(--border);
        margin: 12px 0;
      }
      .foot {
        margin-top: 12px;
        color: var(--muted);
        font-size: 12px;
      }
      .section-title {
        font-size: 16px;
        font-weight: 800;
        margin-bottom: 10px;
      }
      .loader {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 2px solid #ffffff25;
        border-top-color: #06b6d4;
        animation: spin 1s linear infinite;
        display: inline-block;
      }
      .grid.cols-2 .card {
        height: fit-content;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      input.filter-input {
        width: 100% !important;
      }

      .filter-inputs-container > div,
      .filter-inputs-container > div > * {
        flex-shrink: 1;
        min-width: 0;
        width: 50%;
      }

      .checkbox-container {
        display: flex;
        flex-direction: column;
      }

      .checkbox-container > * {
        width: 100%;
        flex: 1;
        min-width: 0;
        flex-shrink: 1;
      }

      .type-check-container {
        display: flex;
        justify-content: space-between;
        width: 100%;
        column-gap: 30px;
      }

      /* Paymment modal */
      .payment-overlay {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        background: rgba(17, 24, 39, 0.6);
        backdrop-filter: blur(4px);
        z-index: 9999;
        opacity: 0;
        pointer-events: none;
        transition: opacity 200ms ease;
      }

      .payment-overlay.open {
        opacity: 1;
        pointer-events: auto;
      }

      .payment-modal {
        width: min(90vw, 420px);
        background: #ffffff;
        border-radius: 18px;
        padding: 1.5rem;
        box-shadow: 0 25px 70px rgba(15, 23, 42, 0.25);
        transform: translateY(10px) scale(0.96);
        animation: modalPop 220ms ease forwards;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      @keyframes modalPop {
        to {
          transform: translateY(0) scale(1);
        }
      }

      .payment-modal h2 {
        margin: 0;
        font-size: 1.25rem;
        color: #111827;
      }

      .payment-list {
        margin: 0;
        padding: 0;
        list-style: none;
        max-height: 260px;
        overflow-y: auto;
      }

      .payment-item {
        padding: 0.75rem 0;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        font-size: 0.95rem;
        color: #1f2937;
      }

      .payment-empty {
        padding: 1rem;
        text-align: center;
        color: #6b7280;
        border: 1px dashed #d1d5db;
        border-radius: 12px;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
      }

      .close-btn {
        padding: 0.55rem 1.4rem;
        border: none;
        border-radius: 999px;
        background: #0ea5e9;
        color: #fff;
        font-weight: 600;
        cursor: pointer;
        transition: all 150ms ease;
      }

      .close-btn:hover {
        background: #0284c7;
      }

      @media (max-width: 480px) {
        .payment-modal {
          padding: 1.25rem;
        }
      }

      @media screen and (max-width: 420px) {
        .muted {
          font-size: 14px;
        }

        .val {
          font-size: 18px;
        }
      }

      @media screen and (max-width: 353px) {
        .filter-inputs-container {
          flex-wrap: wrap;
        }
      }

      .scrollable::-webkit-scrollbar {
        width: 8px;
      }

      .scrollable::-webkit-scrollbar-track {
        background: #0f172a;
        border-radius: 8px;
      }

      .scrollable::-webkit-scrollbar-thumb {
        background: #334155;
        border-radius: 8px;
      }

      .scrollable::-webkit-scrollbar-thumb:hover {
        background: #475569;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <h1>Material anbarƒ± (kq) + Maliyy…ô (AR/AP)</h1>
      <div class="sub">
        Valyuta: <b>AZN (‚Çº)</b> ‚Ä¢ √ñl√ß√º vahidi: <b>kq</b> ‚Ä¢ Backend API:
        <b id="baseUrl">http://116.203.51.133:8085/stock</b>
      </div>

      <!-- KPI -->
      <div class="grid cols-4" style="margin-top: 12px">
        <div class="card kpi">
          <div>
            <div class="muted">Material qalƒ±ƒüƒ±</div>
            <div class="val" id="kpiOnHandKg">0</div>
          </div>
          <span class="badge">kq</span>
        </div>
        <div class="card kpi">
          <div>
            <div class="muted">ƒ∞nventar d…ôy…ôri</div>
            <div class="val" id="kpiInvValue">‚Çº 0</div>
          </div>
          <span class="badge">AZN</span>
        </div>
        <div class="card kpi">
          <div>
            <div class="muted">D√∂v√ºr √ºzr…ô g…ôlir</div>
            <div class="val" id="kpiRevenue">‚Çº 0</div>
          </div>
          <span class="badge">AZN</span>
        </div>
        <div class="card kpi">
          <div>
            <div class="muted">D√∂v√ºr √ºzr…ô xalis m…ônf…ô…ôt</div>
            <div class="val" id="kpiNet">‚Çº 0</div>
          </div>
          <span class="badge ok" id="kpiNetBadge">OK</span>
        </div>
      </div>

      <div class="tabs" id="tabs"></div>
      <div id="view"></div>

      <div class="foot">
        M…ôsl…ôh…ôt: …ôvv…ôlc…ô material kataloqunu …ôlav…ô edin, sonra g…ôl…ôn v…ô silin…ôn
        qeydl…ôri yaradƒ±n.
      </div>
    </div>

    <script>
      // ====== KONFƒ∞GURASƒ∞YA ======
      const BASE = "http://116.203.51.133:8085/stock";
      const API_HEADERS = {
        "Content-Type": "application/json",
      };

      // helperl…ôr
      const $ = (s) => document.querySelector(s);
      const fmtN = (n, d = 2) =>
        (n ?? 0).toLocaleString(undefined, { maximumFractionDigits: d });
      const fmtMoney = (n) => `‚Çº ${fmtN(n, 2)}`;
      const today = () => new Date().toISOString().slice(0, 10);

      // TABS - ƒ∞STEHSAL V∆è ƒ∞STEHSAL ANBARI Sƒ∞Lƒ∞NDƒ∞
      const TABS = {
        warehouse: [
          { id: "materials", name: "Materiallar" },
          { id: "receipt", name: "Q…ôbul" },
          { id: "issue", name: "Silm…ô" },
          { id: "stock", name: "Anbar" },
        ],

        products: [
          { id: "products", name: "M…ôhsullar" },
          { id: "storetransfer", name: "Maƒüazaya K√∂√ß√ºrm…ô" },
          { id: "storestock", name: "Maƒüaza Anbarƒ±" },
          { id: "storesales", name: "Satƒ±≈ülar" },
        ],

        finance: [
          { id: "finance", name: "Maliyy…ô (G…ôlir/X…ôrc)" },
          { id: "arap", name: "Borclu/Borc (AR/AP)" },
          { id: "reports", name: "Hesabatlar" },
        ],
      };
      let currentTab = "materials";

      // APP STATE
      const APP = {
        materials: [],
        receipts: [],
        issues: [],
        stock: [],
        products: [],
        productionStock: [],
        storeTransfers: [],
        storeStock: [],
        storeSales: [],
        finances: [],
        ar: [],
        ap: [],
        kpi: null,
      };

      // render tabs
      function renderTabs() {
        $("#tabs").innerHTML = Object.entries(TABS)
          .map(([groupName, tabs]) => {
            return `
              <div class="tab-group">
                  ${tabs
                    .map(
                      (t) =>
                        `<button class="tab ${
                          currentTab === t.id ? "active" : ""
                        }" onclick="switchTab('${t.id}')">${t.name}</button>`
                    )
                    .join("")}
              </div>
            `;
          })
          .join("");
      }

      async function switchTab(id) {
        currentTab = id;
        renderTabs();

        // Loading g√∂st…ôr
        $("#view").innerHTML =
          '<div class="card" style="text-align:center;padding:40px;"><div class="loader"></div><div style="margin-top:12px;">Y√ºkl…ônir...</div></div>';

        try {
          // avtomatik fetch - AWAIT il…ô
          if (id === "materials") {
            await fetchMaterials();
          } else if (id === "receipt") {
            await Promise.all([fetchMaterials(), fetchReceipts()]);
          } else if (id === "issue") {
            await Promise.all([fetchMaterials(), fetchIssues()]);
          } else if (id === "stock") {
            await fetchStock();
          } else if (id === "products") {
            await fetchProducts();
          } else if (id === "storetransfer") {
            await Promise.all([fetchProducts(), fetchStoreTransfers()]);
          } else if (id === "storestock") {
            await fetchStoreStock();
          } else if (id === "storesales") {
            await Promise.all([
              fetchProducts(),
              fetchStoreStock(),
              fetchStoreSales(),
            ]);
          } else if (id === "finance") {
            await fetchFinances();
          } else if (id === "arap") {
            await fetchARAP();
          } else if (id === "reports") {
            await Promise.all([
              fetchMaterials(),
              fetchReceipts(),
              fetchIssues(),
            ]);
            await fetchPL();
          }
        } catch (e) {
          console.error("Tab y√ºkl…ônm…ô x…ôtasƒ±:", e);
        }

        // Data y√ºkl…ôndi, indi render et
        renderView();
      }

      // ====== API helpers ======
      async function apiGET(path) {
        try {
          const res = await fetch(BASE + path, {
            method: "GET",
            headers: API_HEADERS,
          });
          if (!res.ok) {
            const text = await res.text().catch(() => "");
            throw new Error(`HTTP ${res.status}: ${text}`);
          }
          return await res.json();
        } catch (e) {
          console.error("GET", path, e);
          alert(`Server x…ôtasƒ± GET ${path}\n${e.message}`);
          throw e;
        }
      }

      async function apiPOST(path, body) {
        try {
          const res = await fetch(BASE + path, {
            method: "POST",
            headers: API_HEADERS,
            body: JSON.stringify(body),
          });
          if (!res.ok) {
            const text = await res.text().catch(() => "");
            throw new Error(`HTTP ${res.status}: ${text}`);
          }
          return await res.json();
        } catch (e) {
          console.error("POST", path, e);
          alert(`Server x…ôtasƒ± POST ${path}\n${e.message}`);
          throw e;
        }
      }

      async function apiPUT(path, body) {
        try {
          const res = await fetch(BASE + path, {
            method: "PUT",
            headers: API_HEADERS,
            body: JSON.stringify(body),
          });
          if (!res.ok) {
            const text = await res.text().catch(() => "");
            throw new Error(`HTTP ${res.status}: ${text}`);
          }
          return await res.json();
        } catch (e) {
          console.error("PUT", path, e);
          alert(`Server x…ôtasƒ± PUT ${path}\n${e.message}`);
          throw e;
        }
      }

      async function apiPATCH(path) {
        try {
          const res = await fetch(BASE + path, {
            method: "PATCH",
            headers: API_HEADERS,
          });
          if (!res.ok) {
            const text = await res.text().catch(() => "");
            throw new Error(`HTTP ${res.status}: ${text}`);
          }
          return res.status === 204 ? {} : await res.json();
        } catch (e) {
          console.error("PATCH", path, e);
          alert(`Server x…ôtasƒ± PATCH ${path}\n${e.message}`);
          throw e;
        }
      }

      // ====== FETCH data from server ======
      async function fetchMaterials() {
        try {
          APP.materials = await apiGET("/api/materials");
          if (currentTab === "materials") renderMaterials();
        } catch (e) {}
      }

      async function fetchReceipts() {
        try {
          APP.receipts = await apiGET("/api/receipts");
          if (currentTab === "receipt") renderReceipt();
        } catch (e) {}
      }

      async function fetchIssues() {
        try {
          APP.issues = await apiGET("/api/issues");
          if (currentTab === "issue") renderIssue();
        } catch (e) {}
      }

      async function fetchStock() {
        try {
          APP.stock = await apiGET("/api/stock/snapshot");
          const from = today().slice(0, 7) + "-01";
          const to = today();
          APP.kpi = await apiGET(`/api/stock/kpi?from=${from}&to=${to}`);
          renderStock();
          updateKPIBox();
        } catch (e) {}
      }

      async function fetchFinances() {
        try {
          APP.finances = await apiGET("/api/finances");
          renderFinance();
        } catch (e) {}
      }

      async function fetchARAP() {
        try {
          APP.ar = await apiGET("/api/ar");
          APP.ap = await apiGET("/api/ap");
          renderARAP();
        } catch (e) {}
      }

      async function fetchPL() {
        try {
          const from = $("#rpFrom")
            ? $("#rpFrom").value
            : today().slice(0, 7) + "-01";
          const to = $("#rpTo") ? $("#rpTo").value : today();
          APP.pl = await apiGET(`/api/stock/profit-loss?from=${from}&to=${to}`);
          APP.kpi = await apiGET(`/api/stock/kpi?from=${from}&to=${to}`);
          APP.movements = await apiGET("/api/stock/movements");
          renderReports();
          updateKPIBox();
        } catch (e) {}
      }

      async function fetchProducts() {
        try {
          APP.products = await apiGET("/api/products");
          if (currentTab === "products") renderProducts();
        } catch (e) {}
      }

      async function fetchProductionStock() {
        try {
          APP.productionStock = await apiGET("/api/warehouse-stock");
          console.log(
            "Production Stock y√ºkl…ôndi:",
            APP.productionStock.length,
            "m…ôhsul"
          );
          if (currentTab === "storetransfer") {
            renderView();
          }
        } catch (e) {
          console.error("Production stock fetch x…ôtasƒ±:", e);
          APP.productionStock = [];
        }
      }

      async function fetchStoreTransfers() {
        try {
          APP.storeTransfers = await apiGET("/api/store-transfers");
          if (currentTab === "storetransfer") renderStoreTransfer();
        } catch (e) {}
      }

      async function fetchStoreStock() {
        try {
          APP.storeStock = await apiGET("/api/store-stock");
          if (currentTab === "storestock") renderStoreStock();
        } catch (e) {}
      }

      async function fetchStoreSales() {
        try {
          APP.storeSales = await apiGET("/api/store-sales");
          if (currentTab === "storesales") renderStoreSales();
        } catch (e) {}
      }

      // ====== RENDER / UI funksiyalarƒ± ======
      function updateKPIBox() {
        let onHandKg = 0,
          inv = 0;

        if (Array.isArray(APP.stock) && APP.stock.length) {
          APP.stock.forEach((s) => {
            onHandKg += Number(s.onHandKg || 0);
            inv += Number(s.inventoryValue || 0);
          });
        }

        $("#kpiOnHandKg").textContent = fmtN(onHandKg, 3);
        $("#kpiInvValue").textContent = fmtMoney(inv);

        if (APP.kpi) {
          $("#kpiRevenue").textContent = fmtMoney(APP.kpi.revenue || 0);
          $("#kpiNet").textContent = fmtMoney(APP.kpi.netProfit || 0);
          const badge = $("#kpiNetBadge");
          if ((APP.kpi.netProfit || 0) >= 0) {
            badge.textContent = "OK";
            badge.className = "badge ok";
          } else {
            badge.textContent = "NEG";
            badge.className = "badge bad";
          }
        }
      }

      // --- MATERIALS ---
      function renderMaterials() {
        const list =
          APP.materials
            .map(
              (x) => `
          <tr>
            <td>${x.code || ""}</td>
            <td>${x.name || ""}</td>
            <td>kq</td>
            <td class="right">${fmtN(x.minLevel ?? 0, 3)}</td>
            <td>${
              x.isActive === false
                ? '<span class="badge warn">arxiv</span>'
                : '<span class="badge ok">aktiv</span>'
            }</td>
            <td class="right"><button class="ghost" onclick="toggleMat('${
              x.id
            }')">${
                x.isActive === false ? "Arxivd…ôn √ßƒ±xar" : "Arxivl…ô"
              }</button></td>
          </tr>`
            )
            .join("") ||
          '<tr><td colspan="6" class="tiny">Material yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Material b…ôl…ôd√ßisi</div>
              <div class="row wrap">
                <div style="flex:1 1 150px;"><label>Kod</label><input id="mCode" placeholder="MTL-001"></div>
                <div style="flex:2 1 260px;"><label>Ad</label><input id="mName" placeholder="Poliamid qranul"></div>
                <div style="flex:1 1 120px;"><label>Minimum qalƒ±q (kq)</label><input id="mMin" type="number" step="0.001" value="0"></div>
              </div>
              <div class="row" style="justify-content:flex-end;margin-top:8px;">
                <button class="primary" onclick="addMaterial()">Material …ôlav…ô et</button>
              </div>
            </div>
            <div class="card">
              <div class="section-title">Materiallar</div>
              <table>
                <thead><tr><th>Kod</th><th>Ad</th><th>Vahid</th><th class="right">Minimum qalƒ±q</th><th>Status</th><th class="right">∆èm…ôliyyatlar</th></tr></thead>
                <tbody>${list}</tbody>
              </table>
            </div>
          </div>`;
      }

      async function addMaterial() {
        const code = $("#mCode").value.trim();
        const name = $("#mName").value.trim();
        const min = Number($("#mMin").value || 0);
        if (!code || !name) {
          alert("Kod v…ô adƒ± daxil edin");
          return;
        }
        try {
          await apiPOST("/api/materials", {
            code,
            name,
            uom: "kg",
            minLevel: min,
            isActive: true,
          });
          await fetchMaterials();
          $("#mCode").value = "";
          $("#mName").value = "";
          $("#mMin").value = "0";
        } catch (e) {}
      }

      async function toggleMat(id) {
        try {
          await apiPATCH(`/api/materials/${id}/toggle`);
          await fetchMaterials();
        } catch (e) {}
      }

      // --- RECEIPTS ---
      function renderReceipt() {
        const options = APP.materials
          .filter((x) => x.isActive !== false)
          .map((x) => `<option value="${x.id}">${x.code} ‚Äî ${x.name}</option>`)
          .join("");

        const items =
          APP.receipts
            .slice()
            .sort((a, b) => (a.date || "").localeCompare(b.date || ""))
            .map((r) => {
              const mat =
                APP.materials.find((m) => m.id === r.materialId) || {};
              return `<tr>
              <td>${r.date}</td>
              <td>${mat.code || ""}</td>
              <td>${mat.name || ""}</td>
              <td class="right">${fmtN(r.qtyKg, 3)}</td>
              <td class="right">${fmtMoney(r.pricePerKg)}</td>
              <td class="right">${fmtMoney(r.totalCost)}</td>
              <td>${r.supplier || ""}</td>
              <td class="tiny">${r.note || ""}</td>
            </tr>`;
            })
            .join("") ||
          '<tr><td colspan="8" class="tiny">Q…ôbul yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Material q…ôbulu</div>
              <div class="row wrap">
                <div style="flex:2 1 260px;"><label>Material</label><select id="rcMat">${options}</select></div>
                <div style="flex:1 1 120px;"><label>Miqdar (kq)</label><input id="rcQty" type="number" step="0.001"></div>
                <div style="flex:1 1 140px;"><label>1 kq √º√ß√ºn qiym…ôt (‚Çº)</label><input id="rcPrice" type="number" step="0.01"></div>
                <div style="flex:1 1 160px;"><label>Tarix</label><input id="rcDate" type="date" value="${today()}"></div>
                <div style="flex:1 1 200px;"><label>T…ôchizat√ßƒ±</label><input id="rcSupplier" placeholder="MMC T…ôchizat√ßƒ±"></div>
              </div>
              <label>≈û…ôrh</label><textarea id="rcNote" placeholder="Partiya/qaim…ô"></textarea>
              <div class="row" style="justify-content:space-between;margin-top:8px;">
                <div class="tiny">C…ôm = kq √ó qiym…ôt/kq</div>
                <button class="primary" onclick="addReceipt()">Q…ôbulu …ôlav…ô et</button>
              </div>
            </div>
            <div class="card">
              <div class="section-title">Son q…ôbullar</div>
              <table>
                <thead><tr><th>Tarix</th><th>Kod</th><th>Material</th><th class="right">kq</th><th class="right">Qiym…ôt/kq</th><th class="right">M…ôbl…ôƒü</th><th>T…ôchizat√ßƒ±</th><th>≈û…ôrh</th></tr></thead>
                <tbody>${items}</tbody>
              </table>
            </div>
          </div>`;
      }

      async function addReceipt() {
        const materialId = $("#rcMat").value;
        const qty = Number($("#rcQty").value);
        const price = Number($("#rcPrice").value);
        const date = $("#rcDate").value || today();
        const supplier = $("#rcSupplier").value.trim();
        const note = $("#rcNote").value.trim();

        if (!materialId || qty <= 0 || price < 0) {
          alert("Material, miqdar (>0) v…ô qiym…ôt (>=0) vacibdir");
          return;
        }

        try {
          await apiPOST("/api/receipts", {
            date,
            materialId,
            qtyKg: qty,
            pricePerKg: price,
            totalCost: qty * price,
            supplier,
            note,
          });
          await fetchReceipts();
          await fetchStock();
          $("#rcQty").value = "";
          $("#rcPrice").value = "";
          $("#rcSupplier").value = "";
          $("#rcNote").value = "";
        } catch (e) {}
      }

      // --- ISSUES ---
      function renderIssue() {
        const options = APP.materials
          .filter((x) => x.isActive !== false)
          .map((x) => `<option value="${x.id}">${x.code} ‚Äî ${x.name}</option>`)
          .join("");

        const items =
          APP.issues
            .slice()
            .sort((a, b) => (a.date || "").localeCompare(b.date || ""))
            .map((i) => {
              const mat =
                APP.materials.find((m) => m.id === i.materialId) || {};
              return `<tr>
              <td>${i.date}</td>
              <td>${mat.code || ""}</td>
              <td>${mat.name || ""}</td>
              <td class="right">${fmtN(i.qtyKg, 3)}</td>
              <td class="right">${fmtMoney(i.avgCostUsed)}</td>
              <td class="right">${fmtMoney(i.totalCostUsed)}</td>
              <td>${i.jobRef || ""}</td>
              <td class="tiny">${i.note || ""}</td>
            </tr>`;
            })
            .join("") ||
          '<tr><td colspan="8" class="tiny">Silm…ô yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Silm…ô / ƒ∞stifad…ô</div>
              <div class="row wrap">
                <div style="flex:2 1 260px;"><label>Material</label><select id="isMat">${options}</select></div>
                <div style="flex:1 1 120px;"><label>Miqdar (kq)</label><input id="isQty" type="number" step="0.001"></div>
                <div style="flex:1 1 160px;"><label>Tarix</label><input id="isDate" type="date" value="${today()}"></div>
                <div style="flex:1 1 200px;"><label>ƒ∞≈ü/Referans</label><input id="isJob" placeholder="#JOB-001"></div>
              </div>
              <label>≈û…ôrh</label><textarea id="isNote" placeholder="S…ôb…ôb/i≈ü√ßi"></textarea>
              <div class="row" style="justify-content:space-between;margin-top:8px;">
                <div class="tiny">Silm…ô x…ôrci = cari orta qiym…ôt √ó kq (server hesablayƒ±r)</div>
                <button class="primary" onclick="addIssue()">Silm…ô …ôlav…ô et</button>
              </div>
            </div>
            <div class="card">
              <div class="section-title">Son silm…ôl…ôr</div>
              <table>
                <thead><tr><th>Tarix</th><th>Kod</th><th>Material</th><th class="right">kq</th><th class="right">Orta qiym…ôt</th><th class="right">M…ôbl…ôƒü</th><th>ƒ∞≈ü</th><th>≈û…ôrh</th></tr></thead>
                <tbody>${items}</tbody>
              </table>
            </div>
          </div>`;
      }

      async function addIssue() {
        const materialId = $("#isMat").value;
        const qty = Number($("#isQty").value);
        const date = $("#isDate").value || today();
        const jobRef = $("#isJob").value.trim();
        const note = $("#isNote").value.trim();

        if (!materialId || qty <= 0) {
          alert("Material v…ô miqdar (>0) vacibdir");
          return;
        }

        try {
          const receipts = APP.receipts.filter(
            (r) => r.materialId === materialId
          );
          const totalQty = receipts.reduce(
            (a, b) => a + Number(b.qtyKg || 0),
            0
          );
          const totalCost = receipts.reduce(
            (a, b) => a + Number(b.totalCost || 0),
            0
          );
          const avgCost = totalQty > 0 ? totalCost / totalQty : 0;

          await apiPOST("/api/issues", {
            date,
            materialId,
            qtyKg: qty,
            avgCostUsed: avgCost,
            totalCostUsed: avgCost * qty,
            jobRef,
            note,
          });
          await fetchIssues();
          await fetchStock();
          $("#isQty").value = "";
          $("#isJob").value = "";
          $("#isNote").value = "";
        } catch (e) {}
      }

      // --- STOCK ---
      function renderStock() {
        const rows =
          (APP.stock || [])
            .map((r) => {
              const health = r.onHandKg <= (r.minLevel || 0) ? "warn" : "ok";
              return `<tr>
            <td>${r.code || ""}</td>
            <td>${r.name || ""}</td>
            <td class="right">${fmtN(r.onHandKg, 3)}</td>
            <td class="right">${fmtMoney(r.avgCostPerKg)}</td>
            <td class="right">${fmtMoney(r.inventoryValue)}</td>
            <td><span class="badge ${health}">${
                r.status === "low" || health === "warn" ? "LOW" : "OK"
              }</span></td>
          </tr>`;
            })
            .join("") ||
          '<tr><td colspan="6" class="tiny">Anbar m…ôlumatƒ± yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="card">
            <div class="section-title">Anbar qalƒ±qlarƒ± (kq)</div>
            <table>
              <thead><tr><th>Kod</th><th>Material</th><th class="right">Varlƒ±qdakƒ± (kq)</th><th class="right">Orta qiym…ôt (‚Çº/kq)</th><th class="right">ƒ∞nventar d…ôy…ôri</th><th>Status</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      }

      // --- FINANCE ---
      function renderFinance() {
        // Filtr funksiyasƒ±
        function filterFinances() {
          const fromDate = $("#fnFilterFrom")?.value;
          const toDate = $("#fnFilterTo")?.value;

          // Checkbox-lardan se√ßilmi≈ü d…ôy…ôrl…ôri toplayƒ±rƒ±q
          const selectedTypes = Array.from(
            document.querySelectorAll('input[name="fnFilterType"]:checked')
          ).map((cb) => cb.value);
          const selectedCategories = Array.from(
            document.querySelectorAll('input[name="fnFilterCategory"]:checked')
          ).map((cb) => cb.value);
          const selectedCounterparties = Array.from(
            document.querySelectorAll(
              'input[name="fnFilterCounterparty"]:checked'
            )
          ).map((cb) => cb.value);

          const minAmount = Number($("#fnFilterMinAmount")?.value || 0);
          const maxAmount = Number($("#fnFilterMaxAmount")?.value || Infinity);

          let filtered = APP.finances.slice();

          // Tarix filtri
          if (fromDate) filtered = filtered.filter((f) => f.date >= fromDate);
          if (toDate) filtered = filtered.filter((f) => f.date <= toDate);

          // Tip filtri
          if (selectedTypes.length > 0) {
            filtered = filtered.filter((f) => selectedTypes.includes(f.type));
          }

          // Kateqoriya filtri
          if (selectedCategories.length > 0) {
            filtered = filtered.filter((f) =>
              selectedCategories.includes(f.category)
            );
          }

          // Kontragent filtri
          if (selectedCounterparties.length > 0) {
            filtered = filtered.filter((f) =>
              selectedCounterparties.includes(f.counterparty)
            );
          }

          // M…ôbl…ôƒü filtri
          filtered = filtered.filter((f) => {
            const amt = f.amountAzn || 0;
            return amt >= minAmount && amt <= maxAmount;
          });

          // Statistika
          const totalIncome = filtered
            .filter((f) => f.type === "income")
            .reduce((a, b) => a + (b.amountAzn || 0), 0);
          const totalExpense = filtered
            .filter((f) => f.type === "expense")
            .reduce((a, b) => a + (b.amountAzn || 0), 0);
          const netProfit = totalIncome - totalExpense;

          $("#fnStatsIncome").textContent = fmtMoney(totalIncome);
          $("#fnStatsExpense").textContent = fmtMoney(totalExpense);
          $("#fnStatsNet").textContent = fmtMoney(netProfit);
          $("#fnStatsNetBadge").className =
            netProfit >= 0 ? "badge ok" : "badge bad";
          $("#fnStatsCount").textContent = filtered.length;

          const list =
            filtered
              .sort((a, b) => (b.date || "").localeCompare(a.date || ""))
              .map(
                (f) => `<tr>
        <td>${f.date}</td>
        <td>${f.type === "income" ? "G…ôlir" : "X…ôrc"}</td>
        <td>${f.category || ""}</td>
        <td>${f.counterparty || ""}</td>
        <td class="right">${fmtMoney(f.amountAzn || 0)}</td>
        <td class="tiny">${f.note || ""}</td>
      </tr>`
              )
              .join("") ||
            '<tr><td colspan="6" class="tiny">Bu filtr…ô uyƒüun qeyd yoxdur</td></tr>';

          $("#financeTableBody").innerHTML = list;
        }

        // Unikal d…ôy…ôrl…ôri √ßƒ±xaraq
        const uniqueCategories = [
          ...new Set(APP.finances.map((f) => f.category).filter(Boolean)),
        ].sort();
        const uniqueCounterparties = [
          ...new Set(APP.finances.map((f) => f.counterparty).filter(Boolean)),
        ].sort();

        // Checkbox-lar il…ô se√ßiml…ôr
        const categoryCheckboxes = uniqueCategories
          .map(
            (c) =>
              `<label style="display:flex;align-items:center;gap:6px;padding:4px 0;cursor:pointer;min-width:0;flex-shrink:1">
      <input type="checkbox" name="fnFilterCategory" value="${c}" style="width:auto;">
      <span style="font-size:13px;">${c}</span>
    </label>`
          )
          .join("");

        const counterpartyCheckboxes = uniqueCounterparties
          .map(
            (c) =>
              `<label style="display:flex;align-items:center;gap:6px;padding:4px 0;cursor:pointer;">
      <input type="checkbox" name="fnFilterCounterparty" value="${c}" style="width:auto;">
      <span style="font-size:13px;">${c}</span>
    </label>`
          )
          .join("");

        // ƒ∞lkin list
        const list =
          (APP.finances || [])
            .slice()
            .sort((a, b) => (b.date || "").localeCompare(a.date || ""))
            .map(
              (f) => `<tr>
      <td>${f.date}</td>
      <td>${f.type === "income" ? "G…ôlir" : "X…ôrc"}</td>
      <td>${f.category || ""}</td>
      <td>${f.counterparty || ""}</td>
      <td class="right">${fmtMoney(f.amountAzn || 0)}</td>
      <td class="tiny">${f.note || ""}</td>
    </tr>`
            )
            .join("") ||
          '<tr><td colspan="6" class="tiny">Qeyd yoxdur</td></tr>';

        // Statistika
        const totalIncome = APP.finances
          .filter((f) => f.type === "income")
          .reduce((a, b) => a + (b.amountAzn || 0), 0);
        const totalExpense = APP.finances
          .filter((f) => f.type === "expense")
          .reduce((a, b) => a + (b.amountAzn || 0), 0);
        const netProfit = totalIncome - totalExpense;

        $("#view").innerHTML = `
    <div class="grid cols-2">
      <div class="card">
        <div class="section-title">G…ôlir / X…ôrc</div>
        <div class="row wrap">
          <div style="flex:1 1 140px;"><label>Tip</label><select id="fnType"><option value="income">G…ôlir</option><option value="expense">X…ôrc</option></select></div>
          <div style="flex:2 1 220px;"><label>Kateqoriya</label><input id="fnCat" placeholder="Kira, logistika, satƒ±≈ü..."></div>
          <div style="flex:1 1 150px;"><label>M…ôbl…ôƒü (‚Çº)</label><input id="fnAmt" type="number" step="0.01"></div>
          <div style="flex:1 1 160px;"><label>Tarix</label><input id="fnDate" type="date" value="${today()}"></div>
          <div style="flex:2 1 220px;"><label>Kontragent</label><input id="fnCp" placeholder="MMC v…ô ya ≈ü…ôxsin adƒ±"></div>
        </div>
        <label>Qeyd</label><textarea id="fnNote"></textarea>
        <div class="row" style="justify-content:flex-end;margin-top:8px;"><button class="primary" onclick="addFinance()">∆èlav…ô et</button></div>
      </div>
      <div class="card">
        <div class="section-title">Qeydl…ôr</div>
        
        <!-- Fƒ∞LTR Sƒ∞STEMƒ∞ -->
        <div style="background:#0b1220;border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:12px;">
          <div style="font-weight:700;margin-bottom:8px;font-size:14px;">üîç Filtr</div>
          <div class="row filter-inputs-container" style="margin-bottom:8px; align-items: flex-end !important;">
            <div class="flex row">
              <div style=""><label>Ba≈ülanƒüƒ±c</label><input class="filter-input" id="fnFilterFrom" type="date"></div>
              <div style="flex:1;"><label>Son</label><input class="filter-input" id="fnFilterTo" type="date"></div>
            </div>
            <div class="flex row">
              <div style="flex:1"><label>Min m…ôbl…ôƒü (‚Çº)</label><input class="filter-input" id="fnFilterMinAmount" type="number" step="0.01"></div>
              <div style="flex:1"><label>Max m…ôbl…ôƒü (‚Çº)</label><input class="filter-input" id="fnFilterMaxAmount" type="number" step="0.01"></div>
            </div>
          </div>
          <div class="row wrap checkbox-container">
            <div style="flex:1">
              <label>Tip</label>
              <div class="type-check-container" style="background:#0f172a;border:1px solid var(--border);border-radius:8px;padding:8px;max-height:100px;overflow-y:auto;">
                <label style="display:flex;align-items:center;gap:6px;padding:4px 0;cursor:pointer;min-width:0;flex-shrink:1">
                  <input type="checkbox" name="fnFilterType" value="income" style="width:auto;min-width:0;flex-shrink:1;white-space:normal">
                  <span style="font-size:13px;">G…ôlir</span>
                </label>
                <label style="display:flex;align-items:center;gap:6px;padding:4px 0;cursor:pointer;min-width:0;flex-shrink:1">
                  <input type="checkbox" name="fnFilterType" value="expense" style="width:auto;min-width:0;white-space:normal">
                  <span style="font-size:13px;">X…ôrc</span>
                </label>
              </div>
            </div>
            <div class="flex row" style="min-width:0; flex-shrink:1">
              <div style="flex:1 1 0;">
                <label style="display:flex;min-width:0; flex-shrink:1">Kateqoriya</label>
                <div class="scrollable" style="background:#0f172a;border:1px solid var(--border);min-width:0; border-radius:8px;padding:8px;max-height:150px;overflow-y:auto;">
                  ${
                    categoryCheckboxes ||
                    '<div class="tiny" style="color:var(--muted);">Kateqoriya yoxdur</div>'
                  }
                </div>
              </div>
              <div style="flex:1 1 0;">
                <label style="display:flex;min-width:0; flex-shrink:1">Kontragent</label>
                <div class="scrollable" style="background:#0f172a;border:1px solid var(--border);min-width:0;border-radius:8px;padding:8px;max-height:150px;overflow-y:auto;">
                  ${
                    counterpartyCheckboxes ||
                    '<div class="tiny" style="color:var(--muted);">Kontragent yoxdur</div>'
                  }
                </div>
              </div>  
            </div>
          </div>
          <div class="row" style="justify-content:flex-end;margin-top:8px;gap:8px;">
            <button onclick="filterFinances()">üîç Filtrl…ô</button>
            <button class="ghost" onclick="clearFinanceFilter()">‚úï T…ômizl…ô</button>
          </div>
        </div>
        
        <!-- STATƒ∞STƒ∞KA -->
        <div class="row wrap" style="margin-bottom:8px;gap:8px;">
          <div>
            <div class="pill"><span class="muted">G…ôlir:</span> <b id="fnStatsIncome">${fmtMoney(
              totalIncome
            )}</b></div>
            <div class="pill"><span class="muted">X…ôrc:</span> <b id="fnStatsExpense">${fmtMoney(
              totalExpense
            )}</b></div>
          </div>

          <div>
            <div class="pill"><span class="muted">Xalis:</span> <b id="fnStatsNet">${fmtMoney(
              netProfit
            )}</b> <span id="fnStatsNetBadge" class="${
          netProfit >= 0 ? "badge ok" : "badge bad"
        }">${netProfit >= 0 ? "OK" : "NEG"}</span></div>
            <div class="pill"><span class="muted">Say:</span> <b id="fnStatsCount">${
              APP.finances.length
            }</b></div>
          </div>
        </div>
        
        <div class="row" style="justify-content:flex-end;margin-bottom:8px;">
          <button onclick="exportToExcel('finance')">üì• Excel y√ºkl…ô</button>
        </div>
        <table>
          <thead><tr><th>Tarix</th><th>Tip</th><th>Kateqoriya</th><th>Kontragent</th><th class="right">M…ôbl…ôƒü</th><th>Qeyd</th></tr></thead>
          <tbody id="financeTableBody">${list}</tbody>
        </table>
      </div>
    </div>`;

        // Global funksiyalar
        window.filterFinances = filterFinances;
        window.clearFinanceFilter = function () {
          $("#fnFilterFrom").value = "";
          $("#fnFilterTo").value = "";
          $("#fnFilterMinAmount").value = "";
          $("#fnFilterMaxAmount").value = "";

          // B√ºt√ºn checkbox-larƒ± t…ômizl…ô
          document
            .querySelectorAll('input[name="fnFilterType"]')
            .forEach((cb) => (cb.checked = false));
          document
            .querySelectorAll('input[name="fnFilterCategory"]')
            .forEach((cb) => (cb.checked = false));
          document
            .querySelectorAll('input[name="fnFilterCounterparty"]')
            .forEach((cb) => (cb.checked = false));

          filterFinances();
        };
      }

      async function addFinance() {
        const type = $("#fnType").value;
        const category = $("#fnCat").value.trim();
        const amount = Number($("#fnAmt").value);
        const date = $("#fnDate").value || today();
        const counterparty = $("#fnCp").value.trim();
        const note = $("#fnNote").value.trim();

        if (!category || amount < 0) {
          alert("Kateqoriya v…ô m…ôbl…ôƒü daxil edin");
          return;
        }

        try {
          await apiPOST("/api/finances", {
            date,
            type,
            category,
            amountAzn: amount,
            counterparty,
            note,
          });
          await fetchFinances();
          await fetchPL();
          $("#fnCat").value = "";
          $("#fnAmt").value = "";
          $("#fnCp").value = "";
          $("#fnNote").value = "";
        } catch (e) {}
      }

      // --- AR / AP ---
      function arRemaining(entry) {
        const paid = (entry.payments || []).reduce(
          (a, b) => a + Number(b.amountAzn || 0),
          0
        );
        return (entry.amountAzn || 0) - paid;
      }

      function apRemaining(entry) {
        return arRemaining(entry);
      }

      // Payments
      async function showPayments(paymentId) {
        // const paymentId = event.parentElement.children[0]
        const overlay = document.createElement("div");
        overlay.className = "payment-overlay open";
        overlay.innerHTML = `
      <div class="payment-modal" role="dialog" aria-modal="true">
        <h2>√ñd…ôm…ô Tarixi</h2>
        <div id="paymentContent">
          <div class="payment-empty">Y√ºkl…ônir...</div>
        </div>
        <div class="modal-footer">
          <button class="close-btn" type="button">Baƒüla</button>
        </div>
      </div>
    `;
        document.body.appendChild(overlay);

        const closeModal = () => {
          overlay.classList.remove("open");
          overlay.addEventListener("transitionend", () => overlay.remove(), {
            once: true,
          });
        };

        overlay.addEventListener("click", (evt) => {
          if (evt.target === overlay) closeModal();
        });
        overlay
          .querySelector(".close-btn")
          .addEventListener("click", closeModal);
        window.addEventListener("keydown", function escListener(evt) {
          if (evt.key === "Escape") {
            closeModal();
            window.removeEventListener("keydown", escListener);
          }
        });

        const content = overlay.querySelector("#paymentContent");
        const endpoint = `https://api.example.com/payments?personId=${encodeURIComponent(
          paymentId
        )}`;

        try {
          const response = await fetch(endpoint);
          if (!response.ok) throw new Error("Network response was not ok");
          const data = await response.json();
          const payments = Array.isArray(data?.payments) ? data.payments : [];

          if (!payments.length) {
            content.innerHTML = `<div class="payment-empty">√ñd…ôni≈ü tarix√ß…ôsi bo≈üdur...</div>`;
            return;
          }

          const listItems = payments
            .map(
              (payment) => `
            <li class="payment-item">
              <span>${payment.date || "Tarix yoxdur"}</span>
              <span>${payment.amount ?? "--"}</span>
            </li>`
            )
            .join("");

          content.innerHTML = `<ul class="payment-list">${listItems}</ul>`;
        } catch (error) {
          console.error("Failed to load payments:", error);
          content.innerHTML = `<div class="payment-empty">√ñd…ôni≈ü tarix√ß…ôsi bo≈üdur...</div>`;
        }
        console.log("payments", event);
      }

      function renderARAP() {
        const arRows =
          (APP.ar || [])
            .slice()
            .sort((a, b) => (a.date || "").localeCompare(b.date || ""))
            .map(
              (e) => `<tr>
            <td>${e.date}</td>
            <td>${e.counterparty || ""}</td>
            <td class="right">${fmtMoney(e.amountAzn || 0)}</td>
            <td class="right">${fmtMoney(arRemaining(e))}</td>
            <td>${e.status || ""}</td>
            <td class="right"><button class="ghost" onclick="addARPayPrompt('${
              e.id
            }')">√ñd…ôni≈ü</button></td>
            <td onclick="showPayments('${e.id}')" class="payment-btn">
              <i class="fa-solid fa-clock"></i>  
            </td>
            </tr>`
            )
            .join("") ||
          '<tr><td colspan="6" class="tiny">Debitor yoxdur</td></tr>';

        const apRows =
          (APP.ap || [])
            .slice()
            .sort((a, b) => (a.date || "").localeCompare(b.date || ""))
            .map(
              (e) => `<tr>
            <td>${e.date}</td>
            <td>${e.counterparty || ""}</td>
            <td class="right">${fmtMoney(e.amountAzn || 0)}</td>
            <td class="right">${fmtMoney(apRemaining(e))}</td>
            <td>${e.status || ""}</td>
            <td class="right"><button class="ghost" onclick="addAPPayPrompt('${
              e.id
            }')">√ñd…ôni≈ü</button></td>
            <td onclick="showPayments('${e.id}')" class="payment-btn">
              <i class="fa-solid fa-clock"></i>  
            </td>
            </tr>`
            )
            .join("") ||
          '<tr><td colspan="6" class="tiny">Borc yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Borclular (AR)</div>
              <div class="row" style="justify-content:flex-end;margin-bottom:8px;">
                <button onclick="exportToExcel('ar')">üì• Excel y√ºkl…ô</button>
              </div>
              <div class="row wrap">
                <div style="flex:2 1 220px;"><label>Kontragent</label><input id="arCp"></div>
                <div style="flex:1 1 160px;"><label>Tarix</label><input id="arDate" type="date" value="${today()}"></div>
                <div style="flex:1 1 150px;"><label>M…ôbl…ôƒü (‚Çº)</label><input id="arAmt" type="number" step="0.01"></div>
                <div style="flex:1 1 160px;"><label>Status</label><select id="arStatus"><option>open</option><option>partial</option><option>closed</option></select></div>
              </div>
              <label>Qeyd</label><textarea id="arNote"></textarea>
              <div class="row" style="justify-content:flex-end;margin-top:8px;"><button class="primary" onclick="addAR()">∆èlav…ô et</button></div>
              <div class="divider"></div>
              <table>
                <thead><tr><th>Tarix</th><th>Kontragent</th><th class="right">M…ôbl…ôƒü</th><th class="right">Qalƒ±q</th><th>Status</th><th class="right">∆èm…ôliyyat</th></tr></thead>
                <tbody>${arRows}</tbody>
              </table>
            </div>

            <div class="card">
              <div class="section-title">Borclar (AP)</div>
              <div class="row" style="justify-content:flex-end;margin-bottom:8px;">
                <button onclick="exportToExcel('ap')">üì• Excel y√ºkl…ô</button>
              </div>
              <div class="row wrap">
                <div style="flex:2 1 220px;"><label>Kontragent</label><input id="apCp"></div>
                <div style="flex:1 1 160px;"><label>Tarix</label><input id="apDate" type="date" value="${today()}"></div>
                <div style="flex:1 1 150px;"><label>M…ôbl…ôƒü (‚Çº)</label><input id="apAmt" type="number" step="0.01"></div>
                <div style="flex:1 1 160px;"><label>Status</label><select id="apStatus"><option>open</option><option>partial</option><option>closed</option></select></div>
              </div>
              <label>Qeyd</label><textarea id="apNote"></textarea>
              <div class="row" style="justify-content:flex-end;margin-top:8px;"><button class="primary" onclick="addAP()">∆èlav…ô et</button></div>
              <div class="divider"></div>
              <table>
                <thead><tr><th>Tarix</th><th>Kontragent</th><th class="right">M…ôbl…ôƒü</th><th class="right">Qalƒ±q</th><th>Status</th><th class="right">∆èm…ôliyyat</th></tr></thead>
                <tbody>${apRows}</tbody>
              </table>
            </div>
          </div>`;
      }

      async function addAR() {
        const counterparty = $("#arCp").value.trim();
        const date = $("#arDate").value || today();
        const amount = Number($("#arAmt").value);
        const status = $("#arStatus").value;
        const note = $("#arNote").value.trim();

        if (!counterparty || amount <= 0) {
          alert("Kontragent v…ô m…ôbl…ôƒü (>0) vacibdir");
          return;
        }

        try {
          await apiPOST("/api/ar", {
            counterparty,
            date,
            amountAzn: amount,
            status,
            payments: [],
            note,
          });
          await fetchARAP();
          $("#arCp").value = "";
          $("#arAmt").value = "";
          $("#arNote").value = "";
        } catch (e) {}
      }

      async function addAP() {
        const counterparty = $("#apCp").value.trim();
        const date = $("#apDate").value || today();
        const amount = Number($("#apAmt").value);
        const status = $("#apStatus").value;
        const note = $("#apNote").value.trim();

        if (!counterparty || amount <= 0) {
          alert("Kontragent v…ô m…ôbl…ôƒü (>0) vacibdir");
          return;
        }

        try {
          await apiPOST("/api/ap", {
            counterparty,
            date,
            amountAzn: amount,
            status,
            payments: [],
            note,
          });
          await fetchARAP();
          $("#apCp").value = "";
          $("#apAmt").value = "";
          $("#apNote").value = "";
        } catch (e) {}
      }

      async function addARPayPrompt(id) {
        const e = APP.ar.find((x) => x.id === id);
        if (!e) return;
        const amt = prompt("√ñd…ôni≈ü m…ôbl…ôƒüi (‚Çº)");
        if (amt === null) return;
        const a = Number(amt);
        if (!(a > 0)) return alert("Yanlƒ±≈ü m…ôbl…ôƒü");

        try {
          await apiPOST(`/api/ar/${id}/payments`, {
            date: today(),
            amountAzn: a,
          });
          await fetchARAP();
        } catch (e) {}
      }

      async function addAPPayPrompt(id) {
        const e = APP.ap.find((x) => x.id === id);
        if (!e) return;
        const amt = prompt("√ñd…ôni≈ü m…ôbl…ôƒüi (‚Çº)");
        if (amt === null) return;
        const a = Number(amt);
        if (!(a > 0)) return alert("Yanlƒ±≈ü m…ôbl…ôƒü");

        try {
          await apiPOST(`/api/ap/${id}/payments`, {
            date: today(),
            amountAzn: a,
          });
          await fetchARAP();
        } catch (e) {}
      }

      // --- REPORTS ---
      function renderReports() {
        const from = today().slice(0, 7) + "-01";
        const to = today();
        const p = APP.pl || {};

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">M…ônf…ô…ôt/Z…ôr…ôr hesabatƒ±</div>
              <div class="row wrap">
                <div style="flex:1 1 160px;"><label>Ba≈ülanƒüƒ±c</label><input id="rpFrom" type="date" value="${from}"></div>
                <div style="flex:1 1 160px;"><label>Son</label><input id="rpTo" type="date" value="${to}"></div>
                <div style="align-self:flex-end;"><button class="primary" onclick="fetchPL()">G√∂st…ôr</button></div>
              </div>
              <div id="plBox" style="margin-top:8px;">
                <table>
                  <tbody>
                    <tr><td>G…ôlir</td><td class="right">${fmtMoney(
                      p.revenue || 0
                    )}</td></tr>
                    <tr><td>Satƒ±lan malƒ±n maya d…ôy…ôri (COGS)</td><td class="right">${fmtMoney(
                      p.cogs || 0
                    )}</td></tr>
                    <tr><th>Br√ºt m…ônf…ô…ôt</th><th class="right">${fmtMoney(
                      p.grossProfit || 0
                    )}</th></tr>
                    <tr><td>Dig…ôr x…ôrcl…ôr</td><td class="right">${fmtMoney(
                      p.expenses || 0
                    )}</td></tr>
                    <tr><th>Xalis m…ônf…ô…ôt</th><th class="right">${fmtMoney(
                      p.netProfit || 0
                    )}</th></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="card">
              <div class="section-title">Material h…ôr…ôk…ôtl…ôri</div>
              <div id="mvBox"></div>
            </div>
          </div>`;
        renderMovement();
      }

      function renderMovement() {
        const rows =
          (APP.movements || [])
            .map((m) => {
              return `<tr>
            <td>${m.code}</td>
            <td>${m.name}</td>
            <td class="right">${fmtN(m.inQty, 3)}</td>
            <td class="right">${fmtMoney(m.inSum)}</td>
            <td class="right">${fmtN(m.outQty, 3)}</td>
            <td class="right">${fmtMoney(m.outSum)}</td>
          </tr>`;
            })
            .join("") ||
          '<tr><td colspan="6" class="tiny">He√ß bir m…ôlumat yoxdur</td></tr>';

        $("#mvBox").innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Kod</th>
                <th>Material</th>
                <th class="right">Giri≈ü (kq)</th>
                <th class="right">Giri≈ü (‚Çº)</th>
                <th class="right">√áƒ±xƒ±≈ü (kq)</th>
                <th class="right">√áƒ±xƒ±≈ü (‚Çº)</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>`;
      }

      // ====== PRODUCTS ======
      function renderProducts() {
        let totalQuantity = 0;
        let totalValue = 0;

        const list =
          APP.products
            .map((x) => {
              const unitPrice = x.unitPrice || x.salePrice || 0;
              const quantity = x.initialQuantity || x.quantity || 0;
              const total = unitPrice * quantity;

              totalQuantity += quantity;
              totalValue += total;

              return `
          <tr>
            <td>${x.code || ""}</td>
            <td>${x.name || ""}</td>
            <td class="tiny">${x.description || ""}</td>
            <td>${x.category || ""}</td>
            <td class="right">${fmtMoney(unitPrice)}</td>
            <td class="right">${fmtN(quantity, 0)}</td>
            <td class="right">${fmtMoney(total)}</td>
            <td>${
              x.isActive === false
                ? '<span class="badge warn">arxiv</span>'
                : '<span class="badge ok">aktiv</span>'
            }</td>
          </tr>`;
            })
            .join("") ||
          '<tr><td colspan="8" class="tiny">M…ôhsul yoxdur</td></tr>';

        const productOptions = APP.products
          .filter((x) => x.isActive !== false)
          .map((x) => `<option value="${x.id}">${x.code} ‚Äî ${x.name}</option>`)
          .join("");

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Yeni m…ôhsul …ôlav…ô et</div>
              <div class="row wrap">
                <div style="flex:1 1 150px;"><label>Kod</label><input id="pCode" placeholder="PRD-001"></div>
                <div style="flex:2 1 200px;"><label>Ad</label><input id="pName" placeholder="Ayaqqabƒ± model A"></div>
                <div style="flex:2 1 200px;"><label>Kateqoriya</label><input id="pCat" placeholder="Ayaqqabƒ±"></div>
                <div style="flex:1 1 150px;"><label>Satƒ±≈ü qiym…ôti (‚Çº)</label><input id="pPrice" type="number" step="0.01"></div>
                <div style="flex:1 1 120px;"><label>ƒ∞lkin miqdar</label><input id="pInitQty" type="number" step="1" value="0"></div>
              </div>
              <label>T…ôsvir</label><textarea id="pDesc" placeholder="M…ôhsul haqqƒ±nda"></textarea>
              <div class="row" style="justify-content:space-between;margin-top:8px;">
                <button onclick="exportToExcel('products')">üì• Excel y√ºkl…ô</button>
                <button class="primary" onclick="addProduct()">M…ôhsul …ôlav…ô et</button>
              </div>
              
              <div class="divider"></div>
              
              <div class="section-title">M√∂vcud m…ôhsula miqdar …ôlav…ô et</div>
              <div class="row wrap">
                <div style="flex:2 1 260px;"><label>M…ôhsul</label><select id="pUpdateSelect">${productOptions}</select></div>
                <div style="flex:1 1 120px;"><label>∆èlav…ô edil…ôc…ôk miqdar</label><input id="pUpdateQty" type="number" step="1" min="1" value="0"></div>
              </div>
              <div class="row" style="justify-content:flex-end;margin-top:8px;">
                <button class="primary" onclick="updateProductQuantity()">Miqdar …ôlav…ô et</button>
              </div>
            </div>
            <div class="card">
              <div class="section-title">M…ôhsullar</div>
              <table>
                <thead><tr>
                  <th>Kod</th>
                  <th>Ad</th>
                  <th>T…ôsvir</th>
                  <th>Kateqoriya</th>
                  <th class="right">Satƒ±≈ü qiym…ôti</th>
                  <th class="right">Miqdar <span class="badge ok">${fmtN(
                    totalQuantity,
                    0
                  )}</span></th>
                  <th class="right">Total <span class="badge ok">${fmtMoney(
                    totalValue
                  )}</span></th>
                  <th>Status</th>
                </tr></thead>
                <tbody>${list}</tbody>
              </table>
            </div>
          </div>`;
      }

      async function updateProductQuantity() {
        const productId = $("#pUpdateSelect").value;
        const addQty = Number($("#pUpdateQty").value);

        if (!productId) {
          alert("M…ôhsul se√ßin");
          return;
        }

        if (addQty <= 0) {
          alert("∆èlav…ô edil…ôc…ôk miqdar 0-dan b√∂y√ºk olmalƒ±dƒ±r");
          return;
        }

        try {
          const product = APP.products.find((p) => p.id === productId);
          const currentQty = product.initialQuantity || product.quantity || 0;
          const newQty = currentQty + addQty;

          await apiPUT(`/api/products/${productId}/quantity`, {
            quantity: newQty,
          });
          await fetchProducts();
          await fetchProductionStock();
          $("#pUpdateQty").value = "0";
          alert(`‚úÖ ${addQty} …ôd…ôd …ôlav…ô edildi. Yeni miqdar: ${newQty}`);
        } catch (e) {
          await fetchProducts();
        }
      }

      async function addProduct() {
        const code = $("#pCode").value.trim();
        const name = $("#pName").value.trim();
        const category = $("#pCat").value.trim();
        const price = Number($("#pPrice").value || 0);
        const description = $("#pDesc").value.trim();
        const initialQuantity = Number($("#pInitQty").value || 0);

        if (!code || !name) {
          alert("Kod v…ô adƒ± daxil edin");
          return;
        }

        try {
          await apiPOST("/api/products", {
            code,
            name,
            category,
            salePrice: price,
            description,
            initialQuantity,
            isActive: true,
          });
          await fetchProducts();
          await fetchProductionStock();
          $("#pCode").value = "";
          $("#pName").value = "";
          $("#pCat").value = "";
          $("#pPrice").value = "";
          $("#pDesc").value = "";
          $("#pInitQty").value = "0";
        } catch (e) {}
      }

      // ====== STORE TRANSFER ======
      function renderStoreTransfer() {
        console.log("renderStoreTransfer √ßaƒüƒ±rƒ±ldƒ±");
        console.log("APP.productionStock:", APP.productionStock);

        let availableStock = APP.productionStock || [];

        if (availableStock.length === 0 && APP.products.length > 0) {
          availableStock = APP.products
            .filter((p) => p.isActive !== false)
            .map((p) => ({
              productId: p.id,
              productCode: p.code,
              productName: p.name,
              quantity: p.initialQuantity || p.quantity || 0,
            }));
        }

        if (!availableStock || availableStock.length === 0) {
          const productOptions =
            '<option value="">Hazƒ±rda anbar bo≈üdur</option>';

          $("#view").innerHTML = `
      <div class="grid cols-2">
        <div class="card">
          <div class="section-title">Maƒüazaya k√∂√ß√ºrm…ô</div>
          <div style="padding:20px;text-align:center;color:#f59e0b;">
            ‚ö†Ô∏è M…ôhsul yoxdur. ∆èvv…ôlc…ô m…ôhsul …ôlav…ô edin.
          </div>
          <div class="row wrap">
            <div style="flex:2 1 260px;"><label>M…ôhsul</label><select id="trProduct" disabled>${productOptions}</select></div>
            <div style="flex:1 1 120px;"><label>Miqdar (…ôd…ôd)</label><input id="trQty" type="number" step="1" disabled></div>
            <div style="flex:1 1 140px;"><label>1 …ôd…ôd maya (‚Çº)</label><input id="trCost" type="number" step="0.01" disabled></div>
            <div style="flex:1 1 160px;"><label>Tarix</label><input id="trDate" type="date" value="${today()}" disabled></div>
          </div>
          <label>Qeyd</label><textarea id="trNote" disabled></textarea>
          <div class="row" style="justify-content:space-between;margin-top:8px;">
            <button onclick="fetchProducts().then(() => renderStoreTransfer())">üîÑ Yenil…ô</button>
            <button class="primary" disabled>Maƒüazaya k√∂√ß√ºr</button>
          </div>
        </div>
        <div class="card">
          <div class="section-title">K√∂√ß√ºrm…ô tarix√ß…ôsi</div>
          <table>
            <thead><tr><th>Tarix</th><th>Kod</th><th>M…ôhsul</th><th class="right">Miqdar</th><th class="right">Maya/…ôd…ôd</th><th class="right">C…ôm</th><th>Qeyd</th></tr></thead>
            <tbody><tr><td colspan="7" class="tiny">Transfer yoxdur</td></tr></tbody>
          </table>
        </div>
      </div>`;
          return;
        }

        const productOptions = availableStock
          .map((s) => {
            const product =
              APP.products.find((p) => p.id === s.productId) || {};
            const salePrice = product.unitPrice || product.salePrice || 0;
            return `<option value="${
              s.productId
            }" data-saleprice="${salePrice}">${s.productCode} ‚Äî ${
              s.productName
            } (${fmtN(s.quantity, 0)} …ôd…ôd - Satƒ±≈ü: ${fmtMoney(
              salePrice
            )})</option>`;
          })
          .join("");

        function filterTransfersByDate() {
          const fromDate = $("#trFilterFrom").value;
          const toDate = $("#trFilterTo").value;

          let filtered = APP.storeTransfers.slice();

          if (fromDate) {
            filtered = filtered.filter((t) => t.date >= fromDate);
          }
          if (toDate) {
            filtered = filtered.filter((t) => t.date <= toDate);
          }

          const items =
            filtered
              .sort((a, b) => (a.date || "").localeCompare(b.date || ""))
              .map((t) => {
                const product =
                  APP.products.find((p) => p.id === t.productId) || {};
                const costPerUnit =
                  product.unitPrice || product.salePrice || t.costPerUnit || 0;
                const totalCost = costPerUnit * (t.quantity || 0);

                return `<tr>
          <td>${t.date}</td>
          <td>${t.productCode || ""}</td>
          <td>${t.productName || ""}</td>
          <td class="right">${fmtN(t.quantity, 0)}</td>
          <td class="right">${fmtMoney(costPerUnit)}</td>
          <td class="right">${fmtMoney(totalCost)}</td>
          <td class="tiny">${t.note || ""}</td>
        </tr>`;
              })
              .join("") ||
            '<tr><td colspan="7" class="tiny">Bu tarix aralƒ±ƒüƒ±nda transfer yoxdur</td></tr>';

          $("#transferTableBody").innerHTML = items;
        }

        const items =
          APP.storeTransfers
            .slice()
            .sort((a, b) => (a.date || "").localeCompare(b.date || ""))
            .map((t) => {
              const product =
                APP.products.find((p) => p.id === t.productId) || {};
              const costPerUnit =
                product.unitPrice || product.salePrice || t.costPerUnit || 0;
              const totalCost = costPerUnit * (t.quantity || 0);

              return `<tr>
        <td>${t.date}</td>
        <td>${t.productCode || ""}</td>
        <td>${t.productName || ""}</td>
        <td class="right">${fmtN(t.quantity, 0)}</td>
        <td class="right">${fmtMoney(costPerUnit)}</td>
        <td class="right">${fmtMoney(totalCost)}</td>
        <td class="tiny">${t.note || ""}</td>
      </tr>`;
            })
            .join("") ||
          '<tr><td colspan="7" class="tiny">Transfer yoxdur</td></tr>';

        $("#view").innerHTML = `
    <div class="grid cols-2">
      <div class="card">
        <div class="section-title">Maƒüazaya k√∂√ß√ºrm…ô</div>
        <div class="row wrap">
          <div style="flex:2 1 260px;"><label>M…ôhsul</label><select id="trProduct">${productOptions}</select></div>
          <div style="flex:1 1 120px;"><label>Miqdar (…ôd…ôd)</label><input id="trQty" type="number" step="1" value="0"></div>
          <div style="flex:1 1 140px;"><label>1 …ôd…ôd maya (‚Çº)</label><input id="trCost" type="number" step="0.01" value="0"></div>
          <div style="flex:1 1 160px;"><label>Tarix</label><input id="trDate" type="date" value="${today()}"></div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div style="flex:1;"><label>C…ôm maya d…ôy…ôri</label><input id="trTotal" type="text" readonly value="‚Çº 0.00" style="font-weight:700;font-size:16px;background:#1a2332;"></div>
        </div>
        <label>Qeyd</label><textarea id="trNote"></textarea>
        <div class="row" style="justify-content:space-between;margin-top:8px;">
          <button onclick="fetchProductionStock().then(() => renderStoreTransfer())">üîÑ Yenil…ô</button>
          <button class="primary" onclick="addStoreTransfer()">Maƒüazaya k√∂√ß√ºr</button>
        </div>
      </div>
      <div class="card">
        <div class="section-title">K√∂√ß√ºrm…ô tarix√ß…ôsi</div>
        <div class="row wrap" style="margin-bottom:12px;">
          <div style="flex:1 1 160px;"><label>Ba≈ülanƒüƒ±c tarixi</label><input id="trFilterFrom" type="date"></div>
          <div style="flex:1 1 160px;"><label>Son tarix</label><input id="trFilterTo" type="date"></div>
          <div style="align-self:flex-end;"><button onclick="filterTransfersByDate()">üîç Filtrl…ô</button></div>
          <div style="align-self:flex-end;"><button class="ghost" onclick="clearTransferFilter()">‚úï T…ômizl…ô</button></div>
        </div>
        <table>
          <thead><tr><th>Tarix</th><th>Kod</th><th>M…ôhsul</th><th class="right">Miqdar</th><th class="right">Maya/…ôd…ôd</th><th class="right">C…ôm</th><th>Qeyd</th></tr></thead>
          <tbody id="transferTableBody">${items}</tbody>
        </table>
      </div>
    </div>`;

        function updateTransferTotal() {
          const qtyInput = document.getElementById("trQty");
          const costInput = document.getElementById("trCost");
          const totalInput = document.getElementById("trTotal");

          if (!qtyInput || !costInput || !totalInput) return;

          const costPerUnit = Number(costInput.value || 0);
          const quantity = Number(qtyInput.value || 0);
          const total = costPerUnit * quantity;

          totalInput.value = fmtMoney(total);
        }

        window.filterTransfersByDate = filterTransfersByDate;
        window.clearTransferFilter = function () {
          $("#trFilterFrom").value = "";
          $("#trFilterTo").value = "";
          filterTransfersByDate();
        };

        document
          .getElementById("trProduct")
          .addEventListener("change", function () {
            const selectedOption = this.options[this.selectedIndex];
            const salePrice = Number(
              selectedOption.getAttribute("data-saleprice") || 0
            );
            document.getElementById("trCost").value = salePrice.toFixed(2);
            updateTransferTotal();
          });

        document
          .getElementById("trQty")
          .addEventListener("input", updateTransferTotal);
        document
          .getElementById("trCost")
          .addEventListener("input", updateTransferTotal);

        const firstOption = document.getElementById("trProduct").options[0];
        if (firstOption) {
          const salePrice = Number(
            firstOption.getAttribute("data-saleprice") || 0
          );
          document.getElementById("trCost").value = salePrice.toFixed(2);
        }
        updateTransferTotal();
      }

      async function addStoreTransfer() {
        const productId = $("#trProduct").value;
        const quantity = Number($("#trQty").value);
        const date = $("#trDate").value || today();
        const note = $("#trNote").value.trim();

        if (!productId || quantity <= 0) {
          alert("M…ôhsul v…ô miqdar (>0) vacibdir");
          return;
        }

        try {
          await apiPOST("/api/store-transfers", {
            date,
            productId,
            quantity,
            note,
          });

          alert("‚úÖ Transfer uƒüurla h…ôyata ke√ßirildi!");

          await Promise.all([
            fetchStoreTransfers(),
            fetchProductionStock(),
            fetchStoreStock(),
          ]);

          renderStoreTransfer();

          $("#trQty").value = "";
          $("#trNote").value = "";
        } catch (e) {
          console.error("Transfer x…ôtasƒ±:", e);
        }
      }

      // ====== STORE STOCK ======
      function renderStoreStock() {
        let totalQuantity = 0;
        let totalValue = 0;

        const rows =
          (APP.storeStock || [])
            .map((s) => {
              const product =
                APP.products.find((p) => p.id === s.productId) || {};
              const costPerUnit =
                product.unitPrice || product.salePrice || s.avgCost || 0;
              const quantity = s.quantity || 0;
              const itemValue = costPerUnit * quantity;

              totalQuantity += quantity;
              totalValue += itemValue;

              return `<tr>
      <td>${s.productCode || ""}</td>
      <td>${s.productName || ""}</td>
      <td class="right">${fmtN(quantity, 0)}</td>
      <td class="right">${fmtMoney(costPerUnit)}</td>
      <td class="right">${fmtMoney(itemValue)}</td>
    </tr>`;
            })
            .join("") ||
          '<tr><td colspan="5" class="tiny">Maƒüaza anbarƒ±nda m…ôhsul yoxdur</td></tr>';

        $("#view").innerHTML = `
    <div class="card">
      <div class="section-title">Maƒüaza anbarƒ±</div>
      <div class="row" style="justify-content:flex-end;margin-bottom:8px;">
        <button onclick="exportToExcel('storestock')">üì• Excel y√ºkl…ô</button>
      </div>
      <table>
        <thead><tr>
          <th>Kod</th>
          <th>M…ôhsul</th>
          <th class="right">Miqdar (…ôd…ôd) <span class="badge ok">${fmtN(
            totalQuantity,
            0
          )}</span></th>
          <th class="right">1 …ôd…ôd maya (‚Çº)</th>
          <th class="right">D…ôy…ôr (‚Çº) <span class="badge ok">${fmtMoney(
            totalValue
          )}</span></th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
      }

      // ====== STORE SALES ======
      function renderStoreSales() {
        const productOptions = (APP.storeStock || [])
          .filter((s) => s.quantity > 0)
          .map(
            (s) =>
              `<option value="${s.productId}">${s.productCode} ‚Äî ${
                s.productName
              } (${fmtN(s.quantity, 0)} …ôd…ôd - ${fmtMoney(
                s.unitPrice
              )})</option>`
          )
          .join("");

        const items =
          APP.storeSales
            .slice()
            .sort((a, b) => (a.date || "").localeCompare(b.date || ""))
            .map((sale) => {
              const prod =
                APP.products.find((p) => p.id === sale.productId) || {};

              const salePrice = sale.unitPrice || 0;
              const quantity = sale.quantity || 0;

              const revenue = salePrice * quantity;

              const costPerUnit = prod.unitPrice || prod.salePrice || 0;
              const expense = costPerUnit * quantity;

              const profit = revenue - expense;

              return `<tr>
        <td>${sale.date}</td>
        <td>${prod.code || ""}</td>
        <td>${prod.name || ""}</td>
        <td class="right">${fmtN(quantity, 0)}</td>
        <td class="right">${fmtMoney(salePrice)}</td>
        <td class="right">${fmtMoney(revenue)}</td>
        <td class="right">${fmtMoney(expense)}</td>
        <td class="right">${fmtMoney(profit)}</td>
        <td>${sale.customer || ""}</td>
        <td class="tiny">${sale.note || ""}</td>
      </tr>`;
            })
            .join("") ||
          '<tr><td colspan="10" class="tiny">Satƒ±≈ü yoxdur</td></tr>';

        $("#view").innerHTML = `
    <div class="grid cols-2">
      <div class="card">
        <div class="section-title">Satƒ±≈ü</div>
        <div class="row wrap">
          <div style="flex:2 1 200px;"><label>M…ôhsul</label><select id="saleProduct">${productOptions}</select></div>
          <div style="flex:1 1 100px;"><label>Miqdar</label><input id="saleQty" type="number" step="1"></div>
          <div style="flex:1 1 140px;"><label>Satƒ±≈ü qiym…ôti (‚Çº)</label><input id="salePrice" type="number" step="0.01"></div>
          <div style="flex:1 1 160px;"><label>Tarix</label><input id="saleDate" type="date" value="${today()}"></div>
          <div style="flex:2 1 200px;"><label>M√º≈üt…ôri</label><input id="saleCustomer" placeholder="M√º≈üt…ôri adƒ±"></div>
        </div>
        <label>Qeyd</label><textarea id="saleNote"></textarea>
        <div class="row" style="justify-content:flex-end;margin-top:8px;">
          <button class="primary" onclick="addStoreSale()">Satƒ±≈ü et</button>
        </div>
      </div>
      <div class="card">
        <div class="section-title">Satƒ±≈ü tarix√ß…ôsi</div>
        <table>
          <thead><tr>
            <th>Tarix</th>
            <th>Kod</th>
            <th>M…ôhsul</th>
            <th class="right">Miqdar</th>
            <th class="right">Qiym…ôt</th>
            <th class="right">G…ôlir</th>
            <th class="right">X…ôrc</th>
            <th class="right">M…ônf…ô…ôt</th>
            <th>M√º≈üt…ôri</th>
            <th>Qeyd</th>
          </tr></thead>
          <tbody>${items}</tbody>
        </table>
      </div>
    </div>`;

        $("#saleProduct").addEventListener("change", function () {
          const prodId = this.value;
          const prod = APP.products.find((p) => p.id === prodId);
          if (prod) {
            $("#salePrice").value = prod.unitPrice || prod.salePrice || 0;
          }
        });

        if (APP.products.length && $("#saleProduct").value) {
          const prod = APP.products.find(
            (p) => p.id === $("#saleProduct").value
          );
          if (prod)
            $("#salePrice").value = prod.unitPrice || prod.salePrice || 0;
        }
      }
      async function addStoreSale() {
        const productId = $("#saleProduct").value;
        const quantity = Number($("#saleQty").value);
        const salePrice = Number($("#salePrice").value);
        const date = $("#saleDate").value || today();
        const customer = $("#saleCustomer").value.trim();
        const note = $("#saleNote").value.trim();

        if (!productId || quantity <= 0 || salePrice <= 0) {
          alert("M…ôhsul, miqdar v…ô qiym…ôt (>0) vacibdir");
          return;
        }

        try {
          await apiPOST("/api/store-sales", {
            date,
            productId,
            quantity,
            unitPrice: salePrice,
            customer,
            note,
          });
          await fetchStoreSales();
          await fetchStoreStock();
          $("#saleQty").value = "";
          $("#saleCustomer").value = "";
          $("#saleNote").value = "";
        } catch (e) {}
      }

      // ====== ƒ∞Nƒ∞T ======
      function renderView() {
        if (currentTab === "materials") renderMaterials();
        else if (currentTab === "receipt") renderReceipt();
        else if (currentTab === "issue") renderIssue();
        else if (currentTab === "stock") renderStock();
        else if (currentTab === "products") renderProducts();
        else if (currentTab === "storetransfer") renderStoreTransfer();
        else if (currentTab === "storestock") renderStoreStock();
        else if (currentTab === "storesales") renderStoreSales();
        else if (currentTab === "finance") renderFinance();
        else if (currentTab === "arap") renderARAP();
        else if (currentTab === "reports") renderReports();
      }

      function exportToExcel(type) {
        let data = [];
        let filename = "";

        if (type === "products") {
          filename = "Mehsullar_" + today() + ".csv";
          data.push([
            "Kod",
            "Ad",
            "T…ôsvir",
            "Kateqoriya",
            "Satƒ±≈ü qiym…ôti",
            "Miqdar",
            "Total",
            "Status",
          ]);
          APP.products.forEach((x) => {
            const unitPrice = x.unitPrice || x.salePrice || 0;
            const quantity = x.initialQuantity || x.quantity || 0;
            const total = unitPrice * quantity;
            data.push([
              x.code || "",
              x.name || "",
              x.description || "",
              x.category || "",
              unitPrice.toFixed(2),
              quantity,
              total.toFixed(2),
              x.isActive === false ? "arxiv" : "aktiv",
            ]);
          });
        } else if (type === "storestock") {
          filename = "Magaza_Anbari_" + today() + ".csv";
          data.push(["Kod", "M…ôhsul", "Miqdar", "Maya/…ôd…ôd", "D…ôy…ôr"]);
          (APP.storeStock || []).forEach((s) => {
            const product =
              APP.products.find((p) => p.id === s.productId) || {};
            const costPerUnit =
              product.unitPrice || product.salePrice || s.avgCost || 0;
            const quantity = s.quantity || 0;
            const value = costPerUnit * quantity;
            data.push([
              s.productCode || "",
              s.productName || "",
              quantity,
              costPerUnit.toFixed(2),
              value.toFixed(2),
            ]);
          });
        } else if (type === "materials") {
          filename = "Materiallar_" + today() + ".csv";
          data.push(["Kod", "Ad", "Vahid", "Minimum qalƒ±q", "Status"]);
          APP.materials.forEach((x) => {
            data.push([
              x.code || "",
              x.name || "",
              "kg",
              (x.minLevel || 0).toFixed(3),
              x.isActive === false ? "arxiv" : "aktiv",
            ]);
          });
        } else if (type === "receipts") {
          filename = "Qebullar_" + today() + ".csv";
          data.push([
            "Tarix",
            "Kod",
            "Material",
            "Miqdar (kg)",
            "Qiym…ôt/kg",
            "M…ôbl…ôƒü",
            "T…ôchizat√ßƒ±",
            "≈û…ôrh",
          ]);
          APP.receipts.forEach((r) => {
            const mat = APP.materials.find((m) => m.id === r.materialId) || {};
            data.push([
              r.date,
              mat.code || "",
              mat.name || "",
              (r.qtyKg || 0).toFixed(3),
              (r.pricePerKg || 0).toFixed(2),
              (r.totalCost || 0).toFixed(2),
              r.supplier || "",
              r.note || "",
            ]);
          });
        } else if (type === "issues") {
          filename = "Silmeler_" + today() + ".csv";
          data.push([
            "Tarix",
            "Kod",
            "Material",
            "Miqdar (kg)",
            "Orta qiym…ôt",
            "M…ôbl…ôƒü",
            "ƒ∞≈ü",
            "≈û…ôrh",
          ]);
          APP.issues.forEach((i) => {
            const mat = APP.materials.find((m) => m.id === i.materialId) || {};
            data.push([
              i.date,
              mat.code || "",
              mat.name || "",
              (i.qtyKg || 0).toFixed(3),
              (i.avgCostUsed || 0).toFixed(2),
              (i.totalCostUsed || 0).toFixed(2),
              i.jobRef || "",
              i.note || "",
            ]);
          });
        } else if (type === "stock") {
          filename = "Anbar_" + today() + ".csv";
          data.push([
            "Kod",
            "Material",
            "Miqdar (kg)",
            "Orta qiym…ôt",
            "D…ôy…ôr",
            "Status",
          ]);
          (APP.stock || []).forEach((s) => {
            data.push([
              s.code || "",
              s.name || "",
              (s.onHandKg || 0).toFixed(3),
              (s.avgCostPerKg || 0).toFixed(2),
              (s.inventoryValue || 0).toFixed(2),
              s.status === "low" ? "LOW" : "OK",
            ]);
          });
        } else if (type === "storetransfer") {
          filename = "Magaza_Kocurme_" + today() + ".csv";
          data.push([
            "Tarix",
            "Kod",
            "M…ôhsul",
            "Miqdar",
            "Maya/…ôd…ôd",
            "C…ôm",
            "Qeyd",
          ]);
          APP.storeTransfers.forEach((t) => {
            const product =
              APP.products.find((p) => p.id === t.productId) || {};
            const costPerUnit =
              product.unitPrice || product.salePrice || t.costPerUnit || 0;
            data.push([
              t.date,
              t.productCode || "",
              t.productName || "",
              t.quantity || 0,
              costPerUnit.toFixed(2),
              (costPerUnit * (t.quantity || 0)).toFixed(2),
              t.note || "",
            ]);
          });
        } else if (type === "storesales") {
          filename = "Satislar_" + today() + ".csv";
          data.push([
            "Tarix",
            "Kod",
            "M…ôhsul",
            "Miqdar",
            "Qiym…ôt",
            "G…ôlir",
            "X…ôrc",
            "M…ônf…ô…ôt",
            "M√º≈üt…ôri",
            "Qeyd",
          ]);
          APP.storeSales.forEach((sale) => {
            const prod =
              APP.products.find((p) => p.id === sale.productId) || {};
            const salePrice = sale.unitPrice || 0;
            const quantity = sale.quantity || 0;
            const revenue = salePrice * quantity;
            const costPerUnit = prod.unitPrice || prod.salePrice || 0;
            const expense = costPerUnit * quantity;
            const profit = revenue - expense;
            data.push([
              sale.date,
              prod.code || "",
              prod.name || "",
              quantity,
              salePrice.toFixed(2),
              revenue.toFixed(2),
              expense.toFixed(2),
              profit.toFixed(2),
              sale.customer || "",
              sale.note || "",
            ]);
          });
        } else if (type === "finance") {
          filename = "Maliyye_" + today() + ".csv";
          data.push([
            "Tarix",
            "Tip",
            "Kateqoriya",
            "Kontragent",
            "M…ôbl…ôƒü",
            "Qeyd",
          ]);
          (APP.finances || []).forEach((f) => {
            data.push([
              f.date,
              f.type === "income" ? "G…ôlir" : "X…ôrc",
              f.category || "",
              f.counterparty || "",
              (f.amountAzn || 0).toFixed(2),
              f.note || "",
            ]);
          });
        } else if (type === "ar") {
          filename = "AR_" + today() + ".csv";
          data.push([
            "Tip",
            "Tarix",
            "Kontragent",
            "M…ôbl…ôƒü",
            "Qalƒ±q",
            "Status",
          ]);
          APP.ar.forEach((e) => {
            const paid = (e.payments || []).reduce(
              (a, b) => a + Number(b.amountAzn || 0),
              0
            );
            const remaining = (e.amountAzn || 0) - paid;
            data.push([
              "AR (Debitor)",
              e.date,
              e.counterparty || "",
              (e.amountAzn || 0).toFixed(2),
              remaining.toFixed(2),
              e.status || "",
            ]);
          });
        } else if (type === "ap") {
          filename = "AP_" + today() + ".csv";
          data.push([
            "Tip",
            "Tarix",
            "Kontragent",
            "M…ôbl…ôƒü",
            "Qalƒ±q",
            "Status",
          ]);
          APP.ap.forEach((e) => {
            const paid = (e.payments || []).reduce(
              (a, b) => a + Number(b.amountAzn || 0),
              0
            );
            const remaining = (e.amountAzn || 0) - paid;
            data.push([
              "AP (Kreditor)",
              e.date,
              e.counterparty || "",
              (e.amountAzn || 0).toFixed(2),
              remaining.toFixed(2),
              e.status || "",
            ]);
          });
        }

        // CSV yaradƒ±rƒ±q - SEMƒ∞COLON (;) il…ô
        const csv = data
          .map((row) =>
            row
              .map((cell) => {
                const str = String(cell).replace(/"/g, '""');
                return `"${str}"`;
              })
              .join(";")
          )
          .join("\n");

        // UTF-8 BOM …ôlav…ô edirik (Excel √º√ß√ºn)
        const BOM = "\uFEFF";
        const blob = new Blob([BOM + csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
      }

      async function refreshAll() {
        try {
          await fetchMaterials();
          await fetchStock();
        } catch (e) {
          console.warn("refreshAll error", e);
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        $("#baseUrl").textContent = BASE;
        renderTabs();
        renderView();
        await refreshAll();
      });
    </script>
  </body>
</html>
