<!DOCTYPE html>
<html lang="az">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Material anbarı (kq) • Maliyyə (Gəlir/Xərc, AR/AP) — AZN</title>
    <style>
      :root {
        --bg: #0b1020;
        --card: #0f172a;
        --text: #e5e7eb;
        --muted: #94a3b8;
        --border: #27324a;
        --pill: #0b1220;
        --accent: #38bdf8;
        --ok: #22c55e;
        --warn: #f59e0b;
        --bad: #ef4444;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      }
      .app {
        max-width: 1260px;
        margin: 0 auto;
        padding: 20px;
      }
      h1 {
        margin: 0 0 8px;
        font-size: 22px;
      }
      .sub {
        color: var(--muted);
        font-size: 12px;
      }
      .tabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin: 12px 0 16px;
      }
      .tab {
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #0b1220;
        color: #cbd5e1;
        font-weight: 600;
        cursor: pointer;
      }
      .tab.active {
        background: linear-gradient(135deg, #2563eb, #06b6d4);
        color: #fff;
        border: none;
      }
      .grid {
        display: grid;
        gap: 12px;
      }
      .cols-2 {
        grid-template-columns: repeat(2, 1fr);
      }
      .cols-3 {
        grid-template-columns: repeat(3, 1fr);
      }
      .cols-4 {
        grid-template-columns: repeat(4, 1fr);
      }
      @media (max-width: 1024px) {
        .cols-4 {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (max-width: 720px) {
        .cols-4,
        .cols-3,
        .cols-2 {
          grid-template-columns: 1fr;
        }
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 14px;
      }
      .kpi {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .kpi .val {
        font-size: 22px;
        font-weight: 800;
      }
      .muted {
        color: var(--muted);
      }
      .tiny {
        font-size: 11px;
        color: var(--muted);
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .row.wrap {
        flex-wrap: wrap;
      }
      label {
        font-size: 12px;
        color: var(--muted);
        display: block;
        margin-bottom: 6px;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #0b1220;
        color: var(--text);
      }
      textarea {
        min-height: 72px;
      }
      button {
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #0b1220;
        color: var(--text);
        cursor: pointer;
      }
      button.primary {
        background: linear-gradient(135deg, #2563eb, #06b6d4);
        border: none;
        color: #fff;
      }
      button.ghost {
        background: transparent;
      }
      .danger {
        color: #fecaca;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        text-align: left;
        padding: 10px;
        border-bottom: 1px dashed var(--border);
        font-size: 14px;
      }
      th {
        color: var(--muted);
        font-weight: 700;
      }
      .right {
        text-align: right;
      }
      .badge {
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--pill);
        font-size: 12px;
      }
      .badge.ok {
        color: var(--ok);
        border-color: #22c55e30;
        background: #22c55e10;
      }
      .badge.warn {
        color: var(--warn);
        border-color: #f59e0b30;
        background: #f59e0b10;
      }
      .badge.bad {
        color: var(--bad);
        border-color: #ef444430;
        background: #ef444410;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .pill {
        border: 1px solid var(--border);
        background: var(--pill);
        border-radius: 999px;
        padding: 6px 10px;
        display: inline-flex;
        gap: 8px;
        align-items: center;
      }
      .divider {
        height: 1px;
        background: var(--border);
        margin: 12px 0;
      }
      .foot {
        margin-top: 12px;
        color: var(--muted);
        font-size: 12px;
      }
      .section-title {
        font-size: 16px;
        font-weight: 800;
        margin-bottom: 10px;
      }
      .loader {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 2px solid #ffffff25;
        border-top-color: #06b6d4;
        animation: spin 1s linear infinite;
        display: inline-block;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
    </style>
  </head>
  <body>
    <div class="app">
      <h1>Material anbarı (kq) + Maliyyə (AR/AP)</h1>
      <div class="sub">
        Valyuta: <b>AZN (₼)</b> • Ölçü vahidi: <b>kq</b> • Backend API: <b id="baseUrl">http://116.203.51.133:8085/stock</b>
      </div>

      <!-- KPI -->
      <div class="grid cols-4" style="margin-top: 12px">
        <div class="card kpi">
          <div>
            <div class="muted">Material qalığı</div>
            <div class="val" id="kpiOnHandKg">0</div>
          </div>
          <span class="badge">kq</span>
        </div>
        <div class="card kpi">
          <div>
            <div class="muted">İnventar dəyəri</div>
            <div class="val" id="kpiInvValue">₼ 0</div>
          </div>
          <span class="badge">AZN</span>
        </div>
        <div class="card kpi">
          <div>
            <div class="muted">Dövür üzrə gəlir</div>
            <div class="val" id="kpiRevenue">₼ 0</div>
          </div>
          <span class="badge">AZN</span>
        </div>
        <div class="card kpi">
          <div>
            <div class="muted">Dövür üzrə xalis mənfəət</div>
            <div class="val" id="kpiNet">₼ 0</div>
          </div>
          <span class="badge ok" id="kpiNetBadge">OK</span>
        </div>
      </div>

      <div class="tabs" id="tabs"></div>
      <div id="view"></div>

      <div class="foot">
        Məsləhət: əvvəlcə material kataloqunu əlavə edin, sonra gələn və silinən qeydləri yaradın.
      </div>
    </div>

    <script>
      // ====== KONFİGURASİYA ======
      const BASE = "http://116.203.51.133:8085/stock";
      const API_HEADERS = {
        "Content-Type": "application/json",
      };

      // helperlər
      const $ = s => document.querySelector(s);
      const fmtN = (n, d = 2) =>
        (n ?? 0).toLocaleString(undefined, { maximumFractionDigits: d });
      const fmtMoney = n => `₼ ${fmtN(n, 2)}`;
      const today = () => new Date().toISOString().slice(0, 10);

      // TABS
      const TABS = [
        { id: "materials", name: "Materiallar" },
        { id: "receipt", name: "Qəbul" },
        { id: "issue", name: "Silmə" },
        { id: "stock", name: "Anbar" },
        { id: "products", name: "Məhsullar" },
        { id: "production", name: "İstehsal" },
        { id: "prodstock", name: "İstehsal Anbarı" },
        { id: "storetransfer", name: "Mağazaya Köçürmə" },
        { id: "storestock", name: "Mağaza Anbarı" },
        { id: "storesales", name: "Satışlar" },
        { id: "finance", name: "Maliyyə (Gəlir/Xərc)" },
        { id: "arap", name: "Debitor/Kreditor (AR/AP)" },
        { id: "reports", name: "Hesabatlar" },
      ];
      let currentTab = "materials";

      // APP STATE
      const APP = {
        materials: [],
        receipts: [],
        issues: [],
        stock: [],
        products: [],
        production: [],
        productionStock: [],
        storeTransfers: [],
        storeStock: [],
        storeSales: [],
        finances: [],
        ar: [],
        ap: [],
        kpi: null,
      };

      // render tabs
      function renderTabs() {
        $("#tabs").innerHTML = TABS.map(
          (t) =>
            `<button class="tab ${currentTab === t.id ? "active" : ""}" onclick="switchTab('${t.id}')">${t.name}</button>`
        ).join("");
      }
      
      async function switchTab(id) {
        currentTab = id;
        renderTabs();
        
        // Loading göstər
        $("#view").innerHTML = '<div class="card" style="text-align:center;padding:40px;"><div class="loader"></div><div style="margin-top:12px;">Yüklənir...</div></div>';
        
        try {
          // avtomatik fetch - AWAIT ilə
          if (id === "materials") {
            await fetchMaterials();
          } else if (id === "receipt") { 
            await Promise.all([fetchMaterials(), fetchReceipts()]);
          } else if (id === "issue") { 
            await Promise.all([fetchMaterials(), fetchIssues()]);
          } else if (id === "stock") {
            await fetchStock();
          } else if (id === "products") {
            await fetchProducts();
          } else if (id === "production") { 
            await Promise.all([fetchProducts(), fetchMaterials(), fetchProduction()]);
          } else if (id === "prodstock") {
            await fetchProductionStock();
          } else if (id === "storetransfer") { 
            // ÖNCə data fetch et, SONRA render et
            await Promise.all([fetchProducts(), fetchProductionStock(), fetchStoreTransfers()]);
          } else if (id === "storestock") {
            await fetchStoreStock();
          } else if (id === "storesales") { 
            await Promise.all([fetchProducts(), fetchStoreStock(), fetchStoreSales()]);
          } else if (id === "finance") {
            await fetchFinances();
          } else if (id === "arap") {
            await fetchARAP();
          } else if (id === "reports") { 
            await Promise.all([fetchMaterials(), fetchReceipts(), fetchIssues()]);
            await fetchPL();
          }
        } catch (e) {
          console.error("Tab yüklənmə xətası:", e);
        }
        
        // Data yükləndi, indi render et
        renderView();
      }

      // ====== API helpers ======
      async function apiGET(path) {
        try {
          const res = await fetch(BASE + path, { method: "GET", headers: API_HEADERS });
          if (!res.ok) {
            const text = await res.text().catch(()=>"");
            throw new Error(`HTTP ${res.status}: ${text}`);
          }
          return await res.json();
        } catch (e) {
          console.error("GET", path, e);
          alert(`Server xətası GET ${path}\n${e.message}`);
          throw e;
        }
      }
      
      async function apiPOST(path, body) {
        try {
          const res = await fetch(BASE + path, {
            method: "POST",
            headers: API_HEADERS,
            body: JSON.stringify(body),
          });
          if (!res.ok) {
            const text = await res.text().catch(()=>"");
            throw new Error(`HTTP ${res.status}: ${text}`);
          }
          return await res.json();
        } catch (e) {
          console.error("POST", path, e);
          alert(`Server xətası POST ${path}\n${e.message}`);
          throw e;
        }
      }
      
      async function apiPUT(path, body) {
        try {
          const res = await fetch(BASE + path, {
            method: "PUT",
            headers: API_HEADERS,
            body: JSON.stringify(body),
          });
          if (!res.ok) {
            const text = await res.text().catch(()=>"");
            throw new Error(`HTTP ${res.status}: ${text}`);
          }
          return await res.json();
        } catch (e) {
          console.error("PUT", path, e);
          alert(`Server xətası PUT ${path}\n${e.message}`);
          throw e;
        }
      }

      async function apiPATCH(path) {
        try {
          const res = await fetch(BASE + path, {
            method: "PATCH",
            headers: API_HEADERS,
          });
          if (!res.ok) {
            const text = await res.text().catch(()=>"");
            throw new Error(`HTTP ${res.status}: ${text}`);
          }
          return res.status === 204 ? {} : await res.json();
        } catch (e) {
          console.error("PATCH", path, e);
          alert(`Server xətası PATCH ${path}\n${e.message}`);
          throw e;
        }
      }

      // ====== FETCH data from server ======
      async function fetchMaterials() {
        try {
          APP.materials = await apiGET("/api/materials");
          if (currentTab === "materials") renderMaterials();
        } catch (e) {}
      }
      
      async function fetchReceipts() {
        try {
          APP.receipts = await apiGET("/api/receipts");
          if (currentTab === "receipt") renderReceipt();
        } catch (e) {}
      }
      
      async function fetchIssues() {
        try {
          APP.issues = await apiGET("/api/issues");
          if (currentTab === "issue") renderIssue();
        } catch (e) {}
      }
      
      async function fetchStock() {
        try {
          APP.stock = await apiGET("/api/stock/snapshot");
          const from = today().slice(0, 7) + "-01";
          const to = today();
          APP.kpi = await apiGET(`/api/stock/kpi?from=${from}&to=${to}`);
          renderStock();
          updateKPIBox();
        } catch (e) {}
      }
      
      async function fetchFinances() {
        try {
          APP.finances = await apiGET("/api/finances");
          renderFinance();
        } catch (e) {}
      }
      
      async function fetchARAP() {
        try {
          APP.ar = await apiGET("/api/ar");
          APP.ap = await apiGET("/api/ap");
          renderARAP();
        } catch (e) {}
      }
      
      async function fetchPL() {
        try {
          const from = $("#rpFrom") ? $("#rpFrom").value : today().slice(0, 7) + "-01";
          const to = $("#rpTo") ? $("#rpTo").value : today();
          APP.pl = await apiGET(`/api/stock/profit-loss?from=${from}&to=${to}`);
          APP.kpi = await apiGET(`/api/stock/kpi?from=${from}&to=${to}`);
          APP.movements = await apiGET("/api/stock/movements");
          renderReports();
          updateKPIBox();
        } catch (e) {}
      }

      async function fetchProducts() {
        try {
          APP.products = await apiGET("/api/products");
          if (currentTab === "products") renderProducts();
        } catch (e) {}
      }

      async function fetchProduction() {
        try {
          APP.production = await apiGET("/api/products");
          if (currentTab === "production") renderProduction();
        } catch (e) {}
      }

      async function fetchProductionStock() {
        try {
          APP.productionStock = await apiGET("/api/warehouse-stock");
          console.log("Production Stock yükləndi:", APP.productionStock.length, "məhsul"); // Debug log
          if (currentTab === "prodstock" || currentTab === "storetransfer") {
            renderView();
          }
        } catch (e) {
          console.error("Production stock fetch xətası:", e);
          APP.productionStock = [];
        }
      }

      async function fetchStoreTransfers() {
        try {
          APP.storeTransfers = await apiGET("/api/store-transfers");
          if (currentTab === "storetransfer") renderStoreTransfer();
        } catch (e) {}
      }

      async function fetchStoreStock() {
        try {
          APP.storeStock = await apiGET("/api/store-stock");
          if (currentTab === "storestock") renderStoreStock();
        } catch (e) {}
      }

      async function fetchStoreSales() {
        try {
          APP.storeSales = await apiGET("/api/store-sales");
          if (currentTab === "storesales") renderStoreSales();
        } catch (e) {}
      }

      // ====== RENDER / UI funksiyaları ======
      function updateKPIBox() {
        let onHandKg = 0, inv = 0;
        
        if (Array.isArray(APP.stock) && APP.stock.length) {
          APP.stock.forEach(s => { 
            onHandKg += Number(s.onHandKg || 0); 
            inv += Number(s.inventoryValue || 0); 
          });
        }
        
        $("#kpiOnHandKg").textContent = fmtN(onHandKg, 3);
        $("#kpiInvValue").textContent = fmtMoney(inv);
        
        if (APP.kpi) {
          $("#kpiRevenue").textContent = fmtMoney(APP.kpi.revenue || 0);
          $("#kpiNet").textContent = fmtMoney(APP.kpi.netProfit || 0);
          const badge = $("#kpiNetBadge");
          if ((APP.kpi.netProfit || 0) >= 0) { 
            badge.textContent = "OK"; 
            badge.className = "badge ok"; 
          } else { 
            badge.textContent = "NEG"; 
            badge.className = "badge bad"; 
          }
        }
      }

      // --- MATERIALS ---
      function renderMaterials() {
        const list = APP.materials.map(x => `
          <tr>
            <td>${x.code || ""}</td>
            <td>${x.name || ""}</td>
            <td>kq</td>
            <td class="right">${fmtN(x.minLevel ?? 0, 3)}</td>
            <td>${x.isActive === false ? '<span class="badge warn">arxiv</span>' : '<span class="badge ok">aktiv</span>'}</td>
            <td class="right"><button class="ghost" onclick="toggleMat('${x.id}')">${x.isActive === false ? "Arxivdən çıxar" : "Arxivlə"}</button></td>
          </tr>`).join("") || '<tr><td colspan="6" class="tiny">Material yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Material bələdçisi</div>
              <div class="row wrap">
                <div style="flex:1 1 150px;"><label>Kod</label><input id="mCode" placeholder="MTL-001"></div>
                <div style="flex:2 1 260px;"><label>Ad</label><input id="mName" placeholder="Poliamid qranul"></div>
                <div style="flex:1 1 120px;"><label>Minimum qalıq (kq)</label><input id="mMin" type="number" step="0.001" value="0"></div>
              </div>
              <div class="row" style="justify-content:flex-end;margin-top:8px;">
                <button class="primary" onclick="addMaterial()">Material əlavə et</button>
              </div>
            </div>
            <div class="card">
              <div class="section-title">Materiallar</div>
              <table>
                <thead><tr><th>Kod</th><th>Ad</th><th>Vahid</th><th class="right">Minimum qalıq</th><th>Status</th><th class="right">Əməliyyatlar</th></tr></thead>
                <tbody>${list}</tbody>
              </table>
            </div>
          </div>`;
      }

      async function addMaterial() {
        const code = $("#mCode").value.trim();
        const name = $("#mName").value.trim();
        const min = Number($("#mMin").value || 0);
        if (!code || !name) { alert("Kod və adı daxil edin"); return; }
        try {
          await apiPOST("/api/materials", { 
            code, 
            name, 
            uom: "kg", 
            minLevel: min, 
            isActive: true 
          });
          await fetchMaterials();
          $("#mCode").value = ""; 
          $("#mName").value = ""; 
          $("#mMin").value = "0";
        } catch (e) {}
      }

      async function toggleMat(id) {
        try {
          await apiPATCH(`/api/materials/${id}/toggle`);
          await fetchMaterials();
        } catch (e) {}
      }

      // --- RECEIPTS ---
      function renderReceipt() {
        const options = APP.materials.filter(x => x.isActive !== false)
          .map(x => `<option value="${x.id}">${x.code} — ${x.name}</option>`).join("");
          
        const items = APP.receipts.slice().sort((a,b)=> (a.date||"").localeCompare(b.date||""))
          .map(r => {
            const mat = APP.materials.find(m => m.id === r.materialId) || {};
            return `<tr>
              <td>${r.date}</td>
              <td>${mat.code || ""}</td>
              <td>${mat.name || ""}</td>
              <td class="right">${fmtN(r.qtyKg, 3)}</td>
              <td class="right">${fmtMoney(r.pricePerKg)}</td>
              <td class="right">${fmtMoney(r.totalCost)}</td>
              <td>${r.supplier || ""}</td>
              <td class="tiny">${r.note || ""}</td>
            </tr>`;
          }).join("") || '<tr><td colspan="8" class="tiny">Qəbul yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Material qəbulu</div>
              <div class="row wrap">
                <div style="flex:2 1 260px;"><label>Material</label><select id="rcMat">${options}</select></div>
                <div style="flex:1 1 120px;"><label>Miqdar (kq)</label><input id="rcQty" type="number" step="0.001"></div>
                <div style="flex:1 1 140px;"><label>1 kq üçün qiymət (₼)</label><input id="rcPrice" type="number" step="0.01"></div>
                <div style="flex:1 1 160px;"><label>Tarix</label><input id="rcDate" type="date" value="${today()}"></div>
                <div style="flex:1 1 200px;"><label>Təchizatçı</label><input id="rcSupplier" placeholder="MMC Təchizatçı"></div>
              </div>
              <label>Şərh</label><textarea id="rcNote" placeholder="Partiya/qaimə"></textarea>
              <div class="row" style="justify-content:space-between;margin-top:8px;">
                <div class="tiny">Cəm = kq × qiymət/kq</div>
                <button class="primary" onclick="addReceipt()">Qəbulu əlavə et</button>
              </div>
            </div>
            <div class="card">
              <div class="section-title">Son qəbullar</div>
              <table>
                <thead><tr><th>Tarix</th><th>Kod</th><th>Material</th><th class="right">kq</th><th class="right">Qiymət/kq</th><th class="right">Məbləğ</th><th>Təchizatçı</th><th>Şərh</th></tr></thead>
                <tbody>${items}</tbody>
              </table>
            </div>
          </div>`;
      }

      async function addReceipt() {
        const materialId = $("#rcMat").value;
        const qty = Number($("#rcQty").value);
        const price = Number($("#rcPrice").value);
        const date = $("#rcDate").value || today();
        const supplier = $("#rcSupplier").value.trim();
        const note = $("#rcNote").value.trim();
        
        if (!materialId || qty <= 0 || price < 0) { 
          alert("Material, miqdar (>0) və qiymət (>=0) vacibdir"); 
          return; 
        }
        
        try {
          await apiPOST("/api/receipts", { 
            date, 
            materialId, 
            qtyKg: qty, 
            pricePerKg: price, 
            totalCost: qty * price, 
            supplier, 
            note 
          });
          await fetchReceipts();
          await fetchStock();
          $("#rcQty").value = "";
          $("#rcPrice").value = "";
          $("#rcSupplier").value = "";
          $("#rcNote").value = "";
        } catch (e) {}
      }

      // --- ISSUES ---
      function renderIssue() {
        const options = APP.materials.filter(x => x.isActive !== false)
          .map(x => `<option value="${x.id}">${x.code} — ${x.name}</option>`).join("");
          
        const items = APP.issues.slice().sort((a,b)=> (a.date||"").localeCompare(b.date||""))
          .map(i => {
            const mat = APP.materials.find(m => m.id === i.materialId) || {};
            return `<tr>
              <td>${i.date}</td>
              <td>${mat.code || ""}</td>
              <td>${mat.name || ""}</td>
              <td class="right">${fmtN(i.qtyKg, 3)}</td>
              <td class="right">${fmtMoney(i.avgCostUsed)}</td>
              <td class="right">${fmtMoney(i.totalCostUsed)}</td>
              <td>${i.jobRef || ""}</td>
              <td class="tiny">${i.note || ""}</td>
            </tr>`;
          }).join("") || '<tr><td colspan="8" class="tiny">Silmə yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Silmə / İstifadə</div>
              <div class="row wrap">
                <div style="flex:2 1 260px;"><label>Material</label><select id="isMat">${options}</select></div>
                <div style="flex:1 1 120px;"><label>Miqdar (kq)</label><input id="isQty" type="number" step="0.001"></div>
                <div style="flex:1 1 160px;"><label>Tarix</label><input id="isDate" type="date" value="${today()}"></div>
                <div style="flex:1 1 200px;"><label>İş/Referans</label><input id="isJob" placeholder="#JOB-001"></div>
              </div>
              <label>Şərh</label><textarea id="isNote" placeholder="Səbəb/işçi"></textarea>
              <div class="row" style="justify-content:space-between;margin-top:8px;">
                <div class="tiny">Silmə xərci = cari orta qiymət × kq (server hesablayır)</div>
                <button class="primary" onclick="addIssue()">Silmə əlavə et</button>
              </div>
            </div>
            <div class="card">
              <div class="section-title">Son silmələr</div>
              <table>
                <thead><tr><th>Tarix</th><th>Kod</th><th>Material</th><th class="right">kq</th><th class="right">Orta qiymət</th><th class="right">Məbləğ</th><th>İş</th><th>Şərh</th></tr></thead>
                <tbody>${items}</tbody>
              </table>
            </div>
          </div>`;
      }

      async function addIssue() {
        const materialId = $("#isMat").value;
        const qty = Number($("#isQty").value);
        const date = $("#isDate").value || today();
        const jobRef = $("#isJob").value.trim();
        const note = $("#isNote").value.trim();
        
        if (!materialId || qty <= 0) { 
          alert("Material və miqdar (>0) vacibdir"); 
          return; 
        }
        
        try {
          const receipts = APP.receipts.filter(r => r.materialId === materialId);
          const totalQty = receipts.reduce((a,b) => a + Number(b.qtyKg || 0), 0);
          const totalCost = receipts.reduce((a,b) => a + Number(b.totalCost || 0), 0);
          const avgCost = totalQty > 0 ? totalCost / totalQty : 0;
          
          await apiPOST("/api/issues", { 
            date, 
            materialId, 
            qtyKg: qty,
            avgCostUsed: avgCost,
            totalCostUsed: avgCost * qty,
            jobRef, 
            note 
          });
          await fetchIssues();
          await fetchStock();
          $("#isQty").value = "";
          $("#isJob").value = "";
          $("#isNote").value = "";
        } catch (e) {}
      }

      // --- STOCK ---
      function renderStock() {
        const rows = (APP.stock || []).map(r => {
          const health = r.onHandKg <= (r.minLevel || 0) ? "warn" : "ok";
          return `<tr>
            <td>${r.code || ""}</td>
            <td>${r.name || ""}</td>
            <td class="right">${fmtN(r.onHandKg, 3)}</td>
            <td class="right">${fmtMoney(r.avgCostPerKg)}</td>
            <td class="right">${fmtMoney(r.inventoryValue)}</td>
            <td><span class="badge ${health}">${r.status === "low" || health === "warn" ? "LOW" : "OK"}</span></td>
          </tr>`;
        }).join("") || '<tr><td colspan="6" class="tiny">Anbar məlumatı yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="card">
            <div class="section-title">Anbar qalıqları (kq)</div>
            <table>
              <thead><tr><th>Kod</th><th>Material</th><th class="right">Varlıqdakı (kq)</th><th class="right">Orta qiymət (₼/kq)</th><th class="right">İnventar dəyəri</th><th>Status</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      }

      // --- FINANCE ---
      function renderFinance() {
        const list = (APP.finances || []).slice().sort((a,b)=> (a.date||"").localeCompare(b.date||""))
          .map(f => `<tr>
            <td>${f.date}</td>
            <td>${f.type === "income" ? "Gəlir" : "Xərc"}</td>
            <td>${f.category||""}</td>
            <td>${f.counterparty||""}</td>
            <td class="right">${fmtMoney(f.amountAzn||0)}</td>
            <td class="tiny">${f.note||""}</td>
          </tr>`).join("") || '<tr><td colspan="6" class="tiny">Qeyd yoxdur</td></tr>';
          
        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Gəlir / Xərc</div>
              <div class="row wrap">
                <div style="flex:1 1 140px;"><label>Tip</label><select id="fnType"><option value="income">Gəlir</option><option value="expense">Xərc</option></select></div>
                <div style="flex:2 1 220px;"><label>Kateqoriya</label><input id="fnCat" placeholder="Kira, logistika, satış..."></div>
                <div style="flex:1 1 150px;"><label>Məbləğ (₼)</label><input id="fnAmt" type="number" step="0.01"></div>
                <div style="flex:1 1 160px;"><label>Tarix</label><input id="fnDate" type="date" value="${today()}"></div>
                <div style="flex:2 1 220px;"><label>Kontragent</label><input id="fnCp" placeholder="MMC və ya şəxsin adı"></div>
              </div>
              <label>Qeyd</label><textarea id="fnNote"></textarea>
              <div class="row" style="justify-content:flex-end;margin-top:8px;"><button class="primary" onclick="addFinance()">Əlavə et</button></div>
            </div>
            <div class="card">
              <div class="section-title">Qeydlər</div>
              <table>
                <thead><tr><th>Tarix</th><th>Tip</th><th>Kateqoriya</th><th>Kontragent</th><th class="right">Məbləğ</th><th>Qeyd</th></tr></thead>
                <tbody>${list}</tbody>
              </table>
            </div>
          </div>`;
      }

      async function addFinance() {
        const type = $("#fnType").value;
        const category = $("#fnCat").value.trim();
        const amount = Number($("#fnAmt").value);
        const date = $("#fnDate").value || today();
        const counterparty = $("#fnCp").value.trim();
        const note = $("#fnNote").value.trim();
        
        if (!category || amount < 0) { 
          alert("Kateqoriya və məbləğ daxil edin"); 
          return; 
        }
        
        try {
          await apiPOST("/api/finances", { 
            date, 
            type, 
            category, 
            amountAzn: amount, 
            counterparty, 
            note 
          });
          await fetchFinances();
          await fetchPL();
          $("#fnCat").value = "";
          $("#fnAmt").value = "";
          $("#fnCp").value = "";
          $("#fnNote").value = "";
        } catch (e) {}
      }

      // --- AR / AP ---
      function arRemaining(entry) {
        const paid = (entry.payments || []).reduce((a,b) => a + Number(b.amountAzn || 0), 0);
        return (entry.amountAzn || 0) - paid;
      }
      
      function apRemaining(entry) { 
        return arRemaining(entry); 
      }

      function renderARAP() {
        const arRows = (APP.ar || []).slice().sort((a,b)=> (a.date||"").localeCompare(b.date||""))
          .map(e => `<tr>
            <td>${e.date}</td>
            <td>${e.counterparty||""}</td>
            <td class="right">${fmtMoney(e.amountAzn||0)}</td>
            <td class="right">${fmtMoney(arRemaining(e))}</td>
            <td>${e.status||""}</td>
            <td class="right"><button class="ghost" onclick="addARPayPrompt('${e.id}')">Ödəniş</button></td>
          </tr>`).join("") || '<tr><td colspan="6" class="tiny">Debitor yoxdur</td></tr>';

        const apRows = (APP.ap || []).slice().sort((a,b)=> (a.date||"").localeCompare(b.date||""))
          .map(e => `<tr>
            <td>${e.date}</td>
            <td>${e.counterparty||""}</td>
            <td class="right">${fmtMoney(e.amountAzn||0)}</td>
            <td class="right">${fmtMoney(apRemaining(e))}</td>
            <td>${e.status||""}</td>
            <td class="right"><button class="ghost" onclick="addAPPayPrompt('${e.id}')">Ödəniş</button></td>
          </tr>`).join("") || '<tr><td colspan="6" class="tiny">Kreditor yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Debitorlar (AR)</div>
              <div class="row wrap">
                <div style="flex:2 1 220px;"><label>Kontragent</label><input id="arCp"></div>
                <div style="flex:1 1 160px;"><label>Tarix</label><input id="arDate" type="date" value="${today()}"></div>
                <div style="flex:1 1 150px;"><label>Məbləğ (₼)</label><input id="arAmt" type="number" step="0.01"></div>
                <div style="flex:1 1 160px;"><label>Status</label><select id="arStatus"><option>open</option><option>partial</option><option>closed</option></select></div>
              </div>
              <label>Qeyd</label><textarea id="arNote"></textarea>
              <div class="row" style="justify-content:flex-end;margin-top:8px;"><button class="primary" onclick="addAR()">Əlavə et</button></div>
              <div class="divider"></div>
              <table>
                <thead><tr><th>Tarix</th><th>Kontragent</th><th class="right">Məbləğ</th><th class="right">Qalıq</th><th>Status</th><th class="right">Əməliyyat</th></tr></thead>
                <tbody>${arRows}</tbody>
              </table>
            </div>

            <div class="card">
              <div class="section-title">Kreditorlar (AP)</div>
              <div class="row wrap">
                <div style="flex:2 1 220px;"><label>Kontragent</label><input id="apCp"></div>
                <div style="flex:1 1 160px;"><label>Tarix</label><input id="apDate" type="date" value="${today()}"></div>
                <div style="flex:1 1 150px;"><label>Məbləğ (₼)</label><input id="apAmt" type="number" step="0.01"></div>
                <div style="flex:1 1 160px;"><label>Status</label><select id="apStatus"><option>open</option><option>partial</option><option>closed</option></select></div>
              </div>
              <label>Qeyd</label><textarea id="apNote"></textarea>
              <div class="row" style="justify-content:flex-end;margin-top:8px;"><button class="primary" onclick="addAP()">Əlavə et</button></div>
              <div class="divider"></div>
              <table>
                <thead><tr><th>Tarix</th><th>Kontragent</th><th class="right">Məbləğ</th><th class="right">Qalıq</th><th>Status</th><th class="right">Əməliyyat</th></tr></thead>
                <tbody>${apRows}</tbody>
              </table>
            </div>
          </div>`;
      }

      async function addAR() {
        const counterparty = $("#arCp").value.trim();
        const date = $("#arDate").value || today();
        const amount = Number($("#arAmt").value);
        const status = $("#arStatus").value;
        const note = $("#arNote").value.trim();
        
        if (!counterparty || amount <= 0) { 
          alert("Kontragent və məbləğ (>0) vacibdir"); 
          return; 
        }
        
        try {
          await apiPOST("/api/ar", { 
            counterparty, 
            date, 
            amountAzn: amount, 
            status, 
            payments: [], 
            note 
          });
          await fetchARAP();
          $("#arCp").value = "";
          $("#arAmt").value = "";
          $("#arNote").value = "";
        } catch (e) {}
      }
      
      async function addAP() {
        const counterparty = $("#apCp").value.trim();
        const date = $("#apDate").value || today();
        const amount = Number($("#apAmt").value);
        const status = $("#apStatus").value;
        const note = $("#apNote").value.trim();
        
        if (!counterparty || amount <= 0) { 
          alert("Kontragent və məbləğ (>0) vacibdir"); 
          return; 
        }
        
        try {
          await apiPOST("/api/ap", { 
            counterparty, 
            date, 
            amountAzn: amount, 
            status, 
            payments: [], 
            note 
          });
          await fetchARAP();
          $("#apCp").value = "";
          $("#apAmt").value = "";
          $("#apNote").value = "";
        } catch (e) {}
      }

      async function addARPayPrompt(id) {
        const e = APP.ar.find(x => x.id === id);
        if (!e) return;
        const amt = prompt("Ödəniş məbləği (₼)");
        if (amt === null) return;
        const a = Number(amt);
        if (!(a > 0)) return alert("Yanlış məbləğ");
        
        try {
          await apiPOST(`/api/ar/${id}/payments`, { 
            date: today(), 
            amountAzn: a 
          });
          await fetchARAP();
        } catch (e) {}
      }
      
      async function addAPPayPrompt(id) {
        const e = APP.ap.find(x => x.id === id);
        if (!e) return;
        const amt = prompt("Ödəniş məbləği (₼)");
        if (amt === null) return;
        const a = Number(amt);
        if (!(a > 0)) return alert("Yanlış məbləğ");
        
        try {
          await apiPOST(`/api/ap/${id}/payments`, { 
            date: today(), 
            amountAzn: a 
          });
          await fetchARAP();
        } catch (e) {}
      }

      // --- REPORTS ---
      function renderReports() {
        const from = today().slice(0, 7) + "-01";
        const to = today();
        const p = APP.pl || {};
        
        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Mənfəət/Zərər hesabatı</div>
              <div class="row wrap">
                <div style="flex:1 1 160px;"><label>Başlanğıc</label><input id="rpFrom" type="date" value="${from}"></div>
                <div style="flex:1 1 160px;"><label>Son</label><input id="rpTo" type="date" value="${to}"></div>
                <div style="align-self:flex-end;"><button class="primary" onclick="fetchPL()">Göstər</button></div>
              </div>
              <div id="plBox" style="margin-top:8px;">
                <table>
                  <tbody>
                    <tr><td>Gəlir</td><td class="right">${fmtMoney(p.revenue || 0)}</td></tr>
                    <tr><td>Satılan malın maya dəyəri (COGS)</td><td class="right">${fmtMoney(p.cogs || 0)}</td></tr>
                    <tr><th>Brüt mənfəət</th><th class="right">${fmtMoney(p.grossProfit || 0)}</th></tr>
                    <tr><td>Digər xərclər</td><td class="right">${fmtMoney(p.expenses || 0)}</td></tr>
                    <tr><th>Xalis mənfəət</th><th class="right">${fmtMoney(p.netProfit || 0)}</th></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="card">
              <div class="section-title">Material hərəkətləri</div>
              <div id="mvBox"></div>
            </div>
          </div>`;
        renderMovement();
      }

      function renderMovement() {
        const rows = (APP.movements || []).map(m => {
          return `<tr>
            <td>${m.code}</td>
            <td>${m.name}</td>
            <td class="right">${fmtN(m.inQty, 3)}</td>
            <td class="right">${fmtMoney(m.inSum)}</td>
            <td class="right">${fmtN(m.outQty, 3)}</td>
            <td class="right">${fmtMoney(m.outSum)}</td>
          </tr>`;
        }).join("") || '<tr><td colspan="6" class="tiny">Heç bir məlumat yoxdur</td></tr>';
        
        $("#mvBox").innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Kod</th>
                <th>Material</th>
                <th class="right">Giriş (kq)</th>
                <th class="right">Giriş (₼)</th>
                <th class="right">Çıxış (kq)</th>
                <th class="right">Çıxış (₼)</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>`;
      }

      // ====== PRODUCTS ======
      function renderProducts() {
        const list = APP.products.map(x => `
          <tr>
            <td>${x.code || ""}</td>
            <td>${x.name || ""}</td>
            <td class="tiny">${x.description || ""}</td>
            <td>${x.category || ""}</td>
            <td class="right">${fmtMoney(x.unitPrice || x.salePrice || 0)}</td>
            <td class="right">
              <input type="number" step="1" min="0" value="${x.initialQuantity || 0}" 
                     id="qty_${x.id}" style="width:80px;padding:4px;" 
                     onchange="updateProductQuantity('${x.id}', this.value)">
            </td>
            <td>${x.isActive === false ? '<span class="badge warn">arxiv</span>' : '<span class="badge ok">aktiv</span>'}</td>
          </tr>`).join("") || '<tr><td colspan="7" class="tiny">Məhsul yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Məhsul kataloqu</div>
              <div class="row wrap">
                <div style="flex:1 1 150px;"><label>Kod</label><input id="pCode" placeholder="PRD-001"></div>
                <div style="flex:2 1 200px;"><label>Ad</label><input id="pName" placeholder="Ayaqqabı model A"></div>
                <div style="flex:2 1 200px;"><label>Kateqoriya</label><input id="pCat" placeholder="Ayaqqabı"></div>
                <div style="flex:1 1 150px;"><label>Satış qiyməti (₼)</label><input id="pPrice" type="number" step="0.01"></div>
                <div style="flex:1 1 120px;"><label>İlkin miqdar</label><input id="pInitQty" type="number" step="1" value="0"></div>
              </div>
              <label>Təsvir</label><textarea id="pDesc" placeholder="Məhsul haqqında"></textarea>
              <div class="row" style="justify-content:flex-end;margin-top:8px;">
                <button class="primary" onclick="addProduct()">Məhsul əlavə et</button>
              </div>
            </div>
            <div class="card">
              <div class="section-title">Məhsullar</div>
              <table>
                <thead><tr><th>Kod</th><th>Ad</th><th>Təsvir</th><th>Kateqoriya</th><th class="right">Satış qiyməti</th><th class="right">Miqdar</th><th>Status</th></tr></thead>
                <tbody>${list}</tbody>
              </table>
            </div>
          </div>`;
      }

      async function updateProductQuantity(productId, newQuantity) {
        const qty = Number(newQuantity);
        if (qty < 0) {
          alert("Miqdar mənfi ola bilməz");
          await fetchProducts();
          return;
        }
        
        try {
          await apiPUT(`/api/products/${productId}/quantity`, { quantity: qty });
          await fetchProducts();
          await fetchProductionStock();
        } catch (e) {
          await fetchProducts();
        }
      }

      async function addProduct() {
        const code = $("#pCode").value.trim();
        const name = $("#pName").value.trim();
        const category = $("#pCat").value.trim();
        const price = Number($("#pPrice").value || 0);
        const description = $("#pDesc").value.trim();
        const initialQuantity = Number($("#pInitQty").value || 0);
        
        if (!code || !name) { alert("Kod və adı daxil edin"); return; }
        
        try {
          await apiPOST("/api/products", { 
            code, 
            name, 
            category,
            salePrice: price, 
            description,
            initialQuantity,
            isActive: true 
          });
          await fetchProducts();
          await fetchProductionStock();
          $("#pCode").value = ""; 
          $("#pName").value = ""; 
          $("#pCat").value = "";
          $("#pPrice").value = "";
          $("#pDesc").value = "";
          $("#pInitQty").value = "0";
        } catch (e) {}
      }

      // ====== PRODUCTION ======
      function renderProduction() {
        const productOptions = APP.products.filter(x => x.isActive !== false)
          .map(x => `<option value="${x.id}">${x.code} — ${x.name}</option>`).join("");
        
        const items = APP.production.slice().sort((a,b)=> (a.date||"").localeCompare(b.date||""))
          .map(p => {
            const prod = APP.products.find(pr => pr.id === p.productId) || {};
            return `<tr>
              <td>${p.orderNumber}</td>
              <td>${p.date}</td>
              <td>${prod.code || ""}</td>
              <td>${prod.name || ""}</td>
              <td class="right">${fmtN(p.quantity, 0)}</td>
              <td class="right">${fmtMoney(p.totalCost)}</td>
              <td><span class="badge ${p.status === 'completed' ? 'ok' : 'warn'}">${p.status}</span></td>
              <td class="tiny">${p.note || ""}</td>
            </tr>`;
          }).join("") || '<tr><td colspan="8" class="tiny">İstehsal yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">İstehsal sifarişi</div>
              <div class="row wrap">
                <div style="flex:1 1 150px;"><label>Sifariş №</label><input id="prodOrderNum" placeholder="ORD-001"></div>
                <div style="flex:2 1 200px;"><label>Məhsul</label><select id="prodProduct">${productOptions}</select></div>
                <div style="flex:1 1 120px;"><label>Miqdar (ədəd)</label><input id="prodQty" type="number" step="1"></div>
                <div style="flex:1 1 160px;"><label>Tarix</label><input id="prodDate" type="date" value="${today()}"></div>
              </div>
              <div class="section-title" style="margin-top:12px;">İstifadə olunan xammallar</div>
              <div id="prodMaterials"></div>
              <button onclick="addProdMaterialRow()" style="margin-top:8px;">+ Xammal əlavə et</button>
              <label style="margin-top:12px;">Qeyd</label><textarea id="prodNote"></textarea>
              <div class="row" style="justify-content:flex-end;margin-top:8px;">
                <button class="primary" onclick="addProduction()">İstehsal et</button>
              </div>
            </div>
            <div class="card">
              <div class="section-title">İstehsal tarixçəsi</div>
              <table>
                <thead><tr><th>Sifariş №</th><th>Tarix</th><th>Kod</th><th>Məhsul</th><th class="right">Miqdar</th><th class="right">Maya</th><th>Status</th><th>Qeyd</th></tr></thead>
                <tbody>${items}</tbody>
              </table>
            </div>
          </div>`;
        
        addProdMaterialRow();
      }

      let prodMatRowCounter = 0;
      function addProdMaterialRow() {
        const matOptions = APP.materials.filter(x => x.isActive !== false)
          .map(x => `<option value="${x.id}">${x.code} — ${x.name}</option>`).join("");
        
        const row = document.createElement("div");
        row.className = "row wrap";
        row.style.marginBottom = "8px";
        row.id = `prodMatRow${prodMatRowCounter}`;
        row.innerHTML = `
          <div style="flex:2 1 200px;"><label>Xammal</label><select class="prodMat">${matOptions}</select></div>
          <div style="flex:1 1 120px;"><label>Miqdar (kq)</label><input type="number" step="0.001" class="prodMatQty"></div>
          <div style="align-self:flex-end;"><button class="ghost" onclick="document.getElementById('prodMatRow${prodMatRowCounter}').remove()">Sil</button></div>
        `;
        $("#prodMaterials").appendChild(row);
        prodMatRowCounter++;
      }

      async function addProduction() {
        const orderNumber = $("#prodOrderNum").value.trim();
        const productId = $("#prodProduct").value;
        const quantity = Number($("#prodQty").value);
        const date = $("#prodDate").value || today();
        const note = $("#prodNote").value.trim();

        if (!orderNumber || !productId || quantity <= 0) {
          alert("Sifariş №, məhsul və miqdar (>0) vacibdir");
          return;
        }

        const materialsUsed = [];
        document.querySelectorAll("#prodMaterials .row").forEach(row => {
          const matId = row.querySelector(".prodMat").value;
          const qty = Number(row.querySelector(".prodMatQty").value || 0);
          if (matId && qty > 0) {
            materialsUsed.push({ materialId: matId, qtyUsed: qty, costUsed: 0 });
          }
        });

        if (materialsUsed.length === 0) {
          alert("Ən azı bir xammal əlavə edin");
          return;
        }

        try {
          await apiPOST("/api/production", {
            orderNumber,
            date,
            productId,
            quantity,
            materialsUsed,
            status: "completed",
            note
          });
          await fetchProduction();
          await fetchProductionStock();
          await fetchStock();
          $("#prodOrderNum").value = "";
          $("#prodQty").value = "";
          $("#prodNote").value = "";
          $("#prodMaterials").innerHTML = "";
          prodMatRowCounter = 0;
          addProdMaterialRow();
        } catch (e) {}
      }

      // ====== PRODUCTION STOCK ======
      function renderProductionStock() {
        const rows = (APP.productionStock || []).map(s => {
          return `<tr>
            <td>${s.productCode || ""}</td>
            <td>${s.productName || ""}</td>
            <td class="right">${fmtN(s.quantity, 0)}</td>
            <td class="right">${fmtMoney(s.avgCost)}</td>
            <td class="right">${fmtMoney(s.totalValue)}</td>
          </tr>`;
        }).join("") || '<tr><td colspan="5" class="tiny">İstehsal anbarında məhsul yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="card">
            <div class="section-title">İstehsal anbarı (Fabrik)</div>
            <table>
              <thead><tr><th>Kod</th><th>Məhsul</th><th class="right">Miqdar (ədəd)</th><th class="right">Orta maya</th><th class="right">Ümumi dəyər</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      }

      // ====== STORE TRANSFER ======
      function renderStoreTransfer() {
        console.log("renderStoreTransfer çağırıldı");
        console.log("APP.productionStock:", APP.productionStock);
        
        // Boş array varsa, düzgün mesaj göstər
        if (!APP.productionStock || APP.productionStock.length === 0) {
          const productOptions = '<option value="">Hazırda anbar boşdur (məlumat yüklənir...)</option>';
          
          $("#view").innerHTML = `
            <div class="grid cols-2">
              <div class="card">
                <div class="section-title">Mağazaya köçürmə</div>
                <div style="padding:20px;text-align:center;color:#f59e0b;">
                  ⚠️ İstehsal anbarı boşdur və ya məlumat yüklənir.<br>
                  Əvvəlcə məhsul istehsal edin və ya səhifəni yeniləyin.
                </div>
                <div class="row wrap">
                  <div style="flex:2 1 260px;"><label>Məhsul</label><select id="trProduct" disabled>${productOptions}</select></div>
                  <div style="flex:1 1 120px;"><label>Miqdar (ədəd)</label><input id="trQty" type="number" step="1" disabled></div>
                  <div style="flex:1 1 160px;"><label>Tarix</label><input id="trDate" type="date" value="${today()}" disabled></div>
                </div>
                <label>Qeyd</label><textarea id="trNote" disabled></textarea>
                <div class="row" style="justify-content:space-between;margin-top:8px;">
                  <button onclick="fetchProductionStock().then(() => renderStoreTransfer())">🔄 Yenilə</button>
                  <button class="primary" disabled>Mağazaya köçür</button>
                </div>
              </div>
              <div class="card">
                <div class="section-title">Köçürmə tarixçəsi</div>
                <table>
                  <thead><tr><th>Tarix</th><th>Kod</th><th>Məhsul</th><th class="right">Miqdar</th><th class="right">Maya/ədəd</th><th class="right">Cəm</th><th>Qeyd</th></tr></thead>
                  <tbody><tr><td colspan="7" class="tiny">Transfer yoxdur</td></tr></tbody>
                </table>
              </div>
            </div>`;
          return;
        }
        
        const productOptions = (APP.productionStock || [])
          .filter(s => (s.quantity || 0) > 0)
          .map(s => `<option value="${s.productId}">${s.productCode} — ${s.productName} (${fmtN(s.quantity, 0)} ədəd)</option>`)
          .join("");

        const items = APP.storeTransfers.slice().sort((a,b)=> (a.date||"").localeCompare(b.date||""))
          .map(t => {
            return `<tr>
              <td>${t.date}</td>
              <td>${t.productCode || ""}</td>
              <td>${t.productName || ""}</td>
              <td class="right">${fmtN(t.quantity, 0)}</td>
              <td class="right">${fmtMoney(t.costPerUnit)}</td>
              <td class="right">${fmtMoney(t.totalCost)}</td>
              <td class="tiny">${t.note || ""}</td>
            </tr>`;
          }).join("") || '<tr><td colspan="7" class="tiny">Transfer yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Mağazaya köçürmə</div>
              <div class="row wrap">
                <div style="flex:2 1 260px;"><label>Məhsul</label><select id="trProduct">${productOptions || '<option value="">Məhsul yoxdur</option>'}</select></div>
                <div style="flex:1 1 120px;"><label>Miqdar (ədəd)</label><input id="trQty" type="number" step="1"></div>
                <div style="flex:1 1 160px;"><label>Tarix</label><input id="trDate" type="date" value="${today()}"></div>
              </div>
              <label>Qeyd</label><textarea id="trNote"></textarea>
              <div class="row" style="justify-content:space-between;margin-top:8px;">
                <button onclick="fetchProductionStock().then(() => renderStoreTransfer())">🔄 Yenilə</button>
                <button class="primary" onclick="addStoreTransfer()">Mağazaya köçür</button>
              </div>
            </div>
            <div class="card">
              <div class="section-title">Köçürmə tarixçəsi</div>
              <table>
                <thead><tr><th>Tarix</th><th>Kod</th><th>Məhsul</th><th class="right">Miqdar</th><th class="right">Maya/ədəd</th><th class="right">Cəm</th><th>Qeyd</th></tr></thead>
                <tbody>${items}</tbody>
              </table>
            </div>
          </div>`;
      }

      async function addStoreTransfer() {
        const productId = $("#trProduct").value;
        const quantity = Number($("#trQty").value);
        const date = $("#trDate").value || today();
        const note = $("#trNote").value.trim();

        if (!productId || quantity <= 0) {
          alert("Məhsul və miqdar (>0) vacibdir");
          return;
        }

        try {
          await apiPOST("/api/store-transfers", {
            date,
            productId,
            quantity,
            note
          });
          
          // Uğurlu transfer sonrası
          alert("✅ Transfer uğurla həyata keçirildi!");
          
          // Bütün əlaqəli data-ları yenilə
          await Promise.all([
            fetchStoreTransfers(),
            fetchProductionStock(),
            fetchStoreStock()
          ]);
          
          // View-ı yenilə
          renderStoreTransfer();
          
          // Formu təmizlə
          $("#trQty").value = "";
          $("#trNote").value = "";
        } catch (e) {
          console.error("Transfer xətası:", e);
        }
      }

      // ====== STORE STOCK ======
      function renderStoreStock() {
        const rows = (APP.storeStock || []).map(s => {
          return `<tr>
            <td>${s.productCode || ""}</td>
            <td>${s.productName || ""}</td>
            <td class="right">${fmtN(s.quantity, 0)}</td>
            <td class="right">${fmtMoney(s.avgCost)}</td>
            <td class="right">${fmtMoney(s.unitPrice)}</td>
            <td class="right">${fmtMoney(s.totalValue)}</td>
          </tr>`;
        }).join("") || '<tr><td colspan="6" class="tiny">Mağaza anbarında məhsul yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="card">
            <div class="section-title">Mağaza anbarı</div>
            <table>
              <thead><tr><th>Kod</th><th>Məhsul</th><th class="right">Miqdar (ədəd)</th><th class="right">Orta maya</th><th class="right">Satış qiyməti</th><th class="right">Dəyər</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      }

      // ====== STORE SALES ======
      function renderStoreSales() {
        const productOptions = (APP.storeStock || [])
          .filter(s => s.quantity > 0)
          .map(s => `<option value="${s.productId}">${s.productCode} — ${s.productName} (${fmtN(s.quantity, 0)} ədəd - ${fmtMoney(s.unitPrice)})</option>`)
          .join("");

        const items = APP.storeSales.slice().sort((a,b)=> (a.date||"").localeCompare(b.date||""))
          .map(sale => {
            const prod = APP.products.find(p => p.id === sale.productId) || {};
            return `<tr>
              <td>${sale.date}</td>
              <td>${prod.code || ""}</td>
              <td>${prod.name || ""}</td>
              <td class="right">${fmtN(sale.quantity, 0)}</td>
              <td class="right">${fmtMoney(sale.salePrice)}</td>
              <td class="right">${fmtMoney(sale.totalRevenue)}</td>
              <td class="right">${fmtMoney(sale.profit)}</td>
              <td>${sale.customer || ""}</td>
              <td class="tiny">${sale.note || ""}</td>
            </tr>`;
          }).join("") || '<tr><td colspan="9" class="tiny">Satış yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Satış</div>
              <div class="row wrap">
                <div style="flex:2 1 200px;"><label>Məhsul</label><select id="saleProduct">${productOptions}</select></div>
                <div style="flex:1 1 100px;"><label>Miqdar</label><input id="saleQty" type="number" step="1"></div>
                <div style="flex:1 1 140px;"><label>Satış qiyməti (₼)</label><input id="salePrice" type="number" step="0.01"></div>
                <div style="flex:1 1 160px;"><label>Tarix</label><input id="saleDate" type="date" value="${today()}"></div>
                <div style="flex:2 1 200px;"><label>Müştəri</label><input id="saleCustomer" placeholder="Müştəri adı"></div>
              </div>
              <label>Qeyd</label><textarea id="saleNote"></textarea>
              <div class="row" style="justify-content:flex-end;margin-top:8px;">
                <button class="primary" onclick="addStoreSale()">Satış et</button>
              </div>
            </div>
            <div class="card">
              <div class="section-title">Satış tarixçəsi</div>
              <table>
                <thead><tr><th>Tarix</th><th>Kod</th><th>Məhsul</th><th class="right">Miqdar</th><th class="right">Qiymət</th><th class="right">Gəlir</th><th class="right">Mənfəət</th><th>Müştəri</th><th>Qeyd</th></tr></thead>
                <tbody>${items}</tbody>
              </table>
            </div>
          </div>`;
        
        $("#saleProduct").addEventListener("change", function() {
          const prodId = this.value;
          const prod = APP.products.find(p => p.id === prodId);
          if (prod) {
            $("#salePrice").value = prod.unitPrice || prod.salePrice || 0;
          }
        });
        
        if (APP.products.length && $("#saleProduct").value) {
          const prod = APP.products.find(p => p.id === $("#saleProduct").value);
          if (prod) $("#salePrice").value = prod.unitPrice || prod.salePrice || 0;
        }
      }

      async function addStoreSale() {
        const productId = $("#saleProduct").value;
        const quantity = Number($("#saleQty").value);
        const salePrice = Number($("#salePrice").value);
        const date = $("#saleDate").value || today();
        const customer = $("#saleCustomer").value.trim();
        const note = $("#saleNote").value.trim();

        if (!productId || quantity <= 0 || salePrice <= 0) {
          alert("Məhsul, miqdar və qiymət (>0) vacibdir");
          return;
        }

        try {
          await apiPOST("/api/store-sales", {
            date,
            productId,
            quantity,
            salePrice,
            customer,
            note
          });
          await fetchStoreSales();
          await fetchStoreStock();
          $("#saleQty").value = "";
          $("#saleCustomer").value = "";
          $("#saleNote").value = "";
        } catch (e) {}
      }

      // ====== İNİT ======
      function renderView() {
        if (currentTab === "materials") renderMaterials();
        else if (currentTab === "receipt") renderReceipt();
        else if (currentTab === "issue") renderIssue();
        else if (currentTab === "stock") renderStock();
        else if (currentTab === "products") renderProducts();
        else if (currentTab === "production") renderProduction();
        else if (currentTab === "prodstock") renderProductionStock();
        else if (currentTab === "storetransfer") renderStoreTransfer();
        else if (currentTab === "storestock") renderStoreStock();
        else if (currentTab === "storesales") renderStoreSales();
        else if (currentTab === "finance") renderFinance();
        else if (currentTab === "arap") renderARAP();
        else if (currentTab === "reports") renderReports();
      }

      async function refreshAll() {
        try {
          await fetchMaterials();
          await fetchStock();
        } catch (e) {
          console.warn("refreshAll error", e);
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        $("#baseUrl").textContent = BASE;
        renderTabs();
        renderView();
        await refreshAll();
      });

    </script>
  </body>
</html>