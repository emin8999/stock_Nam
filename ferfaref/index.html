<!DOCTYPE html>
<html lang="az">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Material anbarı (kq) • Maliyyə (Gəlir/Xərc, AR/AP) — AZN</title>
    <style>
      :root {
        --bg: #0b1020;
        --card: #0f172a;
        --text: #e5e7eb;
        --muted: #94a3b8;
        --border: #27324a;
        --pill: #0b1220;
        --accent: #38bdf8;
        --ok: #22c55e;
        --warn: #f59e0b;
        --bad: #ef4444;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      }
      .app {
        max-width: 1260px;
        margin: 0 auto;
        padding: 20px;
      }
      h1 {
        margin: 0 0 8px;
        font-size: 22px;
      }
      .sub {
        color: var(--muted);
        font-size: 12px;
      }
      .tabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin: 12px 0 16px;
      }
      .tab {
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #0b1220;
        color: #cbd5e1;
        font-weight: 600;
        cursor: pointer;
      }
      .tab.active {
        background: linear-gradient(135deg, #2563eb, #06b6d4);
        color: #fff;
        border: none;
      }
      .grid {
        display: grid;
        gap: 12px;
      }
      .cols-2 {
        grid-template-columns: repeat(2, 1fr);
      }
      .cols-3 {
        grid-template-columns: repeat(3, 1fr);
      }
      .cols-4 {
        grid-template-columns: repeat(4, 1fr);
      }
      @media (max-width: 1024px) {
        .cols-4 {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (max-width: 720px) {
        .cols-4,
        .cols-3,
        .cols-2 {
          grid-template-columns: 1fr;
        }
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 14px;
      }
      .kpi {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .kpi .val {
        font-size: 22px;
        font-weight: 800;
      }
      .muted {
        color: var(--muted);
      }
      .tiny {
        font-size: 11px;
        color: var(--muted);
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .row.wrap {
        flex-wrap: wrap;
      }
      label {
        font-size: 12px;
        color: var(--muted);
        display: block;
        margin-bottom: 6px;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #0b1220;
        color: var(--text);
      }
      textarea {
        min-height: 72px;
      }
      button {
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #0b1220;
        color: var(--text);
        cursor: pointer;
      }
      button.primary {
        background: linear-gradient(135deg, #2563eb, #06b6d4);
        border: none;
        color: #fff;
      }
      button.ghost {
        background: transparent;
      }
      .danger {
        color: #fecaca;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        text-align: left;
        padding: 10px;
        border-bottom: 1px dashed var(--border);
        font-size: 14px;
      }
      th {
        color: var(--muted);
        font-weight: 700;
      }
      .right {
        text-align: right;
      }
      .badge {
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--pill);
        font-size: 12px;
      }
      .badge.ok {
        color: var(--ok);
        border-color: #22c55e30;
        background: #22c55e10;
      }
      .badge.warn {
        color: var(--warn);
        border-color: #f59e0b30;
        background: #f59e0b10;
      }
      .badge.bad {
        color: var(--bad);
        border-color: #ef444430;
        background: #ef444410;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .pill {
        border: 1px solid var(--border);
        background: var(--pill);
        border-radius: 999px;
        padding: 6px 10px;
        display: inline-flex;
        gap: 8px;
        align-items: center;
      }
      .divider {
        height: 1px;
        background: var(--border);
        margin: 12px 0;
      }
      .foot {
        margin-top: 12px;
        color: var(--muted);
        font-size: 12px;
      }
      .section-title {
        font-size: 16px;
        font-weight: 800;
        margin-bottom: 10px;
      }
      .loader {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 2px solid #ffffff25;
        border-top-color: #06b6d4;
        animation: spin 1s linear infinite;
        display: inline-block;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
    </style>
  </head>
  <body>
    <div class="app">
      <h1>Material anbarı (kq) + Maliyyə (AR/AP)</h1>
      <div class="sub">
        Valyuta: <b>AZN (₼)</b> • Ölçü vahidi: <b>kq</b> • Bütün əməliyyatlar API ilə həyata keçirilir • Server:
        <b id="baseUrl">http://116.203.51.133</b>
      </div>

      <!-- KPI -->
      <div class="grid cols-4" style="margin-top: 12px">
        <div class="card kpi">
          <div>
            <div class="muted">Material qalığı</div>
            <div class="val" id="kpiOnHandKg">0</div>
          </div>
          <span class="badge">kq</span>
        </div>
        <div class="card kpi">
          <div>
            <div class="muted">İnventar dəyəri</div>
            <div class="val" id="kpiInvValue">₼ 0</div>
          </div>
          <span class="badge">AZN</span>
        </div>
        <div class="card kpi">
          <div>
            <div class="muted">Dövür üzrə gəlir</div>
            <div class="val" id="kpiRevenue">₼ 0</div>
          </div>
          <span class="badge">AZN</span>
        </div>
        <div class="card kpi">
          <div>
            <div class="muted">Dövür üzrə xalis mənfəət</div>
            <div class="val" id="kpiNet">₼ 0</div>
          </div>
          <span class="badge ok" id="kpiNetBadge">OK</span>
        </div>
      </div>

      <div class="tabs" id="tabs"></div>
      <div id="view"></div>

      <div class="foot">
        Məsləhət: əvvəlcə material kataloqunu əlavə edin, sonra gələn və silinən qeydləri yaradın. Hər sorğunun cavabına server baxın.
      </div>
    </div>

    <script>
      // ====== KONFİGURASİYA ======
      const BASE = "http://116.203.51.133";
      const API_HEADERS = {
        "Content-Type": "application/json"
        // Əgər token varsa buraya əlavə et, məsələn:
        // "Authorization": "Bearer YOUR_TOKEN_HERE"
      };

      // helperlər
      const $ = s => document.querySelector(s);
      const fmtN = (n, d = 2) =>
        (n ?? 0).toLocaleString(undefined, { maximumFractionDigits: d });
      const fmtMoney = n => `₼ ${fmtN(n, 2)}`;
      const today = () => new Date().toISOString().slice(0, 10);
      const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

      // TABS
      const TABS = [
        { id: "materials", name: "Materiallar" },
        { id: "receipt", name: "Qəbul" },
        { id: "issue", name: "Silmə" },
        { id: "stock", name: "Anbar" },
        { id: "finance", name: "Maliyyə (Gəlir/Xərc)" },
        { id: "arap", name: "Debitor/Kreditor (AR/AP)" },
        { id: "reports", name: "Hesabatlar" },
        { id: "settings", name: "Parametrlər" },
      ];
      let currentTab = "materials";

      // APP STATE (server əsaslı)
      const APP = {
        materials: [],
        receipts: [],
        issues: [],
        stock: [],
        finances: [],
        ar: [],
        ap: [],
        kpi: null,
      };

      // render tabs
      function renderTabs() {
        $("#tabs").innerHTML = TABS.map(
          (t) =>
            `<button class="tab ${currentTab === t.id ? "active" : ""}" onclick="switchTab('${t.id}')">${t.name}</button>`
        ).join("");
      }
      function switchTab(id) {
        currentTab = id;
        renderTabs();
        renderView();
        // avtomatik fetch
        if (id === "materials") fetchMaterials();
        if (id === "receipt") fetchReceipts();
        if (id === "issue") fetchIssues();
        if (id === "stock") fetchStock();
        if (id === "finance") fetchFinances();
        if (id === "arap") fetchARAP();
        if (id === "reports") fetchPL();
        if (id === "settings") fetchSettings();
      }

      // ====== API helpers ======
      async function apiGET(path) {
        try {
          const res = await fetch(BASE + path, { method: "GET", headers: API_HEADERS });
          if (!res.ok) {
            const text = await res.text().catch(()=>"");
            throw new Error(`HTTP ${res.status} ${text}`);
          }
          return await res.json();
        } catch (e) {
          console.error("GET", path, e);
          alert(`Server xətası GET ${path} — Konsolu yoxla (F12).`);
          throw e;
        }
      }
      async function apiPOST(path, body) {
        try {
          const res = await fetch(BASE + path, {
            method: "POST",
            headers: API_HEADERS,
            body: JSON.stringify(body),
          });
          if (!res.ok) {
            const text = await res.text().catch(()=>"");
            throw new Error(`HTTP ${res.status} ${text}`);
          }
          return await res.json();
        } catch (e) {
          console.error("POST", path, e);
          alert(`Server xətası POST ${path} — Konsolu yoxla (F12).`);
          throw e;
        }
      }
      async function apiPUT(path, body) {
        try {
          const res = await fetch(BASE + path, {
            method: "PUT",
            headers: API_HEADERS,
            body: JSON.stringify(body),
          });
          if (!res.ok) {
            const text = await res.text().catch(()=>"");
            throw new Error(`HTTP ${res.status} ${text}`);
          }
          return await res.json();
        } catch (e) {
          console.error("PUT", path, e);
          alert(`Server xətası PUT ${path} — Konsolu yoxla (F12).`);
          throw e;
        }
      }

      // ====== FETCH data from server ======
      async function fetchMaterials() {
        const data = await apiGET("/api/materials");
        // gözlənilən cavab ya array, ya {data: [...]}
        APP.materials = Array.isArray(data) ? data : (data.data || []);
        renderMaterials();
      }
      async function fetchReceipts() {
        const data = await apiGET("/api/receipts");
        APP.receipts = Array.isArray(data) ? data : (data.data || []);
        renderReceipt();
      }
      async function fetchIssues() {
        const data = await apiGET("/api/issues");
        APP.issues = Array.isArray(data) ? data : (data.data || []);
        renderIssue();
      }
      async function fetchStock() {
        const data = await apiGET("/api/stock");
        APP.stock = Array.isArray(data) ? data : (data.data || []);
        // KPI endpoint (əgər varsa)
        try {
          const k = await apiGET("/api/kpi");
          APP.kpi = k;
        } catch (e) {
          APP.kpi = null;
        }
        renderStock();
        updateKPIBox();
      }
      async function fetchFinances() {
        const data = await apiGET("/api/finances");
        APP.finances = Array.isArray(data) ? data : (data.data || []);
        renderFinance();
      }
      async function fetchARAP() {
        const ar = await apiGET("/api/ar");
        APP.ar = Array.isArray(ar) ? ar : (ar.data || []);
        const ap = await apiGET("/api/ap");
        APP.ap = Array.isArray(ap) ? ap : (ap.data || []);
        renderARAP();
      }
      async function fetchPL() {
        // default period: bu ay
        const from = today().slice(0, 7) + "-01";
        const to = today();
        const data = await apiGET(`/api/reports/pl?from=${from}&to=${to}`);
        APP.pl = data || {};
        renderReports();
        // update KPI from PL if mövcudsa
        if (data && typeof data.net !== "undefined") {
          APP.kpi = { net: data.net, revenue: data.revenue, inv_value: APP.kpi ? APP.kpi.inv_value : 0 };
          updateKPIBox();
        }
      }
      async function fetchSettings() {
        try {
          const s = await apiGET("/api/settings");
          APP.settings = s || {};
          renderSettings();
        } catch (e) {
          APP.settings = {};
          renderSettings();
        }
      }

      // ====== RENDER / UI funksiyaları ======
      function updateKPIBox() {
        // fallback hesablamalar əgər serverdən kpi gəlmirsə client-based
        let onHandKg = 0, inv = 0;
        if (Array.isArray(APP.stock) && APP.stock.length) {
          APP.stock.forEach(s => { onHandKg += Number(s.onHand || s.qty || 0); inv += Number(s.inv || s.inv_value || 0); });
        } else {
          // alternativ: receipts/issues əsasında
          APP.materials.forEach(m => {
            const inQty = APP.receipts.filter(r => r.material_id === m.id).reduce((a,b)=>a+Number(b.qty_kg||0),0);
            const outQty = APP.issues.filter(i => i.material_id === m.id).reduce((a,b)=>a+Number(b.qty_kg||0),0);
            const on = inQty - outQty;
            onHandKg += on;
            const avg = (APP.receipts.filter(r => r.material_id === m.id).reduce((a,b)=>a + Number(b.total_cost||0),0) /
                         Math.max(1, APP.receipts.filter(r => r.material_id === m.id).reduce((a,b)=>a + Number(b.qty_kg||0),0))) || 0;
            inv += on * avg;
          });
        }
        $("#kpiOnHandKg").textContent = fmtN(onHandKg, 3);
        $("#kpiInvValue").textContent = fmtMoney(inv);
        if (APP.kpi) {
          $("#kpiRevenue").textContent = fmtMoney(APP.kpi.revenue || 0);
          $("#kpiNet").textContent = fmtMoney(APP.kpi.net || 0);
          const badge = $("#kpiNetBadge");
          if ((APP.kpi.net || 0) >= 0) { badge.textContent = "OK"; badge.className = "badge ok"; }
          else { badge.textContent = "NEG"; badge.className = "badge bad"; }
        }
      }

      // --- MATERIALS ---
      function renderMaterials() {
        const list = APP.materials.map(x => `
          <tr>
            <td>${x.code || ""}</td>
            <td>${x.name || ""}</td>
            <td>kq</td>
            <td class="right">${fmtN(x.min_level ?? 0, 3)}</td>
            <td>${x.is_active === false ? '<span class="badge warn">arxiv</span>' : '<span class="badge ok">aktiv</span>'}</td>
            <td class="right"><button class="ghost" onclick="toggleMat('${x.id}')">${x.is_active === false ? "Arxivdən çıxar" : "Arxivlə"}</button></td>
          </tr>`).join("") || '<tr><td colspan="6" class="tiny">Material yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Material bələdçisi</div>
              <div class="row wrap">
                <div style="flex:1 1 150px;"><label>Kod</label><input id="mCode" placeholder="MTL-001"></div>
                <div style="flex:2 1 260px;"><label>Ad</label><input id="mName" placeholder="Poliamid qranul"></div>
                <div style="flex:1 1 120px;"><label>Minimum qalıq (kq)</label><input id="mMin" type="number" step="0.001" value="0"></div>
              </div>
              <div class="row" style="justify-content:flex-end;margin-top:8px;">
                <button class="primary" onclick="addMaterial()">Material əlavə et</button>
              </div>
            </div>
            <div class="card">
              <div class="section-title">Materiallar</div>
              <table>
                <thead><tr><th>Kod</th><th>Ad</th><th>Vahid</th><th class="right">Minimum qalıq</th><th>Status</th><th class="right">Əməliyyatlar</th></tr></thead>
                <tbody>${list}</tbody>
              </table>
            </div>
          </div>`;
      }

      async function addMaterial() {
        const code = $("#mCode").value.trim();
        const name = $("#mName").value.trim();
        const min = Number($("#mMin").value || 0);
        if (!code || !name) { alert("Kod və adı daxil edin"); return; }
        try {
          await apiPOST("/api/materials", { code, name, uom: "kg", min_level: min, is_active: true });
          await fetchMaterials();
          $("#mCode").value = ""; $("#mName").value = ""; $("#mMin").value = "0";
        } catch (e) { /* xəta alertlari api helpers */ }
      }

      async function toggleMat(id) {
        try {
          const mat = APP.materials.find(m => m.id === id);
          if (!mat) return;
          const updated = Object.assign({}, mat, { is_active: mat.is_active === false ? true : false });
          // Çox backend-də update üçün PUT /api/materials/{id} istifadə olunur.
          // Əgər serverdə PUT yoxdursa, buranı serverinə uyğun dəyişsən.
          try {
            await apiPUT(`/api/materials/${id}`, updated);
          } catch (e) {
            // PUT yoxdur isə bəlkə POST ilə update dəstəklənir:
            try { await apiPOST("/api/materials", updated); } catch(e2){ throw e2; }
          }
          await fetchMaterials();
        } catch (e) {}
      }

      // --- RECEIPTS ---
      function renderReceipt() {
        const options = APP.materials.filter(x => x.is_active !== false).map(x => `<option value="${x.id}">${x.code} — ${x.name}</option>`).join("");
        const items = APP.receipts.slice().sort((a,b)=> (a.date||"").localeCompare(b.date||"")).map(r => {
          const mat = APP.materials.find(m => m.id === r.material_id) || {};
          return `<tr>
            <td>${r.date}</td>
            <td>${mat.code || ""}</td>
            <td>${mat.name || ""}</td>
            <td class="right">${fmtN(r.qty_kg, 3)}</td>
            <td class="right">${fmtMoney(r.price_per_kg)}</td>
            <td class="right">${fmtMoney(r.total_cost)}</td>
            <td>${r.supplier || ""}</td>
            <td class="tiny">${r.note || ""}</td>
          </tr>`;
        }).join("") || '<tr><td colspan="8" class="tiny">Qəbul yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Material qəbulu</div>
              <div class="row wrap">
                <div style="flex:2 1 260px;"><label>Material</label><select id="rcMat">${options}</select></div>
                <div style="flex:1 1 120px;"><label>Miqdar (kq)</label><input id="rcQty" type="number" step="0.001"></div>
                <div style="flex:1 1 140px;"><label>1 kq üçün qiymət (₼)</label><input id="rcPrice" type="number" step="0.01"></div>
                <div style="flex:1 1 160px;"><label>Tarix</label><input id="rcDate" type="date" value="${today()}"></div>
                <div style="flex:1 1 200px;"><label>Təchizatçı</label><input id="rcSupplier" placeholder="MMC Təchizatçı"></div>
              </div>
              <label>Şərh</label><textarea id="rcNote" placeholder="Partiya/qaimə"></textarea>
              <div class="row" style="justify-content:space-between;margin-top:8px;">
                <div class="tiny">Cəm = kq × qiymət/kq</div>
                <button class="primary" onclick="addReceipt()">Qəbulu əlavə et</button>
              </div>
            </div>
            <div class="card">
              <div class="section-title">Son qəbullar</div>
              <table>
                <thead><tr><th>Tarix</th><th>Kod</th><th>Material</th><th class="right">kq</th><th class="right">Qiymət/kq</th><th class="right">Məbləğ</th><th>Təchizatçı</th><th>Şərh</th></tr></thead>
                <tbody>${items}</tbody>
              </table>
            </div>
          </div>`;
      }

      async function addReceipt() {
        const material_id = $("#rcMat").value;
        const qty = Number($("#rcQty").value);
        const price = Number($("#rcPrice").value);
        const date = $("#rcDate").value || today();
        const supplier = $("#rcSupplier").value.trim();
        const note = $("#rcNote").value.trim();
        if (!material_id || qty <= 0 || price < 0) { alert("Material, miqdar (>0) və qiymət (>=0) vacibdir"); return; }
        try {
          await apiPOST("/api/receipts", { date, material_id, qty_kg: qty, price_per_kg: price, total_cost: qty * price, supplier, note });
          await fetchReceipts();
          await fetchStock();
        } catch (e) {}
      }

      // --- ISSUES ---
      function renderIssue() {
        const options = APP.materials.filter(x => x.is_active !== false).map(x => `<option value="${x.id}">${x.code} — ${x.name}</option>`).join("");
        const items = APP.issues.slice().sort((a,b)=> (a.date||"").localeCompare(b.date||"")).map(i => {
          const mat = APP.materials.find(m => m.id === i.material_id) || {};
          return `<tr>
            <td>${i.date}</td>
            <td>${mat.code || ""}</td>
            <td>${mat.name || ""}</td>
            <td class="right">${fmtN(i.qty_kg, 3)}</td>
            <td class="right">${fmtMoney(i.avg_cost_used)}</td>
            <td class="right">${fmtMoney(i.total_cost_used)}</td>
            <td>${i.job_ref || ""}</td>
            <td class="tiny">${i.note || ""}</td>
          </tr>`;
        }).join("") || '<tr><td colspan="8" class="tiny">Silmə yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Silmə / İstifadə</div>
              <div class="row wrap">
                <div style="flex:2 1 260px;"><label>Material</label><select id="isMat">${options}</select></div>
                <div style="flex:1 1 120px;"><label>Miqdar (kq)</label><input id="isQty" type="number" step="0.001"></div>
                <div style="flex:1 1 160px;"><label>Tarix</label><input id="isDate" type="date" value="${today()}"></div>
                <div style="flex:1 1 200px;"><label>İş/Referans</label><input id="isJob" placeholder="#JOB-001"></div>
              </div>
              <label>Şərh</label><textarea id="isNote" placeholder="Səbəb/işçi"></textarea>
              <div class="row" style="justify-content:space-between;margin-top:8px;">
                <div class="tiny">Silmə xərci = cari orta qiymət × kq</div>
                <button class="primary" onclick="addIssue()">Silmə əlavə et</button>
              </div>
            </div>
            <div class="card">
              <div class="section-title">Son silmələr</div>
              <table>
                <thead><tr><th>Tarix</th><th>Kod</th><th>Material</th><th class="right">kq</th><th class="right">Orta qiymət</th><th class="right">Məbləğ</th><th>İş</th><th>Şərh</th></tr></thead>
                <tbody>${items}</tbody>
              </table>
            </div>
          </div>`;
      }

      async function addIssue() {
        const material_id = $("#isMat").value;
        const qty = Number($("#isQty").value);
        const date = $("#isDate").value || today();
        const job_ref = $("#isJob").value.trim();
        const note = $("#isNote").value.trim();
        if (!material_id || qty <= 0) { alert("Material və miqdar (>0) vacibdir"); return; }
        try {
          await apiPOST("/api/issues", { date, material_id, qty_kg: qty, job_ref, note });
          await fetchIssues();
          await fetchStock();
        } catch (e) {}
      }

      // --- STOCK ---
      function renderStock() {
        const rows = (APP.stock || []).map(r => {
          const code = r.code || (r.mat && r.mat.code) || "";
          const name = r.name || (r.mat && r.mat.name) || "";
          const onHand = r.onHand ?? r.qty ?? 0;
          const avg = r.avg ?? r.avg_cost ?? 0;
          const inv = r.inv ?? r.inv_value ?? (onHand * avg);
          const health = onHand <= (r.min_level || 0) ? "warn" : "ok";
          return `<tr>
            <td>${code}</td>
            <td>${name}</td>
            <td class="right">${fmtN(onHand, 3)}</td>
            <td class="right">${fmtMoney(avg)}</td>
            <td class="right">${fmtMoney(inv)}</td>
            <td><span class="badge ${health}">${health === "ok" ? "OK" : "LOW"}</span></td>
          </tr>`;
        }).join("") || '<tr><td colspan="6" class="tiny">Нет данных по складу</td></tr>';

        $("#view").innerHTML = `
          <div class="card">
            <div class="section-title">Anbar qalıqları (kq)</div>
            <table>
              <thead><tr><th>Kod</th><th>Material</th><th class="right">Varlıqdakı (kq)</th><th class="right">Orta qiymət (₼/kq)</th><th class="right">İnventar dəyəri</th><th>Stat</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      }

      // --- FINANCE ---
      function renderFinance() {
        const list = (APP.finances || []).slice().sort((a,b)=> (a.date||"").localeCompare(b.date||"")).map(f => `<tr><td>${f.date}</td><td>${f.type === "income" ? "Gəlir" : "Xərc"}</td><td>${f.category||""}</td><td>${f.counterparty||""}</td><td class="right">${fmtMoney(f.amount_azn||0)}</td><td class="tiny">${f.note||""}</td></tr>`).join("") || '<tr><td colspan="6" class="tiny">Нет записей</td></tr>';
        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Gəlir / Xərc</div>
              <div class="row wrap">
                <div style="flex:1 1 140px;"><label>Tip</label><select id="fnType"><option value="income">Gəlir</option><option value="expense">Xərc</option></select></div>
                <div style="flex:2 1 220px;"><label>Kateqoriya</label><input id="fnCat" placeholder="Kira, logistika, satış..."></div>
                <div style="flex:1 1 150px;"><label>Məbləğ (₼)</label><input id="fnAmt" type="number" step="0.01"></div>
                <div style="flex:1 1 160px;"><label>Tarix</label><input id="fnDate" type="date" value="${today()}"></div>
                <div style="flex:2 1 220px;"><label>Kontragent</label><input id="fnCp" placeholder="MMC və ya şəxsin adı"></div>
              </div>
              <label>Qeyd</label><textarea id="fnNote"></textarea>
              <div class="row" style="justify-content:flex-end;margin-top:8px;"><button class="primary" onclick="addFinance()">Əlavə et</button></div>
            </div>
            <div class="card">
              <div class="section-title">Qeydlər</div>
              <table>
                <thead><tr><th>Tarix</th><th>Tip</th><th>Kateqoriya</th><th>Kontragent</th><th class="right">Məbləğ</th><th>Qeyd</th></tr></thead>
                <tbody>${list}</tbody>
              </table>
            </div>
          </div>`;
      }

      async function addFinance() {
        const type = $("#fnType").value;
        const category = $("#fnCat").value.trim();
        const amount = Number($("#fnAmt").value);
        const date = $("#fnDate").value || today();
        const counterparty = $("#fnCp").value.trim();
        const note = $("#fnNote").value.trim();
        if (!category || amount < 0) { alert("Kateqoriya və məbləğ daxil edin"); return; }
        try {
          await apiPOST("/api/finances", { date, type, category, amount_azn: amount, counterparty, note });
          await fetchFinances();
          await fetchPL();
        } catch (e) {}
      }

      // --- AR / AP ---
      function arRemaining(entry) {
        const paid = (entry.payments || []).reduce((a,b) => a + Number(b.amount_azn || 0), 0);
        return (entry.amount_azn || 0) - paid;
      }
      function apRemaining(entry) { return arRemaining(entry); }

      function renderARAP() {
        const arRows = (APP.ar || []).slice().sort((a,b)=> (a.date||"").localeCompare(b.date||"")).map(e => `<tr>
          <td>${e.date}</td><td>${e.counterparty||""}</td><td class="right">${fmtMoney(e.amount_azn||0)}</td>
          <td class="right">${fmtMoney(arRemaining(e))}</td>
          <td>${e.status||""}</td>
          <td class="right"><button class="ghost" onclick="addARPayPrompt('${e.id}')">Ödəniş</button></td>
        </tr>`).join("") || '<tr><td colspan="6" class="tiny">Нет должников</td></tr>';

        const apRows = (APP.ap || []).slice().sort((a,b)=> (a.date||"").localeCompare(b.date||"")).map(e => `<tr>
          <td>${e.date}</td><td>${e.counterparty||""}</td><td class="right">${fmtMoney(e.amount_azn||0)}</td>
          <td class="right">${fmtMoney(apRemaining(e))}</td>
          <td>${e.status||""}</td>
          <td class="right"><button class="ghost" onclick="addAPPayPrompt('${e.id}')">Ödəniş</button></td>
        </tr>`).join("") || '<tr><td colspan="6" class="tiny">Нет кредиторов</td></tr>';

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Debitorlar (AR)</div>
              <div class="row wrap">
                <div style="flex:2 1 220px;"><label>Kontragent</label><input id="arCp"></div>
                <div style="flex:1 1 160px;"><label>Tarix</label><input id="arDate" type="date" value="${today()}"></div>
                <div style="flex:1 1 150px;"><label>Məbləğ (₼)</label><input id="arAmt" type="number" step="0.01"></div>
                <div style="flex:1 1 160px;"><label>Status</label><select id="arStatus"><option>open</option><option>partial</option><option>closed</option></select></div>
              </div>
              <label>Qeyd</label><textarea id="arNote"></textarea>
              <div class="row" style="justify-content:flex-end;margin-top:8px;"><button class="primary" onclick="addAR()">Əlavə et</button></div>
              <div class="divider"></div>
              <table>
                <thead><tr><th>Tarix</th><th>Kontragent</th><th class="right">Məbləğ</th><th class="right">Qalıq</th><th>Status</th><th class="right">Əməliyyat</th></tr></thead>
                <tbody>${arRows}</tbody>
              </table>
            </div>

            <div class="card">
              <div class="section-title">Kreditorlar (AP)</div>
              <div class="row wrap">
                <div style="flex:2 1 220px;"><label>Kontragent</label><input id="apCp"></div>
                <div style="flex:1 1 160px;"><label>Tarix</label><input id="apDate" type="date" value="${today()}"></div>
                <div style="flex:1 1 150px;"><label>Məbləğ (₼)</label><input id="apAmt" type="number" step="0.01"></div>
                <div style="flex:1 1 160px;"><label>Status</label><select id="apStatus"><option>open</option><option>partial</option><option>closed</option></select></div>
              </div>
              <label>Qeyd</label><textarea id="apNote"></textarea>
              <div class="row" style="justify-content:flex-end;margin-top:8px;"><button class="primary" onclick="addAP()">Əlavə et</button></div>
              <div class="divider"></div>
              <table>
                <thead><tr><th>Tarix</th><th>Kontragent</th><th class="right">Məbləğ</th><th class="right">Qalıq</th><th>Status</th><th class="right">Əməliyyat</th></tr></thead>
                <tbody>${apRows}</tbody>
              </table>
            </div>
          </div>`;
      }

      async function addAR() {
        const counterparty = $("#arCp").value.trim();
        const date = $("#arDate").value || today();
        const amount = Number($("#arAmt").value);
        const status = $("#arStatus").value;
        const note = $("#arNote").value.trim();
        if (!counterparty || amount <= 0) { alert("Kontragent və məbləğ (>0) vacibdir"); return; }
        try {
          await apiPOST("/api/ar", { counterparty, date, amount_azn: amount, status, payments: [], note });
          await fetchARAP();
        } catch (e) {}
      }
      async function addAP() {
        const counterparty = $("#apCp").value.trim();
        const date = $("#apDate").value || today();
        const amount = Number($("#apAmt").value);
        const status = $("#apStatus").value;
        const note = $("#apNote").value.trim();
        if (!counterparty || amount <= 0) { alert("Kontragent və məbləğ (>0) vacibdir"); return; }
        try {
          await apiPOST("/api/ap", { counterparty, date, amount_azn: amount, status, payments: [], note });
          await fetchARAP();
        } catch (e) {}
      }

      async function addARPayPrompt(id) {
        const e = APP.ar.find(x => x.id === id);
        if (!e) return;
        const amt = prompt("Ödəniş məbləği (₼)");
        if (amt === null) return;
        const a = Number(amt);
        if (!(a > 0)) return alert("Yanlış məbləğ");
        try {
          await apiPOST(`/api/ar/${id}/payment`, { date: today(), amount_azn: a });
          await fetchARAP();
        } catch (e) {}
      }
      async function addAPPayPrompt(id) {
        const e = APP.ap.find(x => x.id === id);
        if (!e) return;
        const amt = prompt("Ödəniş məbləği (₼)");
        if (amt === null) return;
        const a = Number(amt);
        if (!(a > 0)) return alert("Yanlış məbləğ");
        try {
          await apiPOST(`/api/ap/${id}/payment`, { date: today(), amount_azn: a });
          await fetchARAP();
        } catch (e) {}
      }

      // --- REPORTS ---
      function renderReports() {
        const from = today().slice(0, 7) + "-01";
        const to = today();
        const p = APP.pl || {};
        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">P&L üzrə</div>
              <div class="row wrap">
                <div style="flex:1 1 160px;"><label>Başlanğıc</label><input id="rpFrom" type="date" value="${from}"></div>
                <div style="flex:1 1 160px;"><label>Son</label><input id="rpTo" type="date" value="${to}"></div>
                <div style="align-self:flex-end;"><button class="primary" onclick="fetchPL()">Göstər</button></div>
              </div>
              <div id="plBox" style="margin-top:8px;">
                <table>
                  <tbody>
                    <tr><td>Gəlir</td><td class="right">${fmtMoney(p.revenue || 0)}</td></tr>
                    <tr><td>COGS</td><td class="right">${fmtMoney(p.cogs || 0)}</td></tr>
                    <tr><th>Brüt</th><th class="right">${fmtMoney(p.gross || ( (p.revenue||0)-(p.cogs||0) ))}</th></tr>
                    <tr><td>Xərclər</td><td class="right">${fmtMoney(p.expenses || 0)}</td></tr>
                    <tr><th>Net</th><th class="right">${fmtMoney(p.net || ((p.revenue||0)-(p.cogs||0)-(p.expenses||0)))}</th></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="card">
              <div class="section-title">Material hərəkətləri (ümumi)</div>
              <div id="mvBox"></div>
            </div>
          </div>`;
        renderMovement();
      }

      function renderMovement() {
        const rows = (APP.materials || []).map(mat => {
          const inQty = (APP.receipts || []).filter(r => r.material_id === mat.id).reduce((a,b)=>a+Number(b.qty_kg||0),0);
          const inSum = (APP.receipts || []).filter(r => r.material_id === mat.id).reduce((a,b)=>a+Number(b.total_cost||0),0);
          const outQty = (APP.issues || []).filter(i => i.material_id === mat.id).reduce((a,b)=>a+Number(b.qty_kg||0),0);
          const outSum = (APP.issues || []).filter(i => i.material_id === mat.id).reduce((a,b)=>a+Number(b.total_cost_used||0),0);
          return `<tr><td>${mat.code}</td><td>${mat.name}</td><td class="right">${fmtN(inQty,3)}</td><td class="right">${fmtMoney(inSum)}</td><td class="right">${fmtN(outQty,3)}</td><td class="right">${fmtMoney(outSum)}</td></tr>`;
        }).join("") || '<tr><td colspan="6" class="tiny">Heç bir məlumat yoxdur</td></tr>';
        $("#mvBox").innerHTML = `<table><thead><tr><th>Kod</th><th>Material</th><th class="right">Giriş (kq)</th><th class="right">Giriş (₼)</th><th class="right">Çıxış (kq)</th><th class="right">Çıxış (₼)</th></tr></thead><tbody>${rows}</tbody></table>`;
      }

      // --- SETTINGS ---
      function renderSettings() {
        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Sistem</div>
              <div class="tiny">Server: <b>${BASE}</b></div>
              <div style="margin-top:8px" class="tiny">Bu tətbiq bütün əməliyyatları serverə yönləndirir. Server 500 (Internal) və ya CORS xətası verərsə, konsolda (F12) tam məlumatı görə bilərsən.</div>
            </div>
            <div class="card">
              <div class="section-title">Qeydlər</div>
              <div class="tiny">Bu frontend localStorage istifadə etmir — bütün məlumat serverdə saxlanılır. Əgər server auth tələb edirsə, API_HEADERS içərisində Authorization başlığı əlavə et.</div>
            </div>
          </div>`;
      }

      // ====== İNİT ======
      function renderView() {
        if (currentTab === "materials") renderMaterials();
        else if (currentTab === "receipt") renderReceipt();
        else if (currentTab === "issue") renderIssue();
        else if (currentTab === "stock") renderStock();
        else if (currentTab === "finance") renderFinance();
        else if (currentTab === "arap") renderARAP();
        else if (currentTab === "reports") renderReports();
        else if (currentTab === "settings") renderSettings();
      }

      async function refreshAll() {
        try {
          await Promise.allSettled([
            fetchMaterials(), fetchReceipts(), fetchIssues(), fetchStock(), fetchFinances(), fetchARAP(), fetchPL()
          ]);
        } catch (e) {
          console.warn("refreshAll error", e);
        }
        renderTabs();
        renderView();
      }

      // start
      document.addEventListener("DOMContentLoaded", async () => {
        $("#baseUrl").textContent = BASE;
        renderTabs();
        renderView();
        await refreshAll();
      });

    </script>
  </body>
</html>
