<!DOCTYPE html>
<html lang="az">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Material anbarı (kq) • Maliyyə (Gəlir/Xərc, AR/AP) — AZN</title>
    <style>
      :root {
        --bg: #0b1020;
        --card: #0f172a;
        --text: #e5e7eb;
        --muted: #94a3b8;
        --border: #27324a;
        --pill: #0b1220;
        --accent: #38bdf8;
        --ok: #22c55e;
        --warn: #f59e0b;
        --bad: #ef4444;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      }
      .app {
        max-width: 1260px;
        margin: 0 auto;
        padding: 20px;
      }
      h1 {
        margin: 0 0 8px;
        font-size: 22px;
      }
      .sub {
        color: var(--muted);
        font-size: 12px;
      }
      .tabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin: 12px 0 16px;
      }
      .tab {
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #0b1220;
        color: #cbd5e1;
        font-weight: 600;
        cursor: pointer;
      }
      .tab.active {
        background: linear-gradient(135deg, #2563eb, #06b6d4);
        color: #fff;
        border: none;
      }
      .grid {
        display: grid;
        gap: 12px;
      }
      .cols-2 {
        grid-template-columns: repeat(2, 1fr);
      }
      .cols-3 {
        grid-template-columns: repeat(3, 1fr);
      }
      .cols-4 {
        grid-template-columns: repeat(4, 1fr);
      }
      @media (max-width: 1024px) {
        .cols-4 {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (max-width: 720px) {
        .cols-4,
        .cols-3,
        .cols-2 {
          grid-template-columns: 1fr;
        }
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 14px;
      }
      .kpi {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .kpi .val {
        font-size: 22px;
        font-weight: 800;
      }
      .muted {
        color: var(--muted);
      }
      .tiny {
        font-size: 11px;
        color: var(--muted);
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .row.wrap {
        flex-wrap: wrap;
      }
      label {
        font-size: 12px;
        color: var(--muted);
        display: block;
        margin-bottom: 6px;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #0b1220;
        color: var(--text);
      }
      textarea {
        min-height: 72px;
      }
      button {
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #0b1220;
        color: var(--text);
        cursor: pointer;
      }
      button.primary {
        background: linear-gradient(135deg, #2563eb, #06b6d4);
        border: none;
        color: #fff;
      }
      button.ghost {
        background: transparent;
      }
      .danger {
        color: #fecaca;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        text-align: left;
        padding: 10px;
        border-bottom: 1px dashed var(--border);
        font-size: 14px;
      }
      th {
        color: var(--muted);
        font-weight: 700;
      }
      .right {
        text-align: right;
      }
      .badge {
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--pill);
        font-size: 12px;
      }
      .badge.ok {
        color: var(--ok);
        border-color: #22c55e30;
        background: #22c55e10;
      }
      .badge.warn {
        color: var(--warn);
        border-color: #f59e0b30;
        background: #f59e0b10;
      }
      .badge.bad {
        color: var(--bad);
        border-color: #ef444430;
        background: #ef444410;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .pill {
        border: 1px solid var(--border);
        background: var(--pill);
        border-radius: 999px;
        padding: 6px 10px;
        display: inline-flex;
        gap: 8px;
        align-items: center;
      }
      .divider {
        height: 1px;
        background: var(--border);
        margin: 12px 0;
      }
      .foot {
        margin-top: 12px;
        color: var(--muted);
        font-size: 12px;
      }
      .section-title {
        font-size: 16px;
        font-weight: 800;
        margin-bottom: 10px;
      }
      .loader {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 2px solid #ffffff25;
        border-top-color: #06b6d4;
        animation: spin 1s linear infinite;
        display: inline-block;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
    </style>
  </head>
  <body>
    <div class="app">
      <h1>Material anbarı (kq) + Maliyyə (AR/AP) + Məhsul İdarəetmə</h1>
      <div class="sub">
        Valyuta: <b>AZN (₼)</b> • Ölçü vahidi: <b>kq</b> • Backend API: <b id="baseUrl">http://116.203.51.133:8085/stock</b>
      </div>

      <!-- KPI -->
      <div class="grid cols-4" style="margin-top: 12px">
        <div class="card kpi">
          <div>
            <div class="muted">Material qalığı</div>
            <div class="val" id="kpiOnHandKg">0</div>
          </div>
          <span class="badge">kq</span>
        </div>
        <div class="card kpi">
          <div>
            <div class="muted">İnventar dəyəri</div>
            <div class="val" id="kpiInvValue">₼ 0</div>
          </div>
          <span class="badge">AZN</span>
        </div>
        <div class="card kpi">
          <div>
            <div class="muted">Dövür üzrə gəlir</div>
            <div class="val" id="kpiRevenue">₼ 0</div>
          </div>
          <span class="badge">AZN</span>
        </div>
        <div class="card kpi">
          <div>
            <div class="muted">Dövür üzrə xalis mənfəət</div>
            <div class="val" id="kpiNet">₼ 0</div>
          </div>
          <span class="badge ok" id="kpiNetBadge">OK</span>
        </div>
      </div>

      <div class="tabs" id="tabs"></div>
      <div id="view"></div>

      <div class="foot">
        Məsləhət: əvvəlcə material/məhsul kataloqunu əlavə edin, sonra müvafiq əməliyyatları yerinə yetirin.
      </div>
    </div>

    <script>
      // ====== KONFİGURASİYA ======
      const BASE = "http://116.203.51.133:8085/stock";
      const API_HEADERS = {
        "Content-Type": "application/json",
      };

      // helperlər
      const $ = s => document.querySelector(s);
      const fmtN = (n, d = 2) =>
        (n ?? 0).toLocaleString(undefined, { maximumFractionDigits: d });
      const fmtMoney = n => `₼ ${fmtN(n, 2)}`;
      const today = () => new Date().toISOString().slice(0, 10);

      // TABS
      const TABS = [
        { id: "materials", name: "Materiallar" },
        { id: "receipt", name: "Qəbul" },
        { id: "issue", name: "Silmə" },
        { id: "stock", name: "Anbar" },
        { id: "products", name: "Məhsullar" },
        { id: "warehouse", name: "Anbar Stoku" },
        { id: "transfer", name: "Mağazaya Transfer" },
        { id: "store", name: "Mağaza Stoku" },
        { id: "sales", name: "Satışlar" },
        { id: "finance", name: "Maliyyə (Gəlir/Xərc)" },
        { id: "arap", name: "Debitor/Kreditor (AR/AP)" },
        { id: "reports", name: "Hesabatlar" },
      ];
      let currentTab = "materials";

      // APP STATE
      const APP = {
        materials: [],
        receipts: [],
        issues: [],
        stock: [],
        finances: [],
        ar: [],
        ap: [],
        kpi: null,
        products: [],
        warehouseStock: [],
        storeStock: [],
        transfers: [],
        sales: [],
        adjustments: []
      };

      // render tabs
      function renderTabs() {
        $("#tabs").innerHTML = TABS.map(
          (t) =>
            `<button class="tab ${currentTab === t.id ? "active" : ""}" onclick="switchTab('${t.id}')">${t.name}</button>`
        ).join("");
      }
      
      function switchTab(id) {
        currentTab = id;
        renderTabs();
        renderView();
        // avtomatik fetch
        if (id === "materials") fetchMaterials();
        else if (id === "receipt") { fetchMaterials(); fetchReceipts(); }
        else if (id === "issue") { fetchMaterials(); fetchIssues(); }
        else if (id === "stock") fetchStock();
        else if (id === "products") fetchProducts();
        else if (id === "warehouse") { fetchProducts(); fetchWarehouseStock(); fetchAdjustments(); }
        else if (id === "transfer") { fetchProducts(); fetchWarehouseStock(); fetchTransfers(); }
        else if (id === "store") { fetchProducts(); fetchStoreStock(); }
        else if (id === "sales") { fetchProducts(); fetchStoreStock(); fetchSales(); }
        else if (id === "finance") fetchFinances();
        else if (id === "arap") fetchARAP();
        else if (id === "reports") { fetchMaterials(); fetchReceipts(); fetchIssues(); fetchPL(); }
      }

      // ====== API helpers ======
      async function apiGET(path) {
        try {
          const res = await fetch(BASE + path, { method: "GET", headers: API_HEADERS });
          if (!res.ok) {
            const text = await res.text().catch(()=>"");
            throw new Error(`HTTP ${res.status}: ${text}`);
          }
          return await res.json();
        } catch (e) {
          console.error("GET", path, e);
          alert(`Server xətası GET ${path}\n${e.message}`);
          throw e;
        }
      }
      
      async function apiPOST(path, body) {
        try {
          const res = await fetch(BASE + path, {
            method: "POST",
            headers: API_HEADERS,
            body: JSON.stringify(body),
          });
          if (!res.ok) {
            const text = await res.text().catch(()=>"");
            throw new Error(`HTTP ${res.status}: ${text}`);
          }
          return await res.json();
        } catch (e) {
          console.error("POST", path, e);
          alert(`Server xətası POST ${path}\n${e.message}`);
          throw e;
        }
      }
      
      async function apiPUT(path, body) {
        try {
          const res = await fetch(BASE + path, {
            method: "PUT",
            headers: API_HEADERS,
            body: JSON.stringify(body),
          });
          if (!res.ok) {
            const text = await res.text().catch(()=>"");
            throw new Error(`HTTP ${res.status}: ${text}`);
          }
          return await res.json();
        } catch (e) {
          console.error("PUT", path, e);
          alert(`Server xətası PUT ${path}\n${e.message}`);
          throw e;
        }
      }

      async function apiPATCH(path) {
        try {
          const res = await fetch(BASE + path, {
            method: "PATCH",
            headers: API_HEADERS,
          });
          if (!res.ok) {
            const text = await res.text().catch(()=>"");
            throw new Error(`HTTP ${res.status}: ${text}`);
          }
          return res.status === 204 ? {} : await res.json();
        } catch (e) {
          console.error("PATCH", path, e);
          alert(`Server xətası PATCH ${path}\n${e.message}`);
          throw e;
        }
      }

      // ====== FETCH data from server ======
      async function fetchMaterials() {
        try {
          APP.materials = await apiGET("/api/materials");
          if (currentTab === "materials") renderMaterials();
        } catch (e) {}
      }
      
      async function fetchReceipts() {
        try {
          APP.receipts = await apiGET("/api/receipts");
          if (currentTab === "receipt") renderReceipt();
        } catch (e) {}
      }
      
      async function fetchIssues() {
        try {
          APP.issues = await apiGET("/api/issues");
          if (currentTab === "issue") renderIssue();
        } catch (e) {}
      }
      
      async function fetchStock() {
        try {
          APP.stock = await apiGET("/api/stock/snapshot");
          const from = today().slice(0, 7) + "-01";
          const to = today();
          APP.kpi = await apiGET(`/api/stock/kpi?from=${from}&to=${to}`);
          renderStock();
          updateKPIBox();
        } catch (e) {}
      }

      async function fetchProducts() {
        try {
          APP.products = await apiGET("/api/products");
          if (currentTab === "products") renderProducts();
        } catch (e) {}
      }

      async function fetchWarehouseStock() {
        try {
          APP.warehouseStock = await apiGET("/api/warehouse-stock");
          if (currentTab === "warehouse") renderWarehouse();
        } catch (e) {}
      }

      async function fetchAdjustments() {
        try {
          APP.adjustments = await apiGET("/api/warehouse-stock/adjustments");
          if (currentTab === "warehouse") renderWarehouse();
        } catch (e) {}
      }

      async function fetchStoreStock() {
        try {
          APP.storeStock = await apiGET("/api/store-stock");
          if (currentTab === "store") renderStore();
        } catch (e) {}
      }

      async function fetchTransfers() {
        try {
          APP.transfers = await apiGET("/api/store-transfers");
          if (currentTab === "transfer") renderTransfer();
        } catch (e) {}
      }

      async function fetchSales() {
        try {
          APP.sales = await apiGET("/api/store-sales");
          if (currentTab === "sales") renderSales();
        } catch (e) {}
      }
      
      async function fetchFinances() {
        try {
          APP.finances = await apiGET("/api/finances");
          renderFinance();
        } catch (e) {}
      }
      
      async function fetchARAP() {
        try {
          APP.ar = await apiGET("/api/ar");
          APP.ap = await apiGET("/api/ap");
          renderARAP();
        } catch (e) {}
      }
      
      async function fetchPL() {
        try {
          const from = $("#rpFrom") ? $("#rpFrom").value : today().slice(0, 7) + "-01";
          const to = $("#rpTo") ? $("#rpTo").value : today();
          APP.pl = await apiGET(`/api/stock/profit-loss?from=${from}&to=${to}`);
          APP.kpi = await apiGET(`/api/stock/kpi?from=${from}&to=${to}`);
          APP.movements = await apiGET("/api/stock/movements");
          renderReports();
          updateKPIBox();
        } catch (e) {}
      }

      // ====== RENDER / UI funksiyaları ======
      function updateKPIBox() {
        let onHandKg = 0, inv = 0;
        
        if (Array.isArray(APP.stock) && APP.stock.length) {
          APP.stock.forEach(s => { 
            onHandKg += Number(s.onHandKg || 0); 
            inv += Number(s.inventoryValue || 0); 
          });
        }
        
        $("#kpiOnHandKg").textContent = fmtN(onHandKg, 3);
        $("#kpiInvValue").textContent = fmtMoney(inv);
        
        if (APP.kpi) {
          $("#kpiRevenue").textContent = fmtMoney(APP.kpi.revenue || 0);
          $("#kpiNet").textContent = fmtMoney(APP.kpi.netProfit || 0);
          const badge = $("#kpiNetBadge");
          if ((APP.kpi.netProfit || 0) >= 0) { 
            badge.textContent = "OK"; 
            badge.className = "badge ok"; 
          } else { 
            badge.textContent = "NEG"; 
            badge.className = "badge bad"; 
          }
        }
      }

      // --- MATERIALS ---
      function renderMaterials() {
        const list = APP.materials.map(x => `
          <tr>
            <td>${x.code || ""}</td>
            <td>${x.name || ""}</td>
            <td>kq</td>
            <td class="right">${fmtN(x.minLevel ?? 0, 3)}</td>
            <td>${x.isActive === false ? '<span class="badge warn">arxiv</span>' : '<span class="badge ok">aktiv</span>'}</td>
            <td class="right"><button class="ghost" onclick="toggleMat('${x.id}')">${x.isActive === false ? "Arxivdən çıxar" : "Arxivlə"}</button></td>
          </tr>`).join("") || '<tr><td colspan="6" class="tiny">Material yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Material bələdçisi</div>
              <div class="row wrap">
                <div style="flex:1 1 150px;"><label>Kod</label><input id="mCode" placeholder="MTL-001"></div>
                <div style="flex:2 1 260px;"><label>Ad</label><input id="mName" placeholder="Poliamid qranul"></div>
                <div style="flex:1 1 120px;"><label>Minimum qalıq (kq)</label><input id="mMin" type="number" step="0.001" value="0"></div>
              </div>
              <div class="row" style="justify-content:flex-end;margin-top:8px;">
                <button class="primary" onclick="addMaterial()">Material əlavə et</button>
              </div>
            </div>
            <div class="card">
              <div class="section-title">Materiallar</div>
              <table>
                <thead><tr><th>Kod</th><th>Ad</th><th>Vahid</th><th class="right">Minimum qalıq</th><th>Status</th><th class="right">Əməliyyatlar</th></tr></thead>
                <tbody>${list}</tbody>
              </table>
            </div>
          </div>`;
      }

      async function addMaterial() {
        const code = $("#mCode").value.trim();
        const name = $("#mName").value.trim();
        const min = Number($("#mMin").value || 0);
        if (!code || !name) { alert("Kod və adı daxil edin"); return; }
        try {
          await apiPOST("/api/materials", { 
            code, 
            name, 
            uom: "kg", 
            minLevel: min, 
            isActive: true 
          });
          await fetchMaterials();
          $("#mCode").value = ""; 
          $("#mName").value = ""; 
          $("#mMin").value = "0";
        } catch (e) {}
      }

      async function toggleMat(id) {
        try {
          await apiPATCH(`/api/materials/${id}/toggle`);
          await fetchMaterials();
        } catch (e) {}
      }

      // --- RECEIPTS ---
      function renderReceipt() {
        const options = APP.materials.filter(x => x.isActive !== false)
          .map(x => `<option value="${x.id}">${x.code} — ${x.name}</option>`).join("");
          
        const items = APP.receipts.slice().sort((a,b)=> (a.date||"").localeCompare(b.date||""))
          .map(r => {
            const mat = APP.materials.find(m => m.id === r.materialId) || {};
            return `<tr>
              <td>${r.date}</td>
              <td>${mat.code || ""}</td>
              <td>${mat.name || ""}</td>
              <td class="right">${fmtN(r.qtyKg, 3)}</td>
              <td class="right">${fmtMoney(r.pricePerKg)}</td>
              <td class="right">${fmtMoney(r.totalCost)}</td>
              <td>${r.supplier || ""}</td>
              <td class="tiny">${r.note || ""}</td>
            </tr>`;
          }).join("") || '<tr><td colspan="8" class="tiny">Qəbul yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Material qəbulu</div>
              <div class="row wrap">
                <div style="flex:2 1 260px;"><label>Material</label><select id="rcMat">${options}</select></div>
                <div style="flex:1 1 120px;"><label>Miqdar (kq)</label><input id="rcQty" type="number" step="0.001"></div>
                <div style="flex:1 1 140px;"><label>1 kq üçün qiymət (₼)</label><input id="rcPrice" type="number" step="0.01"></div>
                <div style="flex:1 1 160px;"><label>Tarix</label><input id="rcDate" type="date" value="${today()}"></div>
                <div style="flex:1 1 200px;"><label>Təchizatçı</label><input id="rcSupplier" placeholder="MMC Təchizatçı"></div>
              </div>
              <label>Şərh</label><textarea id="rcNote" placeholder="Partiya/qaimə"></textarea>
              <div class="row" style="justify-content:space-between;margin-top:8px;">
                <div class="tiny">Cəm = kq × qiymət/kq</div>
                <button class="primary" onclick="addReceipt()">Qəbulu əlavə et</button>
              </div>
            </div>
            <div class="card">
              <div class="section-title">Son qəbullar</div>
              <table>
                <thead><tr><th>Tarix</th><th>Kod</th><th>Material</th><th class="right">kq</th><th class="right">Qiymət/kq</th><th class="right">Məbləğ</th><th>Təchizatçı</th><th>Şərh</th></tr></thead>
                <tbody>${items}</tbody>
              </table>
            </div>
          </div>`;
      }

      async function addReceipt() {
        const materialId = $("#rcMat").value;
        const qty = Number($("#rcQty").value);
        const price = Number($("#rcPrice").value);
        const date = $("#rcDate").value || today();
        const supplier = $("#rcSupplier").value.trim();
        const note = $("#rcNote").value.trim();
        
        if (!materialId || qty <= 0 || price < 0) { 
          alert("Material, miqdar (>0) və qiymət (>=0) vacibdir"); 
          return; 
        }
        
        try {
          await apiPOST("/api/receipts", { 
            date, 
            materialId, 
            qtyKg: qty, 
            pricePerKg: price, 
            totalCost: qty * price, 
            supplier, 
            note 
          });
          await fetchReceipts();
          await fetchStock();
          $("#rcQty").value = "";
          $("#rcPrice").value = "";
          $("#rcSupplier").value = "";
          $("#rcNote").value = "";
        } catch (e) {}
      }

      // --- ISSUES ---
      function renderIssue() {
        const options = APP.materials.filter(x => x.isActive !== false)
          .map(x => `<option value="${x.id}">${x.code} — ${x.name}</option>`).join("");
          
        const items = APP.issues.slice().sort((a,b)=> (a.date||"").localeCompare(b.date||""))
          .map(i => {
            const mat = APP.materials.find(m => m.id === i.materialId) || {};
            return `<tr>
              <td>${i.date}</td>
              <td>${mat.code || ""}</td>
              <td>${mat.name || ""}</td>
              <td class="right">${fmtN(i.qtyKg, 3)}</td>
              <td class="right">${fmtMoney(i.avgCostUsed)}</td>
              <td class="right">${fmtMoney(i.totalCostUsed)}</td>
              <td>${i.jobRef || ""}</td>
              <td class="tiny">${i.note || ""}</td>
            </tr>`;
          }).join("") || '<tr><td colspan="8" class="tiny">Silmə yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Silmə / İstifadə</div>
              <div class="row wrap">
                <div style="flex:2 1 260px;"><label>Material</label><select id="isMat">${options}</select></div>
                <div style="flex:1 1 120px;"><label>Miqdar (kq)</label><input id="isQty" type="number" step="0.001"></div>
                <div style="flex:1 1 160px;"><label>Tarix</label><input id="isDate" type="date" value="${today()}"></div>
                <div style="flex:1 1 200px;"><label>İş/Referans</label><input id="isJob" placeholder="#JOB-001"></div>
              </div>
              <label>Şərh</label><textarea id="isNote" placeholder="Səbəb/işçi"></textarea>
              <div class="row" style="justify-content:space-between;margin-top:8px;">
                <div class="tiny">Silmə xərci = cari orta qiymət × kq (server hesablayır)</div>
                <button class="primary" onclick="addIssue()">Silmə əlavə et</button>
              </div>
            </div>
            <div class="card">
              <div class="section-title">Son silmələr</div>
              <table>
                <thead><tr><th>Tarix</th><th>Kod</th><th>Material</th><th class="right">kq</th><th>Orta qiymət</th><th class="right">Məbləğ</th><th>İş</th><th>Şərh</th></tr></thead>
                <tbody>${items}</tbody>
              </table>
            </div>
          </div>`;
      }

      async function addIssue() {
        const materialId = $("#isMat").value;
        const qty = Number($("#isQty").value);
        const date = $("#isDate").value || today();
        const jobRef = $("#isJob").value.trim();
        const note = $("#isNote").value.trim();
        
        if (!materialId || qty <= 0) { 
          alert("Material və miqdar (>0) vacibdir"); 
          return; 
        }
        
        try {
          const receipts = APP.receipts.filter(r => r.materialId === materialId);
          const totalQty = receipts.reduce((a,b) => a + Number(b.qtyKg || 0), 0);
          const totalCost = receipts.reduce((a,b) => a + Number(b.totalCost || 0), 0);
          const avgCost = totalQty > 0 ? totalCost / totalQty : 0;
          
          await apiPOST("/api/issues", { 
            date, 
            materialId, 
            qtyKg: qty,
            avgCostUsed: avgCost,
            totalCostUsed: avgCost * qty,
            jobRef, 
            note 
          });
          await fetchIssues();
          await fetchStock();
          $("#isQty").value = "";
          $("#isJob").value = "";
          $("#isNote").value = "";
        } catch (e) {}
      }

      // --- STOCK ---
      function renderStock() {
        const rows = (APP.stock || []).map(r => {
          const health = r.onHandKg <= (r.minLevel || 0) ? "warn" : "ok";
          return `<tr>
            <td>${r.code || ""}</td>
            <td>${r.name || ""}</td>
            <td class="right">${fmtN(r.onHandKg, 3)}</td>
            <td class="right">${fmtMoney(r.avgCostPerKg)}</td>
            <td class="right">${fmtMoney(r.inventoryValue)}</td>
            <td><span class="badge ${health}">${r.status === "low" || health === "warn" ? "LOW" : "OK"}</span></td>
          </tr>`;
        }).join("") || '<tr><td colspan="6" class="tiny">Anbar məlumatı yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="card">
            <div class="section-title">Anbar qalıqları (kq)</div>
            <table>
              <thead><tr><th>Kod</th><th>Material</th><th class="right">Varlıqdakı (kq)</th><th class="right">Orta qiymət (₼/kq)</th><th class="right">İnventar dəyəri</th><th>Status</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      }

      // --- PRODUCTS ---
      function renderProducts() {
        const list = APP.products.map(x => `
          <tr>
            <td>${x.code || ""}</td>
            <td>${x.name || ""}</td>
            <td>${x.category || ""}</td>
            <td class="right">${fmtMoney(x.salePrice)}</td>
            <td class="tiny">${x.description || ""}</td>
          </tr>`).join("") || '<tr><td colspan="5" class="tiny">Məhsul yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Məhsul əlavə et</div>
              <div class="row wrap">
                <div style="flex:1 1 150px;"><label>Kod</label><input id="pCode" placeholder="AYQ-001"></div>
                <div style="flex:2 1 200px;"><label>Ad</label><input id="pName" placeholder="Ayaqqabı Model A"></div>
                <div style="flex:1 1 150px;"><label>Kateqoriya</label><input id="pCat" placeholder="Ayaqqabı"></div>
                <div style="flex:1 1 150px;"><label>Satış qiyməti (₼)</label><input id="pPrice" type="number" step="0.01"></div>
              </div>
              <label>Təsvir</label><textarea id="pDesc"></textarea>
              <div class="row" style="justify-content:flex-end;margin-top:8px;">
                <button class="primary" onclick="addProduct()">Əlavə et</button>
              </div>
            </div>
            <div class="card">
              <div class="section-title">Məhsul siyahısı</div>
              <table>
                <thead><tr><th>Kod</th><th>Ad</th><th>Kateqoriya</th><th class="right">Qiymət</th><th>Təsvir</th></tr></thead>
                <tbody>${list}</tbody>
              </table>
            </div>
          </div>`;
      }

      async function addProduct() {
        const code = $("#pCode").value.trim();
        const name = $("#pName").value.trim();
        const category = $("#pCat").value.trim();
        const price = Number($("#pPrice").value || 0);
        const description = $("#pDesc").value.trim();
        if (!code || !name) { alert("Kod və ad vacibdir"); return; }
        try {
          await apiPOST("/api/products", { code, name, category, salePrice: price, description, isActive: true });
          await fetchProducts();
          $("#pCode").value = "";
          $("#pName").value = "";
          $("#pCat").value = "";
          $("#pPrice").value = "";
          $("#pDesc").value = "";
        } catch (e) {}
      }

      // --- WAREHOUSE ---
      function renderWarehouse() {
        const stockList = APP.warehouseStock.map(s => `
          <tr>
            <td>${s.productCode || ""}</td>
            <td>${s.productName || ""}</td>
            <td>${s.category || ""}</td>
            <td class="right">${fmtN(s.quantity, 0)}</td>
          </tr>`).join("") || '<tr><td colspan="4" class="tiny">Anbar boşdur</td></tr>';

        const adjList = (APP.adjustments || []).slice().reverse().slice(0, 10).map(a => {
          const prod = APP.products.find(p => p.id === a.productId) || {};
          return `<tr>
            <td>${a.date}</td>
            <td>${prod.code || ""}</td>
            <td><span class="badge ${a.type === 'add' ? 'ok' : 'warn'}">${a.type === 'add' ? 'Əlavə' : 'Azalt'}</span></td>
            <td class="right">${fmtN(a.quantity, 0)}</td>
            <td class="tiny">${a.note || ""}</td>
          </tr>`;
        }).join("") || '<tr><td colspan="5" class="tiny">Tarixçə yoxdur</td></tr>';

        const prodOptions = APP.products.filter(p => p.isActive !== false)
          .map(p => `<option value="${p.id}">${p.code} — ${p.name}</option>`).join("");

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Anbara əlavə et / azalt</div>
              <div class="row wrap">
                <div style="flex:2 1 200px;"><label>Məhsul</label><select id="whProd">${prodOptions}</select></div>
                <div style="flex:1 1 120px;"><label>Tip</label><select id="whType"><option value="add">Əlavə et</option><option value="subtract">Azalt</option></select></div>
                <div style="flex:1 1 120px;"><label>Miqdar (ədəd)</label><input id="whQty" type="number" step="1"></div>
                <div style="flex:1 1 160px;"><label>Tarix</label><input id="whDate" type="date" value="${today()}"></div>
              </div>
              <label>Qeyd</label><textarea id="whNote" placeholder="Yeni istehsal, defekt və s."></textarea>
              <div class="row" style="justify-content:flex-end;margin-top:8px;">
                <button class="primary" onclick="adjustWarehouse()">Tətbiq et</button>
              </div>
            </div>
            <div class="card">
              <div class="section-title">Anbar stoku</div>
              <table>
                <thead><tr><th>Kod</th><th>Məhsul</th><th>Kateqoriya</th><th class="right">Miqdar</th></tr></thead>
                <tbody>${stockList}</tbody>
              </table>
              <div class="section-title" style="margin-top:16px;">Son əməliyyatlar</div>
              <table>
                <thead><tr><th>Tarix</th><th>Kod</th><th>Tip</th><th class="right">Miqdar</th><th>Qeyd</th></tr></thead>
                <tbody>${adjList}</tbody>
              </table>
            </div>
          </div>`;
      }

      async function adjustWarehouse() {
        const productId = $("#whProd").value;
        const type = $("#whType").value;
        const quantity = Number($("#whQty").value);
        const date = $("#whDate").value || today();
        const note = $("#whNote").value.trim();
        if (!productId || quantity <= 0) { alert("Məhsul və miqdar (>0) vacibdir"); return; }
        try {
          await apiPOST("/api/warehouse-stock/adjust", { date, productId, type, quantity, note });
          await fetchWarehouseStock();
          await fetchAdjustments();
          $("#whQty").value = "";
          $("#whNote").value = "";
        } catch (e) {}
      }

      // --- TRANSFER ---
      function renderTransfer() {
        const prodOptions = APP.warehouseStock.filter(s => s.quantity > 0)
          .map(s => `<option value="${s.productId}">${s.productCode} — ${s.productName} (${fmtN(s.quantity, 0)} ədəd)</option>`)
          .join("");

        const transList = APP.transfers.slice().reverse().map(t => {
          const prod = APP.products.find(p => p.id === t.productId) || {};
          return `<tr>
            <td>${t.date}</td>
            <td>${prod.code || ""}</td>
            <td>${prod.name || ""}</td>
            <td class="right">${fmtN(t.quantity, 0)}</td>
            <td class="tiny">${t.note || ""}</td>
          </tr>`;
        }).join("") || '<tr><td colspan="5" class="tiny">Transfer yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Mağazaya transfer et</div>
              <div class="row wrap">
                <div style="flex:2 1 200px;"><label>Məhsul</label><select id="trProd">${prodOptions}</select></div>
                <div style="flex:1 1 120px;"><label>Miqdar (ədəd)</label><input id="trQty" type="number" step="1"></div>
                <div style="flex:1 1 160px;"><label>Tarix</label><input id="trDate" type="date" value="${today()}"></div>
              </div>
              <label>Qeyd</label><textarea id="trNote"></textarea>
              <div class="row" style="justify-content:flex-end;margin-top:8px;">
                <button class="primary" onclick="transferToStore()">Mağazaya göndər</button>
              </div>
            </div>
            <div class="card">
              <div class="section-title">Transfer tarixçəsi</div>
              <table>
                <thead><tr><th>Tarix</th><th>Kod</th><th>Məhsul</th><th class="right">Miqdar</th><th>Qeyd</th></tr></thead>
                <tbody>${transList}</tbody>
              </table>
            </div>
          </div>`;
      }

      async function transferToStore() {
        const productId = $("#trProd").value;
        const quantity = Number($("#trQty").value);
        const date = $("#trDate").value || today();
        const note = $("#trNote").value.trim();
        if (!productId || quantity <= 0) { alert("Məhsul və miqdar (>0) vacibdir"); return; }
        try {
          await apiPOST("/api/store-transfers", { date, productId, quantity, note });
          await fetchWarehouseStock();
          await fetchStoreStock();
          await fetchTransfers();
          $("#trQty").value = "";
          $("#trNote").value = "";
        } catch (e) {}
      }

      // --- STORE ---
      function renderStore() {
        const list = APP.storeStock.map(s => `
          <tr>
            <td>${s.productCode || ""}</td>
            <td>${s.productName || ""}</td>
            <td>${s.category || ""}</td>
            <td class="right">${fmtN(s.quantity, 0)}</td>
            <td class="right">${fmtMoney(s.salePrice)}</td>
          </tr>`).join("") || '<tr><td colspan="5" class="tiny">Mağaza boşdur</td></tr>';

        $("#view").innerHTML = `
          <div class="card">
            <div class="section-title">Mağaza stoku</div>
            <table>
              <thead><tr><th>Kod</th><th>Məhsul</th><th>Kateqoriya</th><th class="right">Miqdar</th><th class="right">Satış qiyməti</th></tr></thead>
              <tbody>${list}</tbody>
            </table>
          </div>`;
      }

      // --- SALES ---
      function renderSales() {
        const prodOptions = APP.storeStock.filter(s => s.quantity > 0)
          .map(s => `<option value="${s.productId}" data-price="${s.salePrice}">${s.productCode} — ${s.productName} (${fmtN(s.quantity, 0)} ədəd - ${fmtMoney(s.salePrice)})</option>`)
          .join("");

        const salesList = APP.sales.slice().reverse().map(sale => {
          const prod = APP.products.find(p => p.id === sale.productId) || {};
          return `<tr>
            <td>${sale.date}</td>
            <td>${prod.code || ""}</td>
            <td>${prod.name || ""}</td>
            <td class="right">${fmtN(sale.quantity, 0)}</td>
            <td class="right">${fmtMoney(sale.unitPrice)}</td>
            <td class="right">${fmtMoney(sale.totalAmount)}</td>
            <td>${sale.customer || ""}</td>
            <td class="tiny">${sale.note || ""}</td>
          </tr>`;
        }).join("") || '<tr><td colspan="8" class="tiny">Satış yoxdur</td></tr>';

        $("#view").innerHTML = `
          <div class="grid cols-2">
            <div class="card">
              <div class="section-title">Satış et</div>
              <div class="row wrap">
                <div style="flex:2 1 200px;"><label>Məhsul</label><select id="saleProd" onchange="updateSalePrice()">${prodOptions}</select></div>
                <div style="flex:1 1 100px;"><label>Miqdar</label><input id="saleQty" type="number" step="1"></div>
                <div style="flex:1 1 140px;"><label>Qiymət (₼)</label><input id="salePrice" type="number" step="0.01"></div>
                <div style="flex:1 1 160px;"><label>Tarix</label><input id="saleDate" type="date" value="${today()}"></div>
                <div style="flex:2 1 200px;"><label>Müştəri</label><input id="saleCust" placeholder="Müştəri adı"></div>
              </div>
              <label>Qeyd</label><textarea id="saleNote"></textarea>
              <div class="row" style="justify-content:flex-end;margin-top:8px;">
                <button class="primary" onclick="makeSale()">Satış et</button>
              </div>
            </div>
            <div class="card">
              <div class="section-title">Satış tarixçəsi</div>
              <table>
                <thead><tr><th>Tarix</th><th>Kod</th><th>Məhsul</th><th class="right">Miqdar</th><th class="right">Qiymət</th><th class="right">Məbləğ</th><th>Müştəri</th><th>Qeyd</th></tr></thead>
                <tbody>${salesList}</tbody>
              </table>
            </div>
          </div>`;
        
        updateSalePrice();
      }

      function updateSalePrice() {
        const sel = $("#saleProd");
        if (sel && sel.selectedOptions[0]) {
          const price = sel.selectedOptions[0].getAttribute("data-price");
          if (price) $("#salePrice").value = price;
        }
      }

      async function makeSale() {
        const productId = $("#saleProd").value;
        const quantity = Number($("#saleQty").value);
        const unitPrice = Number($("#salePrice").value);
        const date = $("#saleDate").value || today();
        const customer = $("#saleCust").value.trim();
        const note = $("#saleNote").value.trim();
        if (!productId || quantity <= 0 || unitPrice <= 0) { alert("Məhsul, miqdar və qiymət (>0) vacibdir"); return; }
        try {
          await apiPOST("/api/store-sales", { date, productId, quantity, unitPrice, customer, note });
          await fetchStoreStock();
          await fetchSales();
          $("#saleQty").value = "";
          $("#saleCust").value = "";
          $("#saleNote").value = "";
        } catch (e) {}
      }